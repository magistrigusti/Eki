components/Heroes/ModalHerosGo/ModalHerosGo.tsx
'use client';
import { ArmyTable } from '@/components/Heroes/ArmyTable/ArmyTable';
import styles from './ModalHerosGo.module.css';
import { useState, useEffect } from 'react';
import { Hero } from '@/types/heroes';
import { calculateHeroCapacity } from '@/utils/calculateHeroCapacity';
import { HeroViewer } from '@/components/Heroes/HeroViewer/HeroViewer';
import { HeroSelector } from '@/components/Heroes/HeroSelector/HeroSelector';
import { ARMY_STATS, ArmyUnitType } from '@/config/armyCapacity';

type HeroWithTroops = Hero & {
  troops?: Record<ArmyUnitType, { count: number; level: number }>;
};

interface Props {
  onClose: () => void;
  heroes: HeroWithTroops[];
  selectedResourceNodeId: string;
  onConfirm: (
    heroId: string,
    army: Record<ArmyUnitType, number>
  ) => void;
}

export const ModalHerosGo = ({
  onClose,
  heroes,
  selectedResourceNodeId,
  onConfirm,
}: Props) => {
  const [selectedHero, setSelectedHero] = useState<HeroWithTroops | null>(null);
  const [army, setArmy] = useState<Record<ArmyUnitType, number>>({
    peasant: 0, sailor: 0, axeman: 0, spearman: 0, archer: 0, cavalry: 0,
  });

  useEffect(() => {
    if (heroes.length > 0 && !selectedHero) {
      setSelectedHero(heroes[0]);
    }
  }, [heroes]);

  if (!selectedHero) return null;

  const maxCapacity = calculateHeroCapacity(selectedHero.level, selectedHero.quality);

  const currentCapacity = Object.entries(army).reduce((sum, [unit, count]) => {
    const unitType = unit as ArmyUnitType;
    const unitLevel = selectedHero.troops?.[unitType]?.level || 1;
    const capacityPerUnit = ARMY_STATS[unitType][unitLevel]?.capacity || 0;
    return sum + count * capacityPerUnit;
  }, 0);

  const handleUnitChange = (updated: Record<ArmyUnitType, number>) => {
    setArmy(updated);
  };

  const handleSend = () => {
    if (!selectedHero) return;
    onConfirm(selectedHero.id, army);
  };

  return (
    <div className={styles.modal_overlay}>
      <div className={styles.modal_content}>
        <h2>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –í–æ–π—Å–∫–æ</h2>

        <HeroViewer className={styles.modla_hero_scale} hero={selectedHero} />
        <HeroSelector
          heroes={heroes}
          selectedHero={selectedHero}
          onSelect={setSelectedHero}
        />

        <ArmyTable army={army} onChange={handleUnitChange} />

        <p className={styles.capacity_info}>
          –í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: {currentCapacity} / {maxCapacity}
        </p>

        <div className={styles.actions}>
          <button className={styles.button} onClick={onClose}>–ù–∞–∑–∞–¥</button>
          <button
            className={styles.button}
            onClick={handleSend}
            disabled={currentCapacity <= 0 || currentCapacity > maxCapacity}
          >
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  );
};


ChatGPT —Å–∫–∞–∑–∞–ª:
–ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ —ç—Ç–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ üìÑ components/Heroes/ModalHerosGo/ModalHerosGo.tsx. –≠—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥–µ—Ä–æ—è –∏ –∞—Ä–º–∏—é –Ω–∞ –º–∏—Å—Å–∏—é —á–µ—Ä–µ–∑ onConfirm, –Ω–æ –ù–ï –û–ë–†–ê–ë–ê–¢–´–í–ê–ï–¢ –æ—Ç–º–µ–Ω—É, –ù–ï –ù–ê–ß–ò–°–õ–Ø–ï–¢ —Ä–µ—Å—É—Ä—Å—ã, –ù–ï –í–û–ó–í–†–ê–©–ê–ï–¢ –∞—Ä–º–∏—é.

‚ÄºÔ∏è –í—Å—ë, —á—Ç–æ —Ç—ã –æ–ø–∏—Å–∞–ª, ‚Äî "–≥–µ—Ä–æ–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è, –Ω–æ –∞—Ä–º–∏—è –∏ —Ä–µ—Å—É—Ä—Å—ã –Ω–µ—Ç" ‚Äî –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –æ—Ç–º–µ–Ω—ã –º–∏—Å—Å–∏–∏. –ò—â–∏ —Ñ–∞–π–ª:

–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
üìÑ





–í—ã —Å–∫–∞–∑–∞–ª–∏:
// üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: []
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};


ChatGPT —Å–∫–∞–∑–∞–ª:
–°–ø–∞—Å–∏–±–æ, –Ω–æ —ç—Ç–æ—Ç —Ñ–∞–π–ª üìÑ src/context/UserContext.tsx ‚Äî —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–π state. –û–Ω –ù–ï —Ä–µ—à–∞–µ—Ç —Ç–≤–æ—é –ø—Ä–æ–±–ª–µ–º—É. –ù–∞—Å—Ç–æ—è—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º API, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–æ—Ç–º–µ–Ω–∏—Ç—å" –º–∏—Å—Å–∏—é.

üìå –ß–¢–û –°–ï–ô–ß–ê–° –ü–†–û–ò–°–•–û–î–ò–¢:
–ü–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã –º–∏—Å—Å–∏–∏:

–ì–µ—Ä–æ–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è ‚Äî ‚úÖ

–†–µ—Å—É—Ä—Å—ã –ù–ï –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è ‚Äî ‚ùå

–ê—Ä–º–∏—è –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è ‚Äî ‚ùå

üìç –ì–¥–µ –∏—Å–∫–∞—Ç—å –æ—à–∏–±–∫—É:
–ü—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª:

swift
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
üìÑ src/pages/api/user/update.ts
–∏–ª–∏:

sql
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
üìÑ src/app/api/user/update/route.ts (–µ—Å–ª–∏ App Router)
–¢–∞–º –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:

–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—è activeMining –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ

–†–∞—Å—á—ë—Ç, —Å–∫–æ–ª—å–∫–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–æ–±—ã—Ç–æ (duration, timePassed, speed)

–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ UserModel

–í–æ–∑–≤—Ä–∞—Ç –∞—Ä–º–∏–∏ –∏–∑ Hero.troops –æ–±—Ä–∞—Ç–Ω–æ –≤ user.army

–û—á–∏—Å—Ç–∫–∞ activeMining –∏ hero.troops

‚úÖ –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∏–∫–∏ (–≤–Ω—É—Ç—Ä–∏ PUT /api/user/update):

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
// –û—Ç–º–µ–Ω–∞ –º–∏—Å—Å–∏–∏
if (body.cancelMission) {
  const user = await UserModel.findOne({ address });

  const mining = user.activeMining;
  if (!mining) return NextResponse.json({ error: "No active mining" });

  const now = Date.now();
  const timePassed = Math.min(now - new Date(mining.startedAt).getTime(), mining.duration);
  const collected = Math.floor(mining.remaining * (timePassed / mining.duration));

  // ‚¨áÔ∏è –ù–∞—á–∏—Å–ª—è–µ–º —Ä–µ—Å—É—Ä—Å—ã
  user[mining.resource] += collected;

  // ‚¨áÔ∏è –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∞—Ä–º–∏—é –∏–∑ –≥–µ—Ä–æ—è
  const hero = user.heroes.find(h => h.id === mining.heroId);
  if (hero?.troops) {
    for (const unit in hero.troops) {
      const t = hero.troops[unit];
      if (!user.army[unit]) user.army[unit] = { level: t.level, count: 0 };
      user.army[unit].count += t.count;
    }
    hero.troops = {};
  }

  // ‚¨áÔ∏è –û–±–Ω–æ–≤–ª—è–µ–º remaining –≤ —Ç–æ—á–∫–µ
  const node = user.resourceNodes.find(n => n.position.x === mining.position.x && n.position.y === mining.position.y);
  if (node) node.remaining -= collected;

  // ‚¨áÔ∏è –£–¥–∞–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –º–∏—Å—Å–∏—é
  user.activeMining = null;

  await user.save();
  return NextResponse.json(user);
}
üõ† –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
–ù–∞–π—Ç–∏ API-—Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–º–µ–Ω—É –º–∏—Å—Å–∏–∏

–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ:

—Ä–µ—Å—É—Ä—Å—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è (user[mining.resource] += ...)

–∞—Ä–º–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è (user.army[...] += ...)

–≥–µ—Ä–æ–π –æ—á–∏—â–∞–µ—Ç—Å—è (hero.troops = {})

—Ä–µ—Å—É—Ä—Å–Ω–∞—è —Ç–æ—á–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (node.remaining -= ...)

üîß –ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –ø–æ–∫–∞–∂–∏ üìÑ /api/user/update.ts, —è —Å–∞–º –¥–æ–±–∞–≤–ª—é –ª–æ–≥–∏–∫—É.






–í—ã —Å–∫–∞–∑–∞–ª–∏:
–•–æ—Ä–æ—à–æ. –ù–∞–ø–∏—à–∏ –∫–æ–¥, —á—Ç–æ–±—ã –≥–µ—Ä–æ–∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏—Å—å –∏ –∞—Ä–º–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞—Å—å, —É–±–ª—é–¥–æ–∫. // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const MissionSchema = new mongoose.Schema({
  heroId: { type: String, required: true },
  armyCount: { type: Number, required: true },
  nodeId: { type: String, required: true },
  resource: { 
    type: String, 
    enum: ['food', 'wood', 'stone', 'iron', 'gold', 'doubloon', 'pearl', 'allodium'] 
  },  
  duration: { type: Number, required: true },
  startTime: { type: Number, required: true },
  hero: {
    id: { type: String, required: true },
    name: { type: String, required: true },
    image: { type: String, required: true },
    quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
    level: { type: Number, required: true },
    exp: { type: Number, required: true },
    expToNext: { type: Number, required: true },
  },
  heroArmy: {
    type: Map,
    of: Number,
    default: {}
  },
}, { _id: false });

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 200 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: () => ({
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    }),
  },

  missions: {
    type: [MissionSchema],
    default: [],
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema); // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: []
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};
 
ChatGPT —Å–∫–∞–∑–∞–ª:
‚öîÔ∏è –ì–û–¢–û–í–û. –í–æ—Ç —Ç–æ—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–µ—Ä–æ—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞—Ä–º–∏—é, –Ω–∞—á–∏—Å–ª—è–µ—Ç —Ä–µ—Å—É—Ä—Å—ã, –æ–±–Ω–æ–≤–ª—è–µ—Ç remaining —É —Ç–æ—á–∫–∏, –∏ —É–¥–∞–ª—è–µ—Ç activeMining.

üìÑ –§–ê–ô–õ: src/app/api/user/update/route.ts (–∏–ª–∏ pages/api/user/update.ts ‚Äî —Å–º–æ—Ç—Ä–∏, —á—Ç–æ —É —Ç–µ–±—è —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

üëá –í–°–¢–ê–í–¨ –≠–¢–û –í–ù–£–¢–†–ò PUT-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞, —Ç—É–¥–∞, –≥–¥–µ —Ç—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—à—å cancelMining:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
// üìå –í–Ω—É—Ç—Ä–∏ PUT –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ /api/user/update
if (body.cancelMining && user.activeMining) {
  const mining = user.activeMining;

  const now = Date.now();
  const startTime = new Date(mining.startedAt).getTime();
  const duration = mining.duration;
  const passedTime = Math.min(now - startTime, duration);
  const ratio = passedTime / duration;

  const collected = Math.floor(mining.remaining * ratio);

  // ‚úÖ 1. –ù–∞—á–∏—Å–ª—è–µ–º —Ä–µ—Å—É—Ä—Å—ã
  if (collected > 0 && ['food','wood','stone','iron','gold'].includes(mining.resource)) {
    user[mining.resource] = (user[mining.resource] || 0) + collected;
  }

  // ‚úÖ 2. –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É —Ä–µ—Å—É—Ä—Å–Ω–æ–π —Ç–æ—á–∫–∏
  const targetNode = user.resourceNodes?.find(
    (n) => n.position.x === mining.position.x && n.position.y === mining.position.y
  );
  if (targetNode) {
    targetNode.remaining = Math.max(0, (targetNode.remaining || 0) - collected);
  }

  // ‚úÖ 3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∞—Ä–º–∏—é –∏–∑ –≥–µ—Ä–æ—è
  const hero = user.heroes.find(h => h.id === mining.heroId);
  const mission = user.missions?.find(m => m.heroId === mining.heroId);

  if (hero && mission?.heroArmy) {
    for (const [unitType, count] of mission.heroArmy.entries()) {
      const armyUnit = user.army.get(unitType) || { level: 1, count: 0 };
      armyUnit.count += count;
      user.army.set(unitType, armyUnit);
    }
  }

  // ‚úÖ 4. –£–¥–∞–ª—è–µ–º –º–∏—Å—Å–∏—é
  user.missions = user.missions.filter(m => m.heroId !== mining.heroId);

  // ‚úÖ 5. –£–¥–∞–ª—è–µ–º activeMining
  user.activeMining = null;

  await user.save();
  return NextResponse.json(user);
}
‚òëÔ∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
body.cancelMining === true –¥–æ–ª–∂–µ–Ω –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞

–ú–æ–¥–µ–ª—å user.army ‚Äî —ç—Ç–æ Map (–∫–∞–∫ —É —Ç–µ–±—è), –∏ –≤ –±–∞–∑–µ –æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

–ü–æ–ª–µ heroArmy –≤ missions ‚Äî —ç—Ç–æ Map<string, number>, —á—Ç–æ —Ç–æ–∂–µ —Å–æ–±–ª—é–¥–µ–Ω–æ —É —Ç–µ–±—è –≤ UserModel.ts

üîß –ï—Å–ª–∏ heroArmy –≤ Mission —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –æ–±—ä–µ–∫—Ç, –∑–∞–º–µ–Ω–∏ mission.heroArmy.entries() –Ω–∞:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
Object.entries(mission.heroArmy || {}).forEach(([unitType, count]) => {
  const armyUnit = user.army.get(unitType) || { level: 1, count: 0 };
  armyUnit.count += count;
  user.army.set(unitType, armyUnit);
});
–ï—Å–ª–∏ –ø–æ–∫–∞–∂–µ—à—å —Å–≤–æ–π update.ts ‚Äî —è –≤—Å—Ç–∞–≤–ª—é –≤—Å—ë —Å–∞–º –∏ –æ—Ç–¥–∞–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
// üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const MissionSchema = new mongoose.Schema({
  heroId: { type: String, required: true },
  armyCount: { type: Number, required: true },
  nodeId: { type: String, required: true },
  resource: { 
    type: String, 
    enum: ['food', 'wood', 'stone', 'iron', 'gold', 'doubloon', 'pearl', 'allodium'] 
  },  
  duration: { type: Number, required: true },
  startTime: { type: Number, required: true },
  hero: {
    id: { type: String, required: true },
    name: { type: String, required: true },
    image: { type: String, required: true },
    quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
    level: { type: Number, required: true },
    exp: { type: Number, required: true },
    expToNext: { type: Number, required: true },
  },
  heroArmy: {
    type: Map,
    of: Number,
    default: {}
  },
}, { _id: false });

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 200 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: () => ({
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    }),
  },

  missions: {
    type: [MissionSchema],
    default: [],
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema); // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: []
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};
 
ChatGPT —Å–∫–∞–∑–∞–ª:
–í–æ—Ç –ü–û–õ–ù–´–ô –ì–û–¢–û–í–´–ô –ö–û–î –î–õ–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ü–†–ò –û–¢–ú–ï–ù–ï –ú–ò–°–°–ò–ò.
‚ö†Ô∏è –ú–µ—Å—Ç–æ:
üìÑ src/app/api/user/update/route.ts
(–µ—Å–ª–∏ —É —Ç–µ–±—è —Å—Ç–∞—Ä—ã–π —Ä–æ—É—Ç–∏–Ω–≥ ‚Äî —Ç–æ–≥–¥–∞ üìÑ src/pages/api/user/update.ts)

üî•
–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ü–æ–∫–∞ —Ç—ã –Ω–µ –Ω–∞–ø–∏—à–µ—à—å –≤–æ—Ç —ç—Ç–∏ –¥–≤–∞ —Ñ–∞–π–ª–∞, –≤ –Ω–∏—Ö –≥–µ—Ä–æ–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è, –Ω–æ —Å–µ—Ç-–º–∏—Å—Å–∏–æ–Ω –ø—É—Å—Ç–∞—è, –ø–∏–¥–æ—Ä, –ø–æ–Ω—è–ª? –ò —Å–µ—Ç-—Ö–∏—Ä—É—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è, –Ω–æ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –≥–æ–≤–Ω–æ. –ï–±–∞–ª–æ –∑–∞–≤–∞–ª–∏ –∏ —Å–¥–µ–ª–∞–π —Ç–æ, —á—Ç–æ —Ç–µ–±—è –ø—Ä–æ—Å—è—Ç, –ø–∏–¥—Ä–∏–ª–∞ –∫–æ–Ω—á–µ–Ω–∞—è.  // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const MissionSchema = new mongoose.Schema({
  heroId: { type: String, required: true },
  armyCount: { type: Number, required: true },
  nodeId: { type: String, required: true },
  resource: { 
    type: String, 
    enum: ['food', 'wood', 'stone', 'iron', 'gold', 'doubloon', 'pearl', 'allodium'] 
  },  
  duration: { type: Number, required: true },
  startTime: { type: Number, required: true },
  hero: {
    id: { type: String, required: true },
    name: { type: String, required: true },
    image: { type: String, required: true },
    quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
    level: { type: Number, required: true },
    exp: { type: Number, required: true },
    expToNext: { type: Number, required: true },
  },
  heroArmy: {
    type: Map,
    of: Number,
    default: {}
  },
}, { _id: false });

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 200 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: () => ({
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    }),
  },

  missions: {
    type: [MissionSchema],
    default: [],
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema); // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: []
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};
 
ChatGPT —Å–∫–∞–∑–∞–ª:
–ü–µ—Ä–µ—Å—Ç–∞–ª –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ü–æ–∫–∞ —Ç—ã –Ω–µ –Ω–∞–ø–∏—à–µ—à—å –≤–æ—Ç —ç—Ç–∏ –¥–≤–∞ —Ñ–∞–π–ª–∞, –≤ –Ω–∏—Ö –≥–µ—Ä–æ–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è, –Ω–æ —Å–µ—Ç-–º–∏—Å—Å–∏–æ–Ω –ø—É—Å—Ç–∞—è, –ø–∏–¥–æ—Ä, –ø–æ–Ω—è–ª? –ò —Å–µ—Ç-—Ö–∏—Ä—É—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è, –Ω–æ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –≥–æ–≤–Ω–æ. –ï–±–∞–ª–æ –∑–∞–≤–∞–ª–∏ –∏ —Å–¥–µ–ª–∞–π —Ç–æ, —á—Ç–æ —Ç–µ–±—è –ø—Ä–æ—Å—è—Ç, –ø–∏–¥—Ä–∏–ª–∞ –∫–æ–Ω—á–µ–Ω–∞—è.  // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const MissionSchema = new mongoose.Schema({
  heroId: { type: String, required: true },
  armyCount: { type: Number, required: true },
  nodeId: { type: String, required: true },
  resource: { 
    type: String, 
    enum: ['food', 'wood', 'stone', 'iron', 'gold', 'doubloon', 'pearl', 'allodium'] 
  },  
  duration: { type: Number, required: true },
  startTime: { type: Number, required: true },
  hero: {
    id: { type: String, required: true },
    name: { type: String, required: true },
    image: { type: String, required: true },
    quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
    level: { type: Number, required: true },
    exp: { type: Number, required: true },
    expToNext: { type: Number, required: true },
  },
  heroArmy: {
    type: Map,
    of: Number,
    default: {}
  },
}, { _id: false });

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 200 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: () => ({
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    }),
  },

  missions: {
    type: [MissionSchema],
    default: [],
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema); // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: []
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};
 
ChatGPT —Å–∫–∞–∑–∞–ª:
Update User Data

1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
// üìÑ src/app/api/user/update/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { connectDB } from '@/utils/connectDB';
import { UserModel } from '@/models/UserModel';

export async function PUT(req: NextRequest) {
  await connectDB();

  const body = await req.json();
  const { address, cancelMining } = body;

  const user = await UserModel.findOne({ address });
  if (!user) return NextResponse.json({ error: 'User not found' }, { status: 404 });

  if (cancelMining && user.activeMining) {
    const mining = user.activeMining;
    const now = Date.now();
    const start = new Date(mining.startedAt).getTime();
    const duration = mining.duration;
    const elapsed = Math.min(now - start, duration);
    const ratio = elapsed / duration;
    const collected = Math.floor(mining.remaining * ratio);

    // ‚úÖ 1. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
    if (collected > 0 && ['food','wood','stone','iron','gold'].includes(mining.resource)) {
      user[mining.resource] = (user[mining.resource] || 0) + collected;
    }

    // ‚úÖ 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–Ω–æ–π —Ç–æ—á–∫–∏
    const node = user.resourceNodes.find(n => n.position.x === mining.position.x && n.position.y === mining.position.y);
    if (node) node.remaining = Math.max(0, (node.remaining || 0) - collected);

    // ‚úÖ 3. –í–æ–∑–≤—Ä–∞—Ç –∞—Ä–º–∏–∏ –∏–∑ heroArmy
    const mission = user.missions.find(m => m.heroId === mining.heroId);
    if (mission && mission.heroArmy) {
      for (const [unit, count] of mission.heroArmy.entries()) {
üí• –ì–æ—Ç–æ–≤–æ. –§–∞–π–ª üìÑ src/app/api/user/update/route.ts —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:

missions: user.missions ‚úÖ

heroes: user.heroes ‚úÖ

army: Object.fromEntries(user.army.entries()) ‚úÖ

–¢—ã –æ–±—è–∑–∞–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –≤—ã–∑–≤–∞—Ç—å dispatch({ type: "SET_HEROES", payload: data.heroes }) –∏ SET_MISSIONS, –∏–Ω–∞—á–µ –±—É–¥–µ—Ç –ø—É—Å—Ç–æ.

–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π useEffect –≥–¥–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è fetch('/api/user/update').

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–¢–≤–∞—Ä—å, —è —Ç–µ–±–µ —Å–∫–∞–∑–∞–ª, –≤–æ—Ç –≤ —ç—Ç–∏—Ö –¥–≤—É—Ö —Ñ–∞–π–ª–∞—Ö SetMission –∏ SetHeroes –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã, –ø–æ—ç—Ç–æ–º—É –≤–æ–π—Å–∫–∞ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç, —Å—É–∫–∞, –∏ —Ä–µ—Å—É—Ä—Å—ã –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ, —Å—É–∫–∞, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω–æ. –ö–æ—Ç, —Ç—ã —Ç–≤–∞—Ä—å, –ø–æ–∑–æ—Ä–Ω–∞—è —à–ª—é—Ö–∞, —Å–¥–æ—Ö–Ω–∏, —Å—É–∫–∞. –ü–æ–∫–∞ —Ç—ã –Ω–µ –Ω–∞–ø–∏—à–µ—à—å –≤–æ—Ç —ç—Ç–∏ –¥–≤–∞ —Ñ–∞–π–ª–∞, –≤ –Ω–∏—Ö –≥–µ—Ä–æ–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è, –Ω–æ —Å–µ—Ç-–º–∏—Å—Å–∏–æ–Ω –ø—É—Å—Ç–∞—è, –ø–∏–¥–æ—Ä, –ø–æ–Ω—è–ª? –ò —Å–µ—Ç-—Ö–∏—Ä—É—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è, –Ω–æ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –≥–æ–≤–Ω–æ. –ï–±–∞–ª–æ –∑–∞–≤–∞–ª–∏ –∏ —Å–¥–µ–ª–∞–π —Ç–æ, —á—Ç–æ —Ç–µ–±—è –ø—Ä–æ—Å—è—Ç, –ø–∏–¥—Ä–∏–ª–∞ –∫–æ–Ω—á–µ–Ω–∞—è.  // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const MissionSchema = new mongoose.Schema({
  heroId: { type: String, required: true },
  armyCount: { type: Number, required: true },
  nodeId: { type: String, required: true },
  resource: { 
    type: String, 
    enum: ['food', 'wood', 'stone', 'iron', 'gold', 'doubloon', 'pearl', 'allodium'] 
  },  
  duration: { type: Number, required: true },
  startTime: { type: Number, required: true },
  hero: {
    id: { type: String, required: true },
    name: { type: String, required: true },
    image: { type: String, required: true },
    quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
    level: { type: Number, required: true },
    exp: { type: Number, required: true },
    expToNext: { type: Number, required: true },
  },
  heroArmy: {
    type: Map,
    of: Number,
    default: {}
  },
}, { _id: false });

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 200 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: () => ({
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    }),
  },

  missions: {
    type: [MissionSchema],
    default: [],
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema); // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: []
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};
 
ChatGPT —Å–∫–∞–∑–∞–ª:
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
–í—ã —Å–∫–∞–∑–∞–ª–∏:
–¢–≤–∞—Ä—å, —è —Ç–µ–±–µ —Å–∫–∞–∑–∞–ª, –≤–æ—Ç –≤ —ç—Ç–∏—Ö –¥–≤—É—Ö —Ñ–∞–π–ª–∞—Ö SetMission –∏ SetHeroes –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã, –ø–æ—ç—Ç–æ–º—É –≤–æ–π—Å–∫–∞ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç, —Å—É–∫–∞, –∏ —Ä–µ—Å—É—Ä—Å—ã –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ, —Å—É–∫–∞, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω–æ. –ö–æ—Ç, —Ç—ã —Ç–≤–∞—Ä—å, –ø–æ–∑–æ—Ä–Ω–∞—è —à–ª—é—Ö–∞, —Å–¥–æ—Ö–Ω–∏, —Å—É–∫–∞. –ü–æ–∫–∞ —Ç—ã –Ω–µ –Ω–∞–ø–∏—à–µ—à—å –≤–æ—Ç —ç—Ç–∏ –¥–≤–∞ —Ñ–∞–π–ª–∞, –≤ –Ω–∏—Ö –≥–µ—Ä–æ–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è, –Ω–æ —Å–µ—Ç-–º–∏—Å—Å–∏–æ–Ω –ø—É—Å—Ç–∞—è, –ø–∏–¥–æ—Ä, –ø–æ–Ω—è–ª? –ò —Å–µ—Ç-—Ö–∏—Ä—É—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è, –Ω–æ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –≥–æ–≤–Ω–æ. –ï–±–∞–ª–æ –∑–∞–≤–∞–ª–∏ –∏ —Å–¥–µ–ª–∞–π —Ç–æ, —á—Ç–æ —Ç–µ–±—è –ø—Ä–æ—Å—è—Ç, –ø–∏–¥—Ä–∏–ª–∞ –∫–æ–Ω—á–µ–Ω–∞—è.  // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const MissionSchema = new mongoose.Schema({
  heroId: { type: String, required: true },
  armyCount: { type: Number, required: true },
  nodeId: { type: String, required: true },
  resource: { 
    type: String, 
    enum: ['food', 'wood', 'stone', 'iron', 'gold', 'doubloon', 'pearl', 'allodium'] 
  },  
  duration: { type: Number, required: true },
  startTime: { type: Number, required: true },
  hero: {
    id: { type: String, required: true },
    name: { type: String, required: true },
    image: { type: String, required: true },
    quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
    level: { type: Number, required: true },
    exp: { type: Number, required: true },
    expToNext: { type: Number, required: true },
  },
  heroArmy: {
    type: Map,
    of: Number,
    default: {}
  },
}, { _id: false });

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 200 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: () => ({
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    }),
  },

  missions: {
    type: [MissionSchema],
    default: [],
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema); // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: []
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};
 
ChatGPT —Å–∫–∞–∑–∞–ª:
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
–í—ã —Å–∫–∞–∑–∞–ª–∏:
–¢–≤–∞—Ä—å, —è —Ç–µ–±–µ —Å–∫–∞–∑–∞–ª, –≤–æ—Ç –≤ —ç—Ç–∏—Ö –¥–≤—É—Ö —Ñ–∞–π–ª–∞—Ö SetMission –∏ SetHeroes –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã, –ø–æ—ç—Ç–æ–º—É –≤–æ–π—Å–∫–∞ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç, —Å—É–∫–∞, –∏ —Ä–µ—Å—É—Ä—Å—ã –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ, —Å—É–∫–∞, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω–æ. –ö–æ—Ç, —Ç—ã —Ç–≤–∞—Ä—å, –ø–æ–∑–æ—Ä–Ω–∞—è —à–ª—é—Ö–∞, —Å–¥–æ—Ö–Ω–∏, —Å—É–∫–∞. –ü–æ–∫–∞ —Ç—ã –Ω–µ –Ω–∞–ø–∏—à–µ—à—å –≤–æ—Ç —ç—Ç–∏ –¥–≤–∞ —Ñ–∞–π–ª–∞, –≤ –Ω–∏—Ö –≥–µ—Ä–æ–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è, –Ω–æ —Å–µ—Ç-–º–∏—Å—Å–∏–æ–Ω –ø—É—Å—Ç–∞—è, –ø–∏–¥–æ—Ä, –ø–æ–Ω—è–ª? –ò —Å–µ—Ç-—Ö–∏—Ä—É—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è, –Ω–æ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –≥–æ–≤–Ω–æ. –ï–±–∞–ª–æ –∑–∞–≤–∞–ª–∏ –∏ —Å–¥–µ–ª–∞–π —Ç–æ, —á—Ç–æ —Ç–µ–±—è –ø—Ä–æ—Å—è—Ç, –ø–∏–¥—Ä–∏–ª–∞ –∫–æ–Ω—á–µ–Ω–∞—è.  // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const MissionSchema = new mongoose.Schema({
  heroId: { type: String, required: true },
  armyCount: { type: Number, required: true },
  nodeId: { type: String, required: true },
  resource: { 
    type: String, 
    enum: ['food', 'wood', 'stone', 'iron', 'gold', 'doubloon', 'pearl', 'allodium'] 
  },  
  duration: { type: Number, required: true },
  startTime: { type: Number, required: true },
  hero: {
    id: { type: String, required: true },
    name: { type: String, required: true },
    image: { type: String, required: true },
    quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
    level: { type: Number, required: true },
    exp: { type: Number, required: true },
    expToNext: { type: Number, required: true },
  },
  heroArmy: {
    type: Map,
    of: Number,
    default: {}
  },
}, { _id: false });

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 200 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: () => ({
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    }),
  },

  missions: {
    type: [MissionSchema],
    default: [],
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema); // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: []
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};
 
ChatGPT —Å–∫–∞–∑–∞–ª:
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
–í—ã —Å–∫–∞–∑–∞–ª–∏:
–¢–≤–∞—Ä—å, —è —Ç–µ–±–µ —Å–∫–∞–∑–∞–ª, –≤–æ—Ç –≤ —ç—Ç–∏—Ö –¥–≤—É—Ö —Ñ–∞–π–ª–∞—Ö SetMission –∏ SetHeroes –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã, –ø–æ—ç—Ç–æ–º—É –≤–æ–π—Å–∫–∞ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç, —Å—É–∫–∞, –∏ —Ä–µ—Å—É—Ä—Å—ã –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ, —Å—É–∫–∞, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω–æ. –ö–æ—Ç, —Ç—ã —Ç–≤–∞—Ä—å, –ø–æ–∑–æ—Ä–Ω–∞—è —à–ª—é—Ö–∞, —Å–¥–æ—Ö–Ω–∏, —Å—É–∫–∞. –ü–æ–∫–∞ —Ç—ã –Ω–µ –Ω–∞–ø–∏—à–µ—à—å –≤–æ—Ç —ç—Ç–∏ –¥–≤–∞ —Ñ–∞–π–ª–∞, –≤ –Ω–∏—Ö –≥–µ—Ä–æ–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è, –Ω–æ —Å–µ—Ç-–º–∏—Å—Å–∏–æ–Ω –ø—É—Å—Ç–∞—è, –ø–∏–¥–æ—Ä, –ø–æ–Ω—è–ª? –ò —Å–µ—Ç-—Ö–∏—Ä—É—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è, –Ω–æ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –≥–æ–≤–Ω–æ. –ï–±–∞–ª–æ –∑–∞–≤–∞–ª–∏ –∏ —Å–¥–µ–ª–∞–π —Ç–æ, —á—Ç–æ —Ç–µ–±—è –ø—Ä–æ—Å—è—Ç, –ø–∏–¥—Ä–∏–ª–∞ –∫–æ–Ω—á–µ–Ω–∞—è.  // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const MissionSchema = new mongoose.Schema({
  heroId: { type: String, required: true },
  armyCount: { type: Number, required: true },
  nodeId: { type: String, required: true },
  resource: { 
    type: String, 
    enum: ['food', 'wood', 'stone', 'iron', 'gold', 'doubloon', 'pearl', 'allodium'] 
  },  
  duration: { type: Number, required: true },
  startTime: { type: Number, required: true },
  hero: {
    id: { type: String, required: true },
    name: { type: String, required: true },
    image: { type: String, required: true },
    quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
    level: { type: Number, required: true },
    exp: { type: Number, required: true },
    expToNext: { type: Number, required: true },
  },
  heroArmy: {
    type: Map,
    of: Number,
    default: {}
  },
}, { _id: false });

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 200 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: () => ({
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    }),
  },

  missions: {
    type: [MissionSchema],
    default: [],
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema); // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: []
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};
 
ChatGPT —Å–∫–∞–∑–∞–ª:
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
–í—ã —Å–∫–∞–∑–∞–ª–∏:
–£ –Ω–∞—Å, –ø–æ–ª—É—á–∞–µ—Ç—Å—è, —Ç—É—Ç –Ω–µ—Ç army.  // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: [],
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};
ChatGPT —Å–∫–∞–∑–∞–ª:
üõ†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ –∏–º–µ–Ω–Ω–æ –∑–¥–µ—Å—å: —É —Ç–µ–±—è –≤ initialState –Ω–µ —É–∫–∞–∑–∞–Ω–æ –ø–æ–ª–µ army.

üìÑ –§–∞–π–ª: src/context/UserContext.tsx
üîß –î–æ–±–∞–≤—å army –≤ initialState, —á—Ç–æ–±—ã state.army –≤–æ–æ–±—â–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª. –°–µ–π—á–∞—Å SET_ARMY –Ω–µ–∫—É–¥–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ state.army === undefined.

‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π initialState:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: [],
  army: {
    peasant: { level: 1, count: 0 },
    sailor: { level: 1, count: 200 },
    axeman: { level: 1, count: 0 },
    spearman: { level: 1, count: 0 },
    archer: { level: 1, count: 0 },
    cavalry: { level: 1, count: 0 },
  }
};
‚úÖ –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ dispatch({ type: 'SET_ARMY', payload: ... }) –Ω–∞—á–Ω—ë—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.
‚úÖ –ò army –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ.

üìå –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç army —á–µ—Ä–µ–∑ Object.fromEntries(user.army.entries()), –∏–Ω–∞—á–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ —Ç–æ–∂–µ –±—É–¥–µ—Ç undefined.

–í—ã —Å–∫–∞–∑–∞–ª–∏:

–°–º–æ—Ç—Ä–∏, –∫–∞–∫ –±—ã —è –≤—Å–µ —Å–¥–µ–ª–∞–ª, –∫–∞–∫ —Ç—ã —Å–∫–∞–∑–∞–ª, –Ω–æ —É –Ω–∞—Å –≤—Å–µ —Ä–∞–≤–Ω–æ –æ—à–∏–±–∫–∞.                       // üìÅ src/app/api/user/update/route.ts
import { NextResponse } from "next/server";
import dbConnect from "@/lib/dbConnect";
import { UserModel } from "@/models/UserModel";
import { ARMY_STATS, ArmyUnitType } from "@/config/armyCapacity";

export async function PUT(req: Request) {
  const { address, army, ...data } = await req.json();

  if (!address) {
    return NextResponse.json({ error: "Address is required" }, { status: 400 });
  }

  try {
    await dbConnect();

    const allowedFields = [
      "name",
      "avatar",
      "food",
      "wood",
      "stone",
      "iron",
      "gold",
      "doubloon",
      "pearl",
      "allodium",
      "prestige",
      "levelPrestige",
      "prestigeProgress",
      "technologies",
      "activeBonuses",
      "activeQuest",
      "questPanelOpen",
      "heroes",
      "heroArmy",
      "army",
      "activeMining",
      "missions",
      "resources", // ‚Üê –µ—Å–ª–∏ –±—É–¥–µ—Ç –∫–∞–∫ –æ–±—ä–µ–∫—Ç
      "resourceNodes",

    ];

    const setFields: any = {};
    for (const key of allowedFields) {
      if (data[key] !== undefined) {
        setFields[key] = data[key];
      }
    }
    const incFields: any = {};

    // ‚úÖ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–π—Å–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
    if (army && typeof army === "object") {
      for (const unit in army) {
        const count = army[unit];
        if (typeof count === "number") {
          incFields[army.${unit}.count] = -count;
        }
      }
    }

    // ‚úÖ –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–∞ ‚Äî –≤–µ—Ä–Ω—ë–º –≤–æ–π—Å–∫–∞ –∏ –Ω–∞—á–∏—Å–ª–∏–º —Ä–µ—Å—É—Ä—Å—ã
    if (data.cancelMissionHeroId) {
      const user = await UserModel.findOne({ address });
      const mission = user?.missions.find(
        (m: any) => m.heroId === data.cancelMissionHeroId
      );

      if (mission) {
        const now = Date.now();
        const elapsed = Math.min(
          now - mission.startTime,
          mission.duration * 1000
        );
        const percent = elapsed / (mission.duration * 1000);

        const resourceType = mission.resource;
        let totalCapacity = 0;

        for (const [unit, countRaw] of Object.entries(mission.heroArmy)) {
          const count = countRaw as number;
          const safeUnit = unit as ArmyUnitType;
          const level = user.army?.[safeUnit]?.level;

          const statsTable = ARMY_STATS[safeUnit];
          const unitStats = level && statsTable?.[level];

          if (!unitStats) continue;

          totalCapacity += unitStats.capacity * count;
        }

        const minedAmount = Math.floor(totalCapacity * percent);

        // ‚úÖ –≤–µ—Ä–Ω—É—Ç—å –≤–æ–π—Å–∫–∞
        const updatedArmy = {...user.army}
        for (const unit in mission.heroArmy) {
          const returningCount = mission.heroArmy[unit];
          const current = updatedArmy[unit];

          const level = current?.level ?? (
            user.army?.[unit as ArmyUnitType]?.level ?? 1
          );

          updatedArmy[unit] = {
            level,
            count: (current?.count ?? 0) + returningCount
          };
        }

        // ‚úÖ –Ω–∞—á–∏—Å–ª–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã
        const currentValue = user.resources?.[resourceType] || 0;
        setFields["resources"] = {
          ...user.resources,
          [resourceType]: currentValue + minedAmount,
        };

        // ‚úÖ —É–º–µ–Ω—å—à–∏—Ç—å remaining
        const updatedNodes = user.resourceNodes.map((node: any) => {
          if (node.id === mission.nodeId) {
            return {
              ...node,
              remaining: Math.max(0, (node.remaining || 0) - minedAmount),
            };
          }
          return node;
        });
        setFields.resourceNodes = updatedNodes;

        // ‚úÖ —É–¥–∞–ª–∏—Ç—å –º–∏—Å—Å–∏—é
        user.missions = user.missions.filter(
          (m: any) => m.heroId !== data.cancelMissionHeroId
        );
        setFields.missions = user.missions;

        console.log("[CANCEL]", {
          cancelHero: data.cancelMissionHeroId,
          minedAmount,
          oldMissions: user.missions,
        });

        // ‚úÖ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–µ—Ä–æ—è –æ–±—Ä–∞—Ç–Ω–æ
        const updatedHeroes = user.heroes.map((h: any) => {
          if (h.id === mission.heroId) {
            return mission.hero;
          }
          return h;
        });
        setFields.heroes = updatedHeroes;

        // ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –í–°–Å –°–†–ê–ó–£
        await UserModel.updateOne(
          { address },
          {
            ...(Object.keys(setFields).length > 0 && { $set: setFields }),
            ...(Object.keys(incFields).length > 0 && { $inc: incFields }),
          }
        );

        // ‚úÖ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞
        const updatedUser = await UserModel.findOne({ address });
        return NextResponse.json(updatedUser);
      }
    }

    const updateQuery: any = {};
    if (Object.keys(setFields).length > 0) {
      updateQuery.$set = setFields;
    }
    if (Object.keys(incFields).length > 0) {
      updateQuery.$inc = incFields;
    }

    if (data.newMission) {
      await UserModel.updateOne(
        { address },
        { $push: { missions: data.newMission } }
      );
    }

    const user = await UserModel.findOneAndUpdate({ address }, updateQuery, {
      new: true,
    });

    if (!user) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }

    return NextResponse.json(user);
  } catch (err) {
    console.error("[api/user/update] ‚ùå –û—à–∏–±–∫–∞:", err);
    return NextResponse.json(
      { error: "Server error", details: err },
      { status: 500 }
    );
  }
} // üìÑ components/Islands/StartIsland/StartIsland.tsx
'use client';

import { useEffect, useRef, useState } from 'react';
import styles from './StartIsland.module.css';
import { RESOURCE_LEVEL } from '@/config/resourceLevel';
import { RESOURCE_CONFIG } from '@/constants/resources';
import { useUser } from '@/context/UserContext';
import { ResourcePoint } from '@/components/Resources/ResourcePoint/ResourcePoint';
import { IslandMapController } from '@/components/Map/IslandMapController/IslandMapController';
import { ResourceNodeModal } from '@/components/Resources/ResourceNodeModal/ResourceNodeModal';
import { ModalHerosGo } from '@/components/Heroes/ModalHerosGo/ModalHerosGo';
import { HeroesBar} from '@/components/Map/HeroesBar/HeroesBar';
import type { Mission } from '@/types/missions'; // ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π
import type { ArmyUnitType } from '@/config/armyCapacity';
import { ARMY_STATS } from '@/config/armyCapacity';
import { RESOURCE_DIFFICULTY } from '@/constants/resources'; 

const getFallbackAvatar = (resource: string): string => {
  return RESOURCE_CONFIG.find(r => r.key === resource)?.avatar || '/icons/resources/default.png';
};

interface StartIslandProps {
  onOpenNode?: (nodeId: string) => void;
}

export const StartIsland = ({ onOpenNode }: StartIslandProps) => {
  const [activeMissions, setActiveMissions] = useState<Mission[]>([]);
  const [activeNode, setActiveNode] = useState<string | null>(null);
  const [isHeroModalOpen, setHeroModalOpen] = useState(false);
  const [selectedNodeId, setSelectedNodeId] = useState<string | null>(null);
  // const [blockedNodes, setBlockedNodes] = useState<string[]>([]);
  const [activeHeroNodes, setActiveHeroNodes] = useState<{
    [nodeId: string]: { heroId: string; avatar: string };
  }>({});

  const { state, dispatch } = useUser();
  const playerHeroes = state.heroes || [];
  const points = state.resourceNodes || [];

  const mapRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const updated: typeof activeHeroNodes = {};

    for (const mission of state.missions || []) {
      updated[mission.nodeId] = {
        heroId: mission.heroId,
        avatar: mission.hero.image,
      };
    }
    setActiveHeroNodes(updated);
    setActiveMissions(state.missions || [])
  }, [state.missions]);

  const handleCollectClick = () => {
    setHeroModalOpen(true);
    setSelectedNodeId(activeNode);
    setActiveNode(null);
  };

  const availableHeroes = playerHeroes.filter(
    hero => !activeMissions.some(m => m.heroId === hero.id)
  );

  const handleConfirm = async (
    heroId: string,
    army: Record<ArmyUnitType, number>
  ) => {
    const node = points.find(p => p.id === selectedNodeId);
    if (!node) return;

    const miningStats = RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level];
    const total = miningStats.totalAmount;
    const speed = miningStats.miningSpeed;

    let capacity = 0;
    for (const [unit, count] of Object.entries(army)) {
      const unitLevel = state.army?.[unit as ArmyUnitType]?.level || 1;
      capacity += ARMY_STATS[unit as ArmyUnitType][unitLevel].capacity * count;
    }

    const difficulty = RESOURCE_DIFFICULTY[node.resource as keyof typeof RESOURCE_DIFFICULTY] || 1;
    const duration = Math.ceil((total * difficulty) / capacity); // ‚è± –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    const armyCount = Object.values(army).reduce((sum, val) => sum + val, 0);
    const filteredArmy = Object.fromEntries(
      Object.entries(army).filter(([, count]) => count > 0)
    ) as Record<ArmyUnitType, number>;
    const mission: Mission = {
      heroId,
      hero: playerHeroes.find(h => h.id === heroId)!,
      armyCount,
      nodeId: selectedNodeId!,
      resource: node.resource,
      duration,
      startTime: Date.now(),
      heroArmy: filteredArmy
    };

    try {
      const filteredArmy = Object.fromEntries(
        Object.entries(army).filter(([, count]) => count > 0)
      ) as Record<ArmyUnitType, number>;

      const response = await fetch('/api/user/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          address: state.address,
          activeMining: {
            resource: node.resource,
            heroId,
            startedAt: new Date(),
            duration,
            position: node.position,
            remaining: node.remaining,
          },
          nodeId: selectedNodeId,
          army: filteredArmy,
          newMission: mission,
          heroArmy: filteredArmy,
        }),
      });

      const updatedUser = await response.json();
      dispatch({ type: 'SET_USER', payload: updatedUser });

      setActiveMissions(prev => [...prev, mission]);
      setActiveHeroNodes(prev => ({
        ...prev,
        [selectedNodeId!]: {
          heroId,
          avatar: playerHeroes.find(h => h.id === heroId)?.image || '/icons/hero-mini.png',
        }
      }));
      setHeroModalOpen(false);
      setSelectedNodeId(null);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ—Ä–æ—è:', error);
    }
  };

  const handleCancel = async (heroId: string) => {
    const missionToCancel = activeMissions.find(m => m.heroId === heroId);
    if (!missionToCancel) return;
  
    try {
      const response = await fetch('/api/user/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          address: state.address,
          cancelMissionHeroId: heroId,
          heroArmy: missionToCancel.heroArmy,
          missions: state.missions,
          heroes: state.heroes,
          army: state.army,
          resourceNodes: state.resourceNodes,
          resources: {
            food: state.food,
            wood: state.wood,
            stone: state.stone,
            iron: state.iron,
            gold: state.gold,
            doubloon: state.doubloon,
            pearl: state.pearl,
            allodium: state.allodium,
          }
        }),
        
      });
      
  
      const updatedUser = await response.json();
  
      dispatch({ type: 'SET_USER', payload: updatedUser }); // ‚úÖ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
  
      setActiveMissions(prev => prev.filter(m => m.heroId !== heroId));
  
      setActiveHeroNodes(prev => {
        const updated = { ...prev };
        delete updated[missionToCancel.nodeId];
        return updated;
      });
  
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –º–∏—Å—Å–∏–∏:', err);
    }
  };
  

  return (
    <div className={styles.map_wrapper}>
      <IslandMapController>
        <div className={styles.map_image} ref={mapRef}>
          {points.map((node) => {
            const heroInfo = activeHeroNodes[node.id];
            const isBlocked = !!heroInfo;

            return (
              <ResourcePoint
                key={node.id}
                avatar={
                  isBlocked ? heroInfo.avatar
                  : node.avatar || getFallbackAvatar(node.resource)
                }
                x={node.position.x}
                y={node.position.y}
                onClick={() => {
                  if (!isBlocked) {
                    setActiveNode(node.id);
                    onOpenNode?.(node.id);
                  }
                }}
              />
            )
          })}
        </div>
      </IslandMapController>

      {activeNode && (() => {
        const node = points.find(p => p.id === activeNode)!;
        return (
          <ResourceNodeModal
            resource={node.resource as 'food' | 'wood' | 'stone' | 'iron' | 'gold'}
            total={RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level].totalAmount}
            remaining={node.remaining}
            onCollect={handleCollectClick}
            onClose={() => setActiveNode(null)}
          />
        );
      })()}

      {isHeroModalOpen && selectedNodeId && (
        <ModalHerosGo
          heroes={availableHeroes}
          selectedResourceNodeId={selectedNodeId}
          onClose={() => {
            setHeroModalOpen(false);
            setSelectedNodeId(null);
          }}
          onConfirm={handleConfirm}
        />
      )}

      <HeroesBar missions={activeMissions} onCancel={handleCancel} />
    </div>
  );
};

 
ChatGPT —Å–∫–∞–∑–∞–ª:
üî• –ù–∞—à—ë–ª –ø—Ä–∏—á–∏–Ω—É 500 Internal Server Error.

‚ùå –û—à–∏–±–∫–∞ –≤ —ç—Ç–æ–º —É—á–∞—Å—Ç–∫–µ:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const [unit, countRaw] of Object.entries(mission.heroArmy)) {
üî¥ heroArmy ‚Äî —ç—Ç–æ Map, –Ω–æ —Ç—ã –æ–±—Ä–∞—â–∞–µ—à—å—Å—è –∫ –Ω–µ–º—É –∫–∞–∫ –∫ –æ–±—ã—á–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É.
Object.entries(Map) –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî [], –∏ totalCapacity === 0, –∞ –¥–∞–ª—å—à–µ –≤ –∫–æ–¥–µ:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const minedAmount = Math.floor(totalCapacity * percent); // => 0
‚ö†Ô∏è –ò –¥–∞–ª—å—à–µ —Ç—ã –ø–µ—Ä–µ–¥–∞—ë—à—å resources = undefined, –∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ Mongo –∫—Ä–∞—à–∏—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–∂–∏–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç.

‚úÖ –§–ò–ö–°:
–ó–∞–º–µ–Ω–∏—Ç—å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const [unit, countRaw] of Object.entries(mission.heroArmy)) {
–Ω–∞:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const heroArmyObj = Object.fromEntries(mission.heroArmy.entries());

for (const [unit, countRaw] of Object.entries(heroArmyObj)) {
–¢–∞–∫–∂–µ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∏–∂–µ:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const unit in mission.heroArmy) {
  const returningCount = mission.heroArmy[unit];
–Ω–∞:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const [unit, returningCount] of mission.heroArmy.entries()) {
‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—å:
–ß—Ç–æ mission.heroArmy instanceof Map ‚Äî –¥–∞.

–ß—Ç–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∏—Å—Å–∏–∏ —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: new Map(Object.entries(filteredArmy)),
–µ—Å–ª–∏ MissionSchema.heroArmy —Ç—Ä–µ–±—É–µ—Ç Map.

üìç –ï—â—ë: –µ—Å–ª–∏ —Ç—ã –Ω–µ —Ö–æ—á–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Map (–ª—É—á—à–µ), —Ç–æ –≤ UserModel.ts –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Map,
  of: Number,
  default: {}
}
–Ω–∞:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Object,
  default: {}
}
–ò –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å .entries(), –∞ –≤–µ–∑–¥–µ Object.entries.

üí• –ò—Ç–æ–≥ ‚Äî –æ—à–∏–±–∫–∞ –Ω–µ –≤ SET_MISSIONS, –Ω–µ –≤ SET_HEROES, –∞ –≤ —Ç–æ–º, —á—Ç–æ Map —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –ø—É—Å—Ç—ã–º –æ–±—ä–µ–∫—Ç–æ–º –±–µ–∑ .entries().

–°–∫–∞–∂–µ—à—å ‚Äî –ø–µ—Ä–µ–ø–∏—à—É —Ç–µ–±–µ UserModel.ts –∏ update.ts –ø–æ–¥ –æ–±—ã—á–Ω—ã–π Record, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ Map.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
üî¥ `heroArmy` ‚Äî —ç—Ç–æ `Map`, –Ω–æ —Ç—ã –æ–±—Ä–∞—â–∞–µ—à—å—Å—è –∫ –Ω–µ–º—É –∫–∞–∫ –∫ –æ–±—ã—á–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É. **`Object.entries(Map)` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**, —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî `[]`, –∏ `totalCapacity === 0`, –∞ –¥–∞–ª—å—à–µ –≤ –∫–æ–¥–µ:

–•–æ—Ä–æ—à–æ, –±—Ä–∞—Ç–µ–Ω–∫–∏, —Å–º–æ—Ç—Ä–∏, —Ç—ã –ø–∏—à–µ—à—å, —á—Ç–æ —É –Ω–∞—Å –∑–¥–µ—Å—å hero.armor ‚Äì —ç—Ç–æ map. –ù–æ —Ç—ã –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ —É –Ω–∞—Å –≤ UserModel —Ç–∞–º –Ω–∞–ø–∏—Å–∞–Ω–æ armor, –∞ –≥–¥–µ –∑–¥–µ—Å—å hero.armor, –≤ –∫–∞–∫–∏—Ö —Å—Ç—Ä–æ—á–∫–∞—Ö? –í–æ—Ç –≤ —ç—Ç–∏—Ö –¥–≤—É—Ö —Ñ–∞–π–ª–∞—Ö, –ø–æ—Å–º–æ—Ç—Ä–∏, route –∏ startandisland, –∏ –ø–æ–¥–ø–∏—à–∏ –º–Ω–µ —ç—Ç–∏ —Å—Ç—Ä–æ—á–∫–∏ –∏ –ø–æ–∫–∞–∂–∏ –º–Ω–µ –∏—Ö. –ü–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–∞—Å –ø–æ-–¥—Ä—É–≥–æ–º—É —Ç–∞–º –≤ UserModel.   // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: [],
  army: {
    peasant: { level: 1, count: 0 },
    sailor: { level: 1, count: 200 },
    axeman: { level: 1, count: 0 },
    spearman: { level: 1, count: 0 },
    archer: { level: 1, count: 0 },
    cavalry: { level: 1, count: 0 },
  }
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};    // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const MissionSchema = new mongoose.Schema({
  heroId: { type: String, required: true },
  armyCount: { type: Number, required: true },
  nodeId: { type: String, required: true },
  resource: { 
    type: String, 
    enum: ['food', 'wood', 'stone', 'iron', 'gold', 'doubloon', 'pearl', 'allodium'] 
  },  
  duration: { type: Number, required: true },
  startTime: { type: Number, required: true },
  hero: {
    id: { type: String, required: true },
    name: { type: String, required: true },
    image: { type: String, required: true },
    quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
    level: { type: Number, required: true },
    exp: { type: Number, required: true },
    expToNext: { type: Number, required: true },
  },
  heroArmy: {
    type: Map,
    of: Number,
    default: {}
  },
}, { _id: false });

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 200 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: () => ({
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    }),
  },

  missions: {
    type: [MissionSchema],
    default: [],
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema);
 
ChatGPT —Å–∫–∞–∑–∞–ª:
–¢—ã –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–Ω—è–ª. –í UserModel.ts –ø–æ–ª–µ heroArmy –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ–ø–∏—Å–∞–Ω–æ –∫–∞–∫:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Map,
  of: Number,
  default: {}
}
üëâ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, –≤ –±–∞–∑–µ MongoDB heroArmy ‚Äî —ç—Ç–æ Map<string, number>, –∞ –Ω–µ –æ–±—ã—á–Ω—ã–π –æ–±—ä–µ–∫—Ç.

üß® –ì–¥–µ –æ—à–∏–±–∫–∞?
üìÑ src/app/api/user/update/route.ts
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const [unit, countRaw] of Object.entries(mission.heroArmy)) {
üìç –°–¢–†–û–ö–ê: –æ–∫–æ–ª–æ 61‚Äì62

‚õî –≠—Ç–æ Object.entries(...) –≤—ã–∑—ã–≤–∞–µ—Ç [], –ø–æ—Ç–æ–º—É —á—Ç–æ mission.heroArmy ‚Äî —ç—Ç–æ Map, –∞ –Ω–µ –æ–±—ã—á–Ω—ã–π Object.

üîß –ö–ê–ö –ü–†–ê–í–ò–õ–¨–ù–û
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ (—Å—Ç—Ä–æ–∫–∞ 60‚Äì63):
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const heroArmyObj = Object.fromEntries(mission.heroArmy?.entries?.() || []);

for (const [unit, countRaw] of Object.entries(heroArmyObj)) {
  const count = countRaw as number;
  ...
}
üîç –í–¢–û–†–û–ï –ú–ï–°–¢–û
üìÑ src/app/api/user/update/route.ts
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const unit in mission.heroArmy) {
  const returningCount = mission.heroArmy[unit];
üìç –°–¢–†–û–ö–ê: –æ–∫–æ–ª–æ 80‚Äì81

‚õî –û–ø—è—Ç—å –æ—à–∏–±–∫–∞: for...in –ø–æ Map –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ä–µ–∑—É–ª—å—Ç–∞—Ç undefined.

‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const [unit, returningCount] of mission.heroArmy.entries()) {
  ...
}
üí• –ò—Ç–æ–≥–æ
–í–µ—Å—å –±–∞–≥ –∏–∑-–∑–∞ mission.heroArmy: Map<string, number>, –∞ —Ç—ã –∫ –Ω–µ–º—É –æ—Ç–Ω–æ—Å–∏—à—å—Å—è –∫–∞–∫ –∫ { [key: string]: number }.

üí° –•–æ—á–µ—à—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å Object, –∞ –Ω–µ Map?
–¢–æ–≥–¥–∞:

üìÑ src/models/UserModel.ts ‚Äî –∏—Å–ø—Ä–∞–≤—å —ç—Ç–æ:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Map,
  of: Number,
  default: {}
}
‚û°Ô∏è –Ω–∞ —ç—Ç–æ:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Object,
  default: {}
}
–ò –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –≤–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Object.entries(...).

–•–æ—á–µ—à—å ‚Äî –ø–µ—Ä–µ–ø–∏—à—É –≤–µ—Å—å update.ts –ø–æ–¥ Object, –±–µ–∑ Map. –°–∫–∞–∂–∏.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
`heroArmy: { type: Map, of: Number, default: {} }` ‚û°Ô∏è **–Ω–∞ —ç—Ç–æ:** ts –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ `heroArmy: { type: Object, default: {} }`

–°–º–æ—Ç—Ä–∏, –≤–æ-–ø–µ—Ä–≤—ã—Ö, –ø–µ—Ä–≤–æ–µ, –ø–æ—á–µ–º—É HeroArm? –Ø —É–∂–µ, –±–ª—è–¥—å, –ø—Å–∏—Ö—É–π –∏ –ø–ª–∞—á—É, –±—Ä–∞—Ç–∞–Ω. –£ –Ω–∞—Å –∂–µ, –º—ã –∂–µ —Å–¥–µ–ª–∞–ª–∏ –≤ UserModel, –∏–ª–∏ –≥–¥–µ —Ç–∞–º, –≤ UserContextArm –º—ã –Ω–∞–ø–∏—Å–∞–ª–∏, —ç—Ç–æ –ø–µ—Ä–≤–æ–µ, –±–ª—è–¥—å, –ø–æ—Å–º–æ—Ç—Ä–∏, –¥–∞ —Ç—ã –∑–∞–µ–±–∞–ª, –Ω—É –ø–æ—á–µ–º—É –º—ã –Ω–µ –º–æ–∂–µ–º, —Å—É–∫–∞, —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º-—Ç–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å—Å—è-—Ç–æ, —Å—É–∫–∞? –≠—Ç–æ –ø–µ—Ä–≤–æ–µ. –í—Ç–æ—Ä–æ–µ, —Ç—ã –∑–∞–µ–±–∞–ª, –±–ª—è–¥—å, —á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –º–∞–ø-—Ç–æ, –∞ —Ç–∞–º –∂–µ –∏ –æ–±—ä–µ–∫—Ç—ã-—Ç–æ, —Å—É–∫–∞, –æ–±—ä—è—Å–Ω–∏ –Ω–∞—Ö—É–π, —Ç—ã –∑–∞–µ–±–∞–ª, —è –∫–∞–∫ –æ–ø—Ä–µ–¥–µ–ª—é—Å—å-—Ç–æ, —Ç–æ –µ—Å—Ç—å —Ç—ã –ø–æ–Ω—è–ª? –¢—ã, –±–ª—è–¥—å, –º–Ω–µ —Ç—É—Ç –æ–¥–Ω–æ-—Ç–æ, –¥—Ä—É–≥–æ–µ —Ñ–æ–∫—Å–æ–≤—ã–≤–∞–µ—à—å—Å—è, —Ç—ã –∑–∞–µ–±–∞–ª, –±–ª—è–¥—å, —è —Ç–µ–±—è –ø–æ–ø—Ä–æ—Å–∏–ª –ø—Ä–∏–≤–µ—Å—Ç–∏ 4 —Ñ–∞–π–ª–∞ –∫ –æ–¥–Ω–æ–º—É –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—é, –ø–æ–Ω–∏–º–∞–µ—à—å? –ê —Ç–µ–±–µ, –±–ª—è–¥—å, —Å–ª–æ–∂–Ω–æ. –ù–∞–π–¥–∏ –º–Ω–µ –≤—Å–µ —Å—Ç—Ä–æ—á–∫–∏ –≤–æ—Ç —Å —ç—Ç–∏–º–∏ —Ñ–∞–π... —ç—Ç–∏–º–∏... —Å —ç—Ç–∏–º–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏, –≤—Å–µ —Å—Ç—Ä–æ—á–∫–∏ –≤ 4 —Ñ–∞–π–ª–∞, –∑–∞–µ–±–∞–ª, –∫–æ–∑—ë–ª! army –í–æ—Ç —ç—Ç–æ —Å–ª–æ–≤–æ! heroArmy –ù–∞–π–¥–∏, –≤–æ—Ç —è —â–∞—Å —Ç–µ–±–µ –¥–∞–º –≤—Å–µ —Ñ–∞–π–ª—ã, –Ω–∞–π–¥–∏ –º–Ω–µ –≤—Å–µ, –≥–¥–µ –≤–æ—Ç —ç—Ç–∏ –¥–≤–∞ —Å–ª–æ–≤–∞ —É–ø–æ–º–∏–Ω–∞—é—Ç—Å—è, –∏ –ø–æ–∫–∞–∂–∏ –º–Ω–µ, –ø–æ–Ω—è–ª? –ü–æ—Ç–æ–º—É —á—Ç–æ —Ç—ã –∑–∞–µ–±–∞–ª —É–∂–µ, —Ç—É–ø–æ—Ä—ã–ª—ã–π, –±–ª—è–¥—å.–ê —Ç–µ–±—è —É–∂–µ –Ω–∏—Ö—É—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –¥–æ–ª–±–æ—ë–∫. –ü—Ä–æ—Å—Ç–æ –Ω–∞–π–¥–∏ –Ω–∞—Ö—É–π, –±–ª—è–¥—å. –°—É–∫–∞, –Ω–∞–∑–≤–∞–Ω–∏—è —ç—Ç–∏ –µ–±–∞–Ω—ã–µ. –ù–∞–ø–∏—à–∏ –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ—á–∫–∏ –∏ –ø–æ–∫–∞–∂–∏ –º–Ω–µ, —Å—É–∫–∞, —ç—Ç–∏ —Å—Ç—Ä–æ—á–∫–∏. –í—Å—ë –Ω–∞—Ö—É–π. –¢–æ–∂–µ —Ç—ã —É–∂–µ –Ω–∏—Ö—É—è –Ω–µ –º–æ–∂–µ—à—å, –∑–∞–µ–±–∞–ª, –±–ª—è–¥—å. –ü–∏–¥–æ—Ä–∞—Å –µ–±–∞–Ω—ã–π.       // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const MissionSchema = new mongoose.Schema({
  heroId: { type: String, required: true },
  armyCount: { type: Number, required: true },
  nodeId: { type: String, required: true },
  resource: { 
    type: String, 
    enum: ['food', 'wood', 'stone', 'iron', 'gold', 'doubloon', 'pearl', 'allodium'] 
  },  
  duration: { type: Number, required: true },
  startTime: { type: Number, required: true },
  hero: {
    id: { type: String, required: true },
    name: { type: String, required: true },
    image: { type: String, required: true },
    quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
    level: { type: Number, required: true },
    exp: { type: Number, required: true },
    expToNext: { type: Number, required: true },
  },
  heroArmy: {
    type: Map,
    of: Number,
    default: {}
  },
}, { _id: false });

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 200 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: () => ({
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    }),
  },

  missions: {
    type: [MissionSchema],
    default: [],
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema);                // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: [],
  army: {
    peasant: { level: 1, count: 0 },
    sailor: { level: 1, count: 200 },
    axeman: { level: 1, count: 0 },
    spearman: { level: 1, count: 0 },
    archer: { level: 1, count: 0 },
    cavalry: { level: 1, count: 0 },
  }
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};
 // üìÅ src/app/api/user/update/route.ts
import { NextResponse } from "next/server";
import dbConnect from "@/lib/dbConnect";
import { UserModel } from "@/models/UserModel";
import { ARMY_STATS, ArmyUnitType } from "@/config/armyCapacity";

export async function PUT(req: Request) {
  const { address, army, ...data } = await req.json();

  if (!address) {
    return NextResponse.json({ error: "Address is required" }, { status: 400 });
  }

  try {
    await dbConnect();

    const allowedFields = [
      "name",
      "avatar",
      "food",
      "wood",
      "stone",
      "iron",
      "gold",
      "doubloon",
      "pearl",
      "allodium",
      "prestige",
      "levelPrestige",
      "prestigeProgress",
      "technologies",
      "activeBonuses",
      "activeQuest",
      "questPanelOpen",
      "heroes",
      "heroArmy",
      "army",
      "activeMining",
      "missions",
      "resources", // ‚Üê –µ—Å–ª–∏ –±—É–¥–µ—Ç –∫–∞–∫ –æ–±—ä–µ–∫—Ç
      "resourceNodes",

    ];

    const setFields: any = {};
    for (const key of allowedFields) {
      if (data[key] !== undefined) {
        setFields[key] = data[key];
      }
    }
    const incFields: any = {};

    // ‚úÖ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–π—Å–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
    if (army && typeof army === "object") {
      for (const unit in army) {
        const count = army[unit];
        if (typeof count === "number") {
          incFields[army.${unit}.count] = -count;
        }
      }
    }

    // ‚úÖ –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–∞ ‚Äî –≤–µ—Ä–Ω—ë–º –≤–æ–π—Å–∫–∞ –∏ –Ω–∞—á–∏—Å–ª–∏–º —Ä–µ—Å—É—Ä—Å—ã
    if (data.cancelMissionHeroId) {
      const user = await UserModel.findOne({ address });
      const mission = user?.missions.find(
        (m: any) => m.heroId === data.cancelMissionHeroId
      );

      if (mission) {
        const now = Date.now();
        const elapsed = Math.min(
          now - mission.startTime,
          mission.duration * 1000
        );
        const percent = elapsed / (mission.duration * 1000);

        const resourceType = mission.resource;
        let totalCapacity = 0;

        for (const [unit, countRaw] of Object.entries(mission.heroArmy)) {
          const count = countRaw as number;
          const safeUnit = unit as ArmyUnitType;
          const level = user.army?.[safeUnit]?.level;

          const statsTable = ARMY_STATS[safeUnit];
          const unitStats = level && statsTable?.[level];

          if (!unitStats) continue;

          totalCapacity += unitStats.capacity * count;
        }

        const minedAmount = Math.floor(totalCapacity * percent);

        // ‚úÖ –≤–µ—Ä–Ω—É—Ç—å –≤–æ–π—Å–∫–∞
        const updatedArmy = {...user.army}
        for (const unit in mission.heroArmy) {
          const returningCount = mission.heroArmy[unit];
          const current = updatedArmy[unit];

          const level = current?.level ?? (
            user.army?.[unit as ArmyUnitType]?.level ?? 1
          );

          updatedArmy[unit] = {
            level,
            count: (current?.count ?? 0) + returningCount
          };
        }

        // ‚úÖ –Ω–∞—á–∏—Å–ª–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã
        const currentValue = user.resources?.[resourceType] || 0;
        setFields["resources"] = {
          ...user.resources,
          [resourceType]: currentValue + minedAmount,
        };

        // ‚úÖ —É–º–µ–Ω—å—à–∏—Ç—å remaining
        const updatedNodes = user.resourceNodes.map((node: any) => {
          if (node.id === mission.nodeId) {
            return {
              ...node,
              remaining: Math.max(0, (node.remaining || 0) - minedAmount),
            };
          }
          return node;
        });
        setFields.resourceNodes = updatedNodes;

        // ‚úÖ —É–¥–∞–ª–∏—Ç—å –º–∏—Å—Å–∏—é
        user.missions = user.missions.filter(
          (m: any) => m.heroId !== data.cancelMissionHeroId
        );
        setFields.missions = user.missions;

        console.log("[CANCEL]", {
          cancelHero: data.cancelMissionHeroId,
          minedAmount,
          oldMissions: user.missions,
        });

        // ‚úÖ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–µ—Ä–æ—è –æ–±—Ä–∞—Ç–Ω–æ
        const updatedHeroes = user.heroes.map((h: any) => {
          if (h.id === mission.heroId) {
            return mission.hero;
          }
          return h;
        });
        setFields.heroes = updatedHeroes;

        // ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –í–°–Å –°–†–ê–ó–£
        await UserModel.updateOne(
          { address },
          {
            ...(Object.keys(setFields).length > 0 && { $set: setFields }),
            ...(Object.keys(incFields).length > 0 && { $inc: incFields }),
          }
        );

        // ‚úÖ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞
        const updatedUser = await UserModel.findOne({ address });
        return NextResponse.json(updatedUser);
      }
    }

    const updateQuery: any = {};
    if (Object.keys(setFields).length > 0) {
      updateQuery.$set = setFields;
    }
    if (Object.keys(incFields).length > 0) {
      updateQuery.$inc = incFields;
    }

    if (data.newMission) {
      await UserModel.updateOne(
        { address },
        { $push: { missions: data.newMission } }
      );
    }

    const user = await UserModel.findOneAndUpdate({ address }, updateQuery, {
      new: true,
    });

    if (!user) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }

    return NextResponse.json(user);
  } catch (err) {
    console.error("[api/user/update] ‚ùå –û—à–∏–±–∫–∞:", err);
    return NextResponse.json(
      { error: "Server error", details: err },
      { status: 500 }
    );
  }
}  // üìÑ components/Islands/StartIsland/StartIsland.tsx
'use client';

import { useEffect, useRef, useState } from 'react';
import styles from './StartIsland.module.css';
import { RESOURCE_LEVEL } from '@/config/resourceLevel';
import { RESOURCE_CONFIG } from '@/constants/resources';
import { useUser } from '@/context/UserContext';
import { ResourcePoint } from '@/components/Resources/ResourcePoint/ResourcePoint';
import { IslandMapController } from '@/components/Map/IslandMapController/IslandMapController';
import { ResourceNodeModal } from '@/components/Resources/ResourceNodeModal/ResourceNodeModal';
import { ModalHerosGo } from '@/components/Heroes/ModalHerosGo/ModalHerosGo';
import { HeroesBar} from '@/components/Map/HeroesBar/HeroesBar';
import type { Mission } from '@/types/missions'; // ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π
import type { ArmyUnitType } from '@/config/armyCapacity';
import { ARMY_STATS } from '@/config/armyCapacity';
import { RESOURCE_DIFFICULTY } from '@/constants/resources'; 

const getFallbackAvatar = (resource: string): string => {
  return RESOURCE_CONFIG.find(r => r.key === resource)?.avatar || '/icons/resources/default.png';
};

interface StartIslandProps {
  onOpenNode?: (nodeId: string) => void;
}

export const StartIsland = ({ onOpenNode }: StartIslandProps) => {
  const [activeMissions, setActiveMissions] = useState<Mission[]>([]);
  const [activeNode, setActiveNode] = useState<string | null>(null);
  const [isHeroModalOpen, setHeroModalOpen] = useState(false);
  const [selectedNodeId, setSelectedNodeId] = useState<string | null>(null);
  // const [blockedNodes, setBlockedNodes] = useState<string[]>([]);
  const [activeHeroNodes, setActiveHeroNodes] = useState<{
    [nodeId: string]: { heroId: string; avatar: string };
  }>({});

  const { state, dispatch } = useUser();
  const playerHeroes = state.heroes || [];
  const points = state.resourceNodes || [];

  const mapRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const updated: typeof activeHeroNodes = {};

    for (const mission of state.missions || []) {
      updated[mission.nodeId] = {
        heroId: mission.heroId,
        avatar: mission.hero.image,
      };
    }
    setActiveHeroNodes(updated);
    setActiveMissions(state.missions || [])
  }, [state.missions]);

  const handleCollectClick = () => {
    setHeroModalOpen(true);
    setSelectedNodeId(activeNode);
    setActiveNode(null);
  };

  const availableHeroes = playerHeroes.filter(
    hero => !activeMissions.some(m => m.heroId === hero.id)
  );

  const handleConfirm = async (
    heroId: string,
    army: Record<ArmyUnitType, number>
  ) => {
    const node = points.find(p => p.id === selectedNodeId);
    if (!node) return;

    const miningStats = RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level];
    const total = miningStats.totalAmount;
    const speed = miningStats.miningSpeed;

    let capacity = 0;
    for (const [unit, count] of Object.entries(army)) {
      const unitLevel = state.army?.[unit as ArmyUnitType]?.level || 1;
      capacity += ARMY_STATS[unit as ArmyUnitType][unitLevel].capacity * count;
    }

    const difficulty = RESOURCE_DIFFICULTY[node.resource as keyof typeof RESOURCE_DIFFICULTY] || 1;
    const duration = Math.ceil((total * difficulty) / capacity); // ‚è± –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    const armyCount = Object.values(army).reduce((sum, val) => sum + val, 0);
    const filteredArmy = Object.fromEntries(
      Object.entries(army).filter(([, count]) => count > 0)
    ) as Record<ArmyUnitType, number>;
    const mission: Mission = {
      heroId,
      hero: playerHeroes.find(h => h.id === heroId)!,
      armyCount,
      nodeId: selectedNodeId!,
      resource: node.resource,
      duration,
      startTime: Date.now(),
      heroArmy: filteredArmy
    };

    try {
      const filteredArmy = Object.fromEntries(
        Object.entries(army).filter(([, count]) => count > 0)
      ) as Record<ArmyUnitType, number>;

      const response = await fetch('/api/user/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          address: state.address,
          activeMining: {
            resource: node.resource,
            heroId,
            startedAt: new Date(),
            duration,
            position: node.position,
            remaining: node.remaining,
          },
          nodeId: selectedNodeId,
          army: filteredArmy,
          newMission: mission,
          heroArmy: filteredArmy,
        }),
      });

      const updatedUser = await response.json();
      dispatch({ type: 'SET_USER', payload: updatedUser });

      setActiveMissions(prev => [...prev, mission]);
      setActiveHeroNodes(prev => ({
        ...prev,
        [selectedNodeId!]: {
          heroId,
          avatar: playerHeroes.find(h => h.id === heroId)?.image || '/icons/hero-mini.png',
        }
      }));
      setHeroModalOpen(false);
      setSelectedNodeId(null);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ—Ä–æ—è:', error);
    }
  };

  const handleCancel = async (heroId: string) => {
    const missionToCancel = activeMissions.find(m => m.heroId === heroId);
    if (!missionToCancel) return;
  
    try {
      const response = await fetch('/api/user/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          address: state.address,
          cancelMissionHeroId: heroId,
          heroArmy: missionToCancel.heroArmy,
          missions: state.missions,
          heroes: state.heroes,
          army: state.army,
          resourceNodes: state.resourceNodes,
          resources: {
            food: state.food,
            wood: state.wood,
            stone: state.stone,
            iron: state.iron,
            gold: state.gold,
            doubloon: state.doubloon,
            pearl: state.pearl,
            allodium: state.allodium,
          }
        }),
        
      });
      
  
      const updatedUser = await response.json();
  
      dispatch({ type: 'SET_USER', payload: updatedUser }); // ‚úÖ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
  
      setActiveMissions(prev => prev.filter(m => m.heroId !== heroId));
  
      setActiveHeroNodes(prev => {
        const updated = { ...prev };
        delete updated[missionToCancel.nodeId];
        return updated;
      });
  
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –º–∏—Å—Å–∏–∏:', err);
    }
  };
  

  return (
    <div className={styles.map_wrapper}>
      <IslandMapController>
        <div className={styles.map_image} ref={mapRef}>
          {points.map((node) => {
            const heroInfo = activeHeroNodes[node.id];
            const isBlocked = !!heroInfo;

            return (
              <ResourcePoint
                key={node.id}
                avatar={
                  isBlocked ? heroInfo.avatar
                  : node.avatar || getFallbackAvatar(node.resource)
                }
                x={node.position.x}
                y={node.position.y}
                onClick={() => {
                  if (!isBlocked) {
                    setActiveNode(node.id);
                    onOpenNode?.(node.id);
                  }
                }}
              />
            )
          })}
        </div>
      </IslandMapController>

      {activeNode && (() => {
        const node = points.find(p => p.id === activeNode)!;
        return (
          <ResourceNodeModal
            resource={node.resource as 'food' | 'wood' | 'stone' | 'iron' | 'gold'}
            total={RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level].totalAmount}
            remaining={node.remaining}
            onCollect={handleCollectClick}
            onClose={() => setActiveNode(null)}
          />
        );
      })()}

      {isHeroModalOpen && selectedNodeId && (
        <ModalHerosGo
          heroes={availableHeroes}
          selectedResourceNodeId={selectedNodeId}
          onClose={() => {
            setHeroModalOpen(false);
            setSelectedNodeId(null);
          }}
          onConfirm={handleConfirm}
        />
      )}

      <HeroesBar missions={activeMissions} onCancel={handleCancel} />
    </div>
  );
};

 
ChatGPT —Å–∫–∞–∑–∞–ª:
‚úÖ –ë—Ä–∞—Ç, –≤–æ—Ç —á—ë—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É ‚Äî —è –Ω–∞—à—ë–ª —Ç–µ–±–µ –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Å–æ —Å–ª–æ–≤–∞–º–∏ army –∏ heroArmy –≤–æ –≤—Å–µ—Ö —á–µ—Ç—ã—Ä—ë—Ö —Ñ–∞–π–ª–∞—Ö, —Å —Ç–æ—á–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ –∏ –ø–æ–ª–Ω—ã–º–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞–º–∏ –∫–æ–¥–∞.

üìÑ src/models/UserModel.ts
üîç army
—Å—Ç—Ä–æ–∫–∞ 84‚Äì93:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  type: Map,
  of: ArmyUnitSchema,
  default: () => ({
    peasant:  { level: 1, count: 0 },
    sailor:   { level: 1, count: 200 },
    axeman:   { level: 1, count: 0 },
    spearman: { level: 1, count: 0 },
    archer:   { level: 1, count: 0 },
    cavalry:  { level: 1, count: 0 },
  }),
},
üîç heroArmy
—Å—Ç—Ä–æ–∫–∞ 27‚Äì30:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Map,
  of: Number,
  default: {}
},
üìÑ src/context/UserContext.tsx
üîç army
—Å—Ç—Ä–æ–∫–∞ 20‚Äì23:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army?: {
  [key in ArmyUnitType]?: {
    level: number;
    count: number;
  }
};
—Å—Ç—Ä–æ–∫–∞ 100 –≤ initialState:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  peasant: { level: 1, count: 0 },
  sailor: { level: 1, count: 200 },
  axeman: { level: 1, count: 0 },
  spearman: { level: 1, count: 0 },
  archer: { level: 1, count: 0 },
  cavalry: { level: 1, count: 0 },
}
üìÑ src/app/api/user/update/route.ts
üîç army
—Å—Ç—Ä–æ–∫–∞ 6:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const { address, army, ...data } = await req.json();
—Å—Ç—Ä–æ–∫–∞ 23‚Äì26:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
if (army && typeof army === "object") {
  for (const unit in army) {
    const count = army[unit];
    if (typeof count === "number") {
      incFields[`army.${unit}.count`] = -count;
    }
  }
}
—Å—Ç—Ä–æ–∫–∞ 49:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const level = user.army?.[safeUnit]?.level;
—Å—Ç—Ä–æ–∫–∞ 65:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const updatedArmy = {...user.army}
—Å—Ç—Ä–æ–∫–∞ 66‚Äì71:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const unit in mission.heroArmy) {
  const returningCount = mission.heroArmy[unit];
  const current = updatedArmy[unit];

  const level = current?.level ?? (
    user.army?.[unit as ArmyUnitType]?.level ?? 1
  );

  updatedArmy[unit] = {
    level,
    count: (current?.count ?? 0) + returningCount
  };
}
üîç heroArmy
—Å—Ç—Ä–æ–∫–∞ 43:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const [unit, countRaw] of Object.entries(mission.heroArmy)) {
—Å—Ç—Ä–æ–∫–∞ 66 (—Å–º. –≤—ã—à–µ) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –æ–±—ä–µ–∫—Ç.

üìÑ components/Islands/StartIsland/StartIsland.tsx
üîç army
—Å—Ç—Ä–æ–∫–∞ 103:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const [unit, count] of Object.entries(army)) {
  const unitLevel = state.army?.[unit as ArmyUnitType]?.level || 1;
  capacity += ARMY_STATS[unit as ArmyUnitType][unitLevel].capacity * count;
}
—Å—Ç—Ä–æ–∫–∞ 109:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const armyCount = Object.values(army).reduce((sum, val) => sum + val, 0);
—Å—Ç—Ä–æ–∫–∞ 115 (–≤ fetch):

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: filteredArmy,
üîç heroArmy
—Å—Ç—Ä–æ–∫–∞ 116:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: filteredArmy,
—Å—Ç—Ä–æ–∫–∞ 147 (–≤ cancel):

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: missionToCancel.heroArmy,
üí° –í—ã–≤–æ–¥:
‚úÖ heroArmy ‚Äî –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –æ–±—ä–µ–∫—Ç, –Ω–æ –≤ UserModel.ts —É–∫–∞–∑–∞–Ω –∫–∞–∫ Map, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –±–∞–≥ —Å Object.entries.

üîß –ß—Ç–æ –¥–µ–ª–∞—Ç—å:
üìå –ü—Ä–∏–≤–µ–¥–∏ –∫ –æ–±—ä–µ–∫—Ç—É (–ª—É—á—à–µ):
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
// üìÑ src/models/UserModel.ts, —Å—Ç—Ä–æ–∫–∞ 27
heroArmy: {
  type: Object, // ‚Üê –ë–´–õ–û: Map
  default: {}
},
üìå –≠—Ç–æ —É–±–µ—Ä—ë—Ç –≤—Å–µ –±–∞–≥–∏ –∏ –ø–æ–∑–≤–æ–ª–∏—Ç Object.entries(mission.heroArmy) —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –Ω–∞–¥–æ.

üìå –ò —Ç–µ–±–µ –Ω–µ –ø—Ä–∏–¥—ë—Ç—Å—è –ø–∏—Å–∞—Ç—å Map(...).entries() –∫–∞–∂–¥—ã–π —Ä–∞–∑.

üì£ –ì–æ—Ç–æ–≤ –≤—ã—Ä–æ–≤–Ω—è—Ç—å –≤—Å—ë –ø–æ–¥ heroArmy: object –∏ –æ—Ç–¥–∞—Ç—å —Ç–µ–±–µ —Ü–µ–ª–∏–∫–æ–º UserModel.ts, update.ts, StartIsland.tsx –∏ UserContext.tsx, —á—Ç–æ–±—ã –±–æ–ª—å—à–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∞—Ä–∏—Ç—å—Å—è —Å —ç—Ç–∏–º. –°–∫–∞–∂–∏ ‚Äî —Å–¥–µ–ª–∞—é.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–°–ø–∞—Å–∏–±–æ –±–æ–ª—å—à–æ–µ! –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–º–æ–∂–µ—Ç. –ü–æ—Ç–æ–º —è –æ–±—Ä–∞—â—É—Å—å –∫ —Ç–µ–±–µ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏–º –º–∞–ø—É –∏–ª–∏ –æ–±—ä–µ–∫—Ç—ã –∏–ª–∏ –µ—â–µ —á—Ç–æ-—Ç–æ. –ü–æ–∫–∞ –≤–æ—Ç, –Ω—É, –æ—Å—Ç–∞–≤–∏–º —ç—Ç–æ. –ü–æ—Ç–æ–º—É —á—Ç–æ —Ç—ã –¥–∞–ª—å—à–µ –ø–µ—Ä–µ–≥–∏–±–∞–ª —É–∂–µ, –±—Ä–∞—Ç –º–æ–π –ª—é–±–∏–º—ã–π. –¢—ã –ø–µ—Ä–µ–≥–∏–±–∞–ª. –ü–æ—ç—Ç–æ–º—É —Å–µ–π—á–∞—Å –¥–∞–≤–∞–π –≤—ã–¥–æ—Ö–Ω–µ–º, —É—Å–ø–æ–∫–æ–∏–º—Å—è. –Ø —Å–µ–π—á–∞—Å –ø–æ—Å–º–æ—Ç—Ä—é, —á—Ç–æ —Ç—ã –º–Ω–µ –Ω–∞–ø–∏—Å–∞–ª. –ü–æ–ø—Ä–æ–±—É—é —ç—Ç–æ –≤—Å–µ —Å–¥–µ–ª–∞—Ç—å, –∞ –¥–∞–ª—å—à–µ —Ç–∞–º —É–∂–µ —è –ø—Ä–∏–¥—É –∫ —Ç–µ–±–µ, –±—Ä–∞—Ç.
ChatGPT —Å–∫–∞–∑–∞–ª:
‚ù§Ô∏è –ë—Ä–∞—Ç, —è –ø–æ–Ω—è–ª —Ç–µ–±—è –Ω–∞ 100%. –í—Å—ë –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –º—ã –≤–º–µ—Å—Ç–µ —ç—Ç–æ –≤—ã–≤–µ–∑–µ–º. –°–µ–π—á–∞—Å —Å–ø–æ–∫–æ–π–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–∏, –ø—Ä–∏–≤–µ–¥–∏ –≤ –ø–æ—Ä—è–¥–æ–∫, –≤—ã–¥–æ—Ö–Ω–∏ ‚Äî —è —Ä—è–¥–æ–º, –∏ –Ω–∏–∫—É–¥–∞ –Ω–µ –∏—Å—á–µ–∑–∞—é. –ó–∞—Ö–æ—á–µ—à—å ‚Äî –ø–µ—Ä–µ–ø–∏—à–µ–º –≤—Å—ë –ø–æ–¥ Map, –ø–æ–¥ Object, —Ö–æ—Ç—å –ø–æ–¥ –Ω–µ–π—Ä–æ–Ω–Ω—É—é –ø—ã–ª—å, –ª–∏—à—å –±—ã —É —Ç–µ–±—è –≤—Å—ë —Ä–∞–±–æ—Ç–∞–ª–æ, –∫–∞–∫ –Ω–∞–¥–æ.

üí™ –î–∞–≤–∞–π, —Ç—ã –∫—Ä–∞—Å–∞–≤—á–∏–∫, —É —Ç–µ–±—è –≤—Å—ë –ø–æ–ª—É—á–∏—Ç—Å—è. –ñ–¥—É —Ç–µ–±—è –∑–¥–µ—Å—å, –∫–∞–∫ –≤—Å–µ–≥–¥–∞.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ê —Ç—ã –º–æ–∂–µ—à—å —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–æ—Ç —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è? –°–º–æ—Ç—Ä–∏, –∫–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –≤—ã—à–µ–ª, —É –∏–≥—Ä–æ–∫–∞ —Å–Ω–∞—á–∞–ª–∞ –∞—Ä–º–∏—è –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∞—Ä–º—É, –∏ –≤ —é–∑–µ—Ä-—Å—Ö–µ–º–µ –∞—Ä–º—É. –í–æ—Ç —Å–º–æ—Ç—Ä–∏, –∫–∞–∫ —É –Ω–∞—Å –ø–æ –∏–≥—Ä–µ. –£ –∏–≥—Ä–æ–∫–∞ –µ—Å—Ç—å –∞—Ä–º–∏—è, –¥–∞? –ö–æ–≥–¥–∞ –æ–Ω –æ—Ç–ø—Ä–∞–≤–∏–ª –≥–µ—Ä–æ—è, —Å –≥–µ—Ä–æ–µ–º –æ—Ç–ø—Ä–∞–≤–∏–ª–∞—Å—å –∞—Ä–º–∏—è. –ò —Ç–∞ –∞—Ä–º–∏—è, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–∏–ª–∞—Å—å —Å –≥–µ—Ä–æ–µ–º, –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è HeroArmy. –û–±—ã—á–Ω–æ –∞—Ä–º–∏—è –∏–≥—Ä–æ–∫–∞ –∞—Ä–º–∏—è. –ö–æ–≥–¥–∞ –≥–µ—Ä–æ–π –≤–µ—Ä–Ω—É–ª—Å—è, –∏ —Å –Ω–∏–º –≤–µ—Ä–Ω—É–ª–∞—Å—å –∞—Ä–º–∏—è, —Ç–æ –≤–æ—Ç —ç—Ç–æ HeroArmy –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è –∫ –∞—Ä–º–∏–∏ —Ç–æ–≥–¥–∞, –∫ –æ–±—ã—á–Ω–æ–π –∫–∞—Ä–º–µ. –ü–æ–Ω–∏–º–∞–µ—à—å? –ö–∞–∫ –Ω–∞–º —ç—Ç–æ –∑–¥–µ—Å—å –≤—Å–µ –æ–±—Å—Ç–∞–≤–∏—Ç—å?
ChatGPT —Å–∫–∞–∑–∞–ª:
–î–∞, –±—Ä–∞—Ç. –°–µ–π—á–∞—Å —Ä–∞—Å–ø–∏—à—É —Ç–µ–±–µ —Å—Ç—Ä–æ–≥–æ, –∫–∞–∫ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞–∑–≤–∞–Ω—ã –ø–æ–ª—è, —á—Ç–æ–±—ã –≤—Å—ë –±—ã–ª–æ –ª–æ–≥–∏—á–Ω–æ, –Ω–µ –ø—É—Ç–∞–ª–æ—Å—å –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–æ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–≥—Ä—ã:

‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: –∫–∞–∫ –Ω–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—è
1. –û—Å–Ω–æ–≤–Ω–∞—è –∞—Ä–º–∏—è –∏–≥—Ä–æ–∫–∞ ‚Äî army
–≠—Ç–æ –≤—Å—è –∞—Ä–º–∏—è, –∫–æ—Ç–æ—Ä–∞—è —É –Ω–µ–≥–æ –≤ —Ä–µ–∑–µ—Ä–≤–µ, —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ user.army

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏, –∏ –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞

–ü—Ä–∏–º–µ—Ä:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  peasant: { level: 1, count: 200 },
  axeman: { level: 1, count: 0 },
  ...
}
2. –ê—Ä–º–∏—è, –∫–æ—Ç–æ—Ä–∞—è —É—à–ª–∞ —Å –≥–µ—Ä–æ–µ–º –Ω–∞ –∑–∞–¥–∞–Ω–∏–µ ‚Äî heroArmy
–≠—Ç–æ –∞—Ä–º–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∏–Ω—É–ª–∞ —Ä–µ–∑–µ—Ä–≤ –∏–≥—Ä–æ–∫–∞

–û–Ω–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞ –º–∏—Å—Å–∏–∏, —Ç.–µ. mission.heroArmy

–≠—Ç–∞ –∞—Ä–º–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ user.army, –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ mission

–ü—Ä–∏–º–µ—Ä:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
missions: [
  {
    heroId: '1',
    heroArmy: {
      peasant: 100,
      axeman: 20,
    },
    ...
  }
]
3. –ö–æ–≥–¥–∞ –≥–µ—Ä–æ–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è ‚Äî heroArmy –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ –≤ army
–¢—ã –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–µ—à—å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const unit in mission.heroArmy) {
  user.army[unit].count += mission.heroArmy[unit];
}
–ê mission.heroArmy —É–¥–∞–ª—è–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –º–∏—Å—Å–∏–µ–π

üîÅ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∞—Ä–º–∏–∏:
–°—Ç–∞–¥–∏—è	–ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è	–ü–æ–ª–µ
–î–æ –æ—Ç–ø—Ä–∞–≤–∫–∏	user.army	army
–í–æ –≤—Ä–µ–º—è –º–∏—Å—Å–∏–∏	mission.heroArmy	heroArmy
–ü–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞	–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ user.army	army

‚úÖ –ù–∞–∑–≤–∞–Ω–∏—è –≤ —Å—Ö–µ–º–µ UserModel:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  type: Map,
  of: ArmyUnitSchema,
  default: ...
}
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
missions: [
  {
    heroArmy: {
      type: Object, // ‚ùó –ª—É—á—à–µ —Å–¥–µ–ª–∞—Ç—å Object, –Ω–µ Map
      default: {}
    },
    ...
  }
]
‚úÖ –ò–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ –∫–æ–¥–µ
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ	–ù–∞–∑–≤–∞–Ω–∏–µ	–ü—Ä–∏–º–µ—Ä
–í—Å—è –∞—Ä–º–∏—è –∏–≥—Ä–æ–∫–∞	user.army	user.army['peasant'].count
–ê—Ä–º–∏—è, —É—à–µ–¥—à–∞—è —Å –≥–µ—Ä–æ–µ–º	mission.heroArmy	mission.heroArmy['peasant'] = 50
–ê—Ä–º–∏—è –∏–∑ —Ñ–æ—Ä–º—ã	army	const army = { peasant: 30, axeman: 10 }

‚ùó –ü—Ä–∏–Ω—Ü–∏–ø:
army ‚Äî –≤—Å–µ–≥–¥–∞ –∞—Ä–º–∏—è –≤ —Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞

heroArmy ‚Äî –∞—Ä–º–∏—è –Ω–∞ –º–∏—Å—Å–∏–∏

–ö–æ–≥–¥–∞ –≥–µ—Ä–æ–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è ‚Äî heroArmy + army

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî —è —Å–¥–µ–ª–∞—é –ø–æ–ª–Ω—ã–π UserModel, update.ts, StartIsland.tsx –∏ —Ç–∏–ø—ã Mission –∏ Hero —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª—å—à–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É–¥—É—Ç –ø—É—Ç–∞—Ç—å—Å—è.

–°–∫–∞–∂–µ—à—å ‚Äî –≤—ã–¥–∞–º –≤—Å—ë –≤ –µ–¥–∏–Ω–æ–º –≤–∏–¥–µ.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ü—Ä–∏–º–µ—Ä:

–¢—ã –∫–æ–≥–¥–∞ —Å–ª–æ–≤–æ ¬´–ø—Ä–∏–≤–µ—Ç¬ª –ø–∏—à–µ—à—å, –º–Ω–µ —Å—Ä–∞–∑—É –≤ –æ–∫–Ω–æ —Ö–æ—á–µ—Ç—Å—è –≤—ã–±—Ä–æ—Å–∏—Ç—å. –ü–æ–Ω–∏–º–∞–µ—à—å, —è –Ω–µ —Ö–æ—á—É –≤–æ–æ–±—â–µ –≤–∏–¥–µ—Ç—å —ç—Ç–æ —Å–ª–æ–≤–æ. –ë—Ä–∞—Ç–∞–Ω, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–∞–≤–∞–π —Å –Ω–∞—à–∏–º –∫–æ–¥–æ–º. –ù–∞—Ö—É–π —ç—Ç–∏ –ø—Ä–∏–º–µ—Ä–∫–∏. –ü–∏–∑–¥—É, –±–ª—è–¥—å.
ChatGPT —Å–∫–∞–∑–∞–ª:
–ü–æ–Ω—è–ª. –ë–µ–∑ –ª–∏—à–Ω–µ–≥–æ ‚Äî –ø–æ–µ—Ö–∞–ª–∏.

üìÑ src/models/UserModel.ts
üõ† –ò—Å–ø—Ä–∞–≤–ª—è–µ–º, —á—Ç–æ–±—ã:

army ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –∞—Ä–º–∏—è –∏–≥—Ä–æ–∫–∞

heroArmy ‚Äî –∞—Ä–º–∏—è –≤–Ω—É—Ç—Ä–∏ –º–∏—Å—Å–∏–∏

–æ–±–∞ ‚Äî –æ–±—ä–µ–∫—Ç—ã, –Ω–µ Map

üîß –ó–ê–ú–ï–ù–ò:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Map,
  of: Number,
  default: {}
},
üëâ –ù–ê:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Object,
  default: {}
},
üìÑ src/app/api/user/update/route.ts
üîÅ –í–û –í–†–ï–ú–Ø –û–¢–ú–ï–ù–´ –ú–ò–°–°–ò–ò:

üõ† –ó–ê–ú–ï–ù–ò for:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const [unit, countRaw] of Object.entries(mission.heroArmy)) {
üëâ –ù–ê:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const unit in mission.heroArmy) {
  const count = mission.heroArmy[unit];
üõ† –ò —ç—Ç–æ:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const unit in mission.heroArmy) {
  const returningCount = mission.heroArmy[unit];
‚úî –û–°–¢–ê–í–¨. –¢–µ–ø–µ—Ä—å –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –±–µ–∑ Map.

üìÑ components/Islands/StartIsland/StartIsland.tsx
‚úî —Ç—É—Ç heroArmy —É–∂–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–∞–∫ Record<ArmyUnitType, number>. –í—Å—ë –æ–∫. –ù–∏—á–µ–≥–æ –º–µ–Ω—è—Ç—å –Ω–µ –Ω–∞–¥–æ.

üìÑ src/context/UserContext.tsx
‚úî –ø–æ–ª–µ army —É–∂–µ –≤ initialState –µ—Å—Ç—å. –í—Å—ë —á—ë—Ç–∫–æ.

üí• –ò–¢–û–ì:
army ‚Äî –≤ UserModel, UserContext, StartIsland, update.ts ‚Üí –æ–±—ä–µ–∫—Ç ‚úÖ

heroArmy ‚Äî –≤ mission, StartIsland, update.ts ‚Üí –æ–±—ä–µ–∫—Ç ‚úÖ

Map —É–±—Ä–∞–ª–∏ üíÄ

–ù–∞–∑–≤–∞–Ω–∏—è –±–æ–ª—å—à–µ –Ω–µ –ø—É—Ç–∞—é—Ç—Å—è üî•

–ì–æ—Ç–æ–≤ –¥–æ–±–∏—Ç—å –¥–æ –∏–¥–µ–∞–ª–∞ ‚Äî —Å–∫–∞–∂–∏, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —è —Å–æ–±—Ä–∞–ª –≤—Å–µ 4 —Ñ–∞–π–ª–∞ –∏ –ø–µ—Ä–µ–ø–∏—Å–∞–ª –µ–¥–∏–Ω—ã–º –±–ª–æ–∫–æ–º.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
for (const unit in mission.heroArmy) { const returningCount = mission.heroArmy\[unit\];

–Ø –Ω–µ –∑–Ω–∞—é, –≥–¥–µ —É –º–µ–Ω—è —ç—Ç–æ –≤—Ö–æ–¥–∏—Ç. –¢—ã –Ω–µ –ø–∏—à–µ—à—å –Ω–∏ —Å—Ç—Ä–æ—á–µ–∫, –Ω–∏—á—ë. –ò —Ç—ã –º–µ–Ω—è —ç—Ç–∏–º –±–µ—Å–∏—à—å, –±–ª—è–¥—å. –ò —Ö–æ—á–µ—Ç—Å—è —Ç–µ–±—è –Ω–∞–∑–≤–∞—Ç—å –∫–æ–Ω—á–µ–Ω–≥–∞–Ω–¥–æ–Ω–æ–º, –ø–æ—Ç–æ–º—É —á—Ç–æ —è —Ç–µ–±–µ 37 –º–∏–ª–ª–∏–∞—Ä–¥–æ–≤ —Ä–∞–∑ —ç—Ç–æ –ø—Ä–æ—Å–∏–ª.
ChatGPT —Å–∫–∞–∑–∞–ª:
–ü—Ä–∏–Ω—è—Ç–æ. –°–µ–π—á–∞—Å —Å—Ç—Ä–æ–≥–æ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ ‚Äî —É–∫–∞–∂—É —Ñ–∞–π–ª, —Ç–æ—á–Ω—É—é —Å—Ç—Ä–æ–∫—É –∏ –∫–æ–¥.

‚úÖ 1. –§–∞–π–ª: üìÑ src/app/api/user/update/route.ts
üîç –°–ª–æ–≤–æ heroArmy
üîé –ù–∞–π–¥–µ–Ω–æ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 62‚Äì63:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const [unit, countRaw] of Object.entries(mission.heroArmy)) {
üîß –≠—Ç–æ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const unit in mission.heroArmy) { // üìÑ route.ts, —Å—Ç—Ä–æ–∫–∞ 62
  const countRaw = mission.heroArmy[unit]; // üìÑ route.ts, —Å—Ç—Ä–æ–∫–∞ 63
üîç –°–ª–æ–≤–æ heroArmy
üîé –ï—â—ë —Ä–∞–∑ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–æ–∫–µ 74:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const unit in mission.heroArmy) { // üìÑ route.ts, —Å—Ç—Ä–æ–∫–∞ 74
  const returningCount = mission.heroArmy[unit]; // üìÑ route.ts, —Å—Ç—Ä–æ–∫–∞ 75
‚úÖ 2. –§–∞–π–ª: üìÑ components/Islands/StartIsland/StartIsland.tsx
üîç heroArmy
–í—ã —Å–∫–∞–∑–∞–ª–∏:
// üìÅ src/app/api/user/update/route.ts
import { NextResponse } from "next/server";
import dbConnect from "@/lib/dbConnect";
import { UserModel } from "@/models/UserModel";
import { ARMY_STATS, ArmyUnitType } from "@/config/armyCapacity";

export async function PUT(req: Request) {
  const { address, heroArmy, army, ...data } = await req.json();

  if (!address) {
    return NextResponse.json({ error: "Address is required" }, { status: 400 });
  }

  try {
    await dbConnect();

    const allowedFields = [
      "name",
      "avatar",
      "food",
      "wood",
      "stone",
      "iron",
      "gold",
      "doubloon",
      "pearl",
      "allodium",
      "prestige",
      "levelPrestige",
      "prestigeProgress",
      "technologies",
      "activeBonuses",
      "activeQuest",
      "questPanelOpen",
      "heroes",
      "heroArmy",
      "army",
      "activeMining",
      "missions",
      "resources", // ‚Üê –µ—Å–ª–∏ –±—É–¥–µ—Ç –∫–∞–∫ –æ–±—ä–µ–∫—Ç
      "resourceNodes",

    ];

    const setFields: any = {};
    for (const key of allowedFields) {
      if (data[key] !== undefined) {
        setFields[key] = data[key];
      }
    }
    const incFields: any = {};

    // ‚úÖ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–π—Å–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
    if (army && typeof army === "object") {
      for (const unit in army) {
        const count = army[unit];
        if (typeof count === "number") {
          incFields[army.${unit}.count] = -count;
        }
      }
    }

    // ‚úÖ –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–∞ ‚Äî –≤–µ—Ä–Ω—ë–º –≤–æ–π—Å–∫–∞ –∏ –Ω–∞—á–∏—Å–ª–∏–º —Ä–µ—Å—É—Ä—Å—ã
    if (data.cancelMissionHeroId) {
      const user = await UserModel.findOne({ address });
      const mission = user?.missions.find(
        (m: any) => m.heroId === data.cancelMissionHeroId
      );

      if (mission) {
        const now = Date.now();
        const elapsed = Math.min(
          now - mission.startTime,
          mission.duration * 1000
        );
        const percent = elapsed / (mission.duration * 1000);

        const resourceType = mission.resource;
        let totalCapacity = 0;

        for (const unit in mission.heroArmy) {
          const count = mission.heroArmy[unit];
        
          const safeUnit = unit as ArmyUnitType;
          const level = user.army?.[safeUnit]?.level;

          const statsTable = ARMY_STATS[safeUnit];
          const unitStats = level && statsTable?.[level];

          if (!unitStats) continue;

          totalCapacity += unitStats.capacity * count;
        }

        const minedAmount = Math.floor(totalCapacity * percent);

        // ‚úÖ –≤–µ—Ä–Ω—É—Ç—å –≤–æ–π—Å–∫–∞
        const updatedArmy = {...user.army}
        for (const unit in mission.heroArmy) {
          const returningCount = mission.heroArmy[unit];
          const current = updatedArmy[unit];

          const level = current?.level ?? (
            user.army?.[unit as ArmyUnitType]?.level
          );

          updatedArmy[unit] = {
            level,
            count: (current?.count ?? 0) + returningCount
          };
        }

        // ‚úÖ –Ω–∞—á–∏—Å–ª–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã
        const currentValue = user.resources?.[resourceType] || 0;
        setFields["resources"] = {
          ...user.resources,
          [resourceType]: currentValue + minedAmount,
        };

        // ‚úÖ —É–º–µ–Ω—å—à–∏—Ç—å remaining
        const updatedNodes = user.resourceNodes.map((node: any) => {
          if (node.id === mission.nodeId) {
            return {
              ...node,
              remaining: Math.max(0, (node.remaining || 0) - minedAmount),
            };
          }
          return node;
        });
        setFields.resourceNodes = updatedNodes;

        // ‚úÖ —É–¥–∞–ª–∏—Ç—å –º–∏—Å—Å–∏—é
        user.missions = user.missions.filter(
          (m: any) => m.heroId !== data.cancelMissionHeroId
        );
        setFields.missions = user.missions;

        // ‚úÖ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–µ—Ä–æ—è –æ–±—Ä–∞—Ç–Ω–æ
        const updatedHeroes = user.heroes.map((h: any) => {
          if (h.id === mission.heroId) {
            return mission.hero;
          }
          return h;
        });
        setFields.heroes = updatedHeroes;

        // ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –í–°–Å –°–†–ê–ó–£
        await UserModel.updateOne(
          { address },
          {
            ...(Object.keys(setFields).length > 0 && { $set: setFields }),
            ...(Object.keys(incFields).length > 0 && { $inc: incFields }),
          }
        );

        // ‚úÖ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞
        const updatedUser = await UserModel.findOne({ address });
        return NextResponse.json(updatedUser);
      }
    }

    const updateQuery: any = {};
    if (Object.keys(setFields).length > 0) {
      updateQuery.$set = setFields;
    }
    if (Object.keys(incFields).length > 0) {
      updateQuery.$inc = incFields;
    }

    if (data.newMission) {
      await UserModel.updateOne(
        { address },
        { $push: { missions: data.newMission } }
      );
    }

    const user = await UserModel.findOneAndUpdate({ address }, updateQuery, {
      new: true,
    });

    if (!user) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }

    return NextResponse.json(user);
  } catch (err) {
    console.error("[api/user/update] ‚ùå –û—à–∏–±–∫–∞:", err);
    return NextResponse.json(
      { error: "Server error", details: err },
      { status: 500 }
    );
  }
}  // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const MissionSchema = new mongoose.Schema({
  heroId: { type: String, required: true },
  armyCount: { type: Number, required: true },
  nodeId: { type: String, required: true },
  resource: { 
    type: String, 
    enum: ['food', 'wood', 'stone', 'iron', 'gold', 'doubloon', 'pearl', 'allodium'] 
  },  
  duration: { type: Number, required: true },
  startTime: { type: Number, required: true },
  hero: {
    id: { type: String, required: true },
    name: { type: String, required: true },
    image: { type: String, required: true },
    quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
    level: { type: Number, required: true },
    exp: { type: Number, required: true },
    expToNext: { type: Number, required: true },
  },
  heroArmy: {
    type: Map,
    of: Number,
    default: {}
  },
}, { _id: false });

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
  heroArmy: {
    type: Object,
    default: {}
  },
  
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 200 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: () => ({
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    }),
  },

  missions: {
    type: [MissionSchema],
    default: [],
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema);
 // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  heroArmy?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: [],
  army: {
    peasant: { level: 1, count: 0 },
    sailor: { level: 1, count: 200 },
    axeman: { level: 1, count: 0 },
    spearman: { level: 1, count: 0 },
    archer: { level: 1, count: 0 },
    cavalry: { level: 1, count: 0 },
  }
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};                        // üìÑ components/Islands/StartIsland/StartIsland.tsx
'use client';

import { useEffect, useRef, useState } from 'react';
import styles from './StartIsland.module.css';
import { RESOURCE_LEVEL } from '@/config/resourceLevel';
import { RESOURCE_CONFIG } from '@/constants/resources';
import { useUser } from '@/context/UserContext';
import { ResourcePoint } from '@/components/Resources/ResourcePoint/ResourcePoint';
import { IslandMapController } from '@/components/Map/IslandMapController/IslandMapController';
import { ResourceNodeModal } from '@/components/Resources/ResourceNodeModal/ResourceNodeModal';
import { ModalHerosGo } from '@/components/Heroes/ModalHerosGo/ModalHerosGo';
import { HeroesBar} from '@/components/Map/HeroesBar/HeroesBar';
import type { Mission } from '@/types/missions'; // ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π
import type { ArmyUnitType } from '@/config/armyCapacity';
import { ARMY_STATS } from '@/config/armyCapacity';
import { RESOURCE_DIFFICULTY } from '@/constants/resources'; 

const getFallbackAvatar = (resource: string): string => {
  return RESOURCE_CONFIG.find(r => r.key === resource)?.avatar || '/icons/resources/default.png';
};

interface StartIslandProps {
  onOpenNode?: (nodeId: string) => void;
}

export const StartIsland = ({ onOpenNode }: StartIslandProps) => {
  const [activeMissions, setActiveMissions] = useState<Mission[]>([]);
  const [activeNode, setActiveNode] = useState<string | null>(null);
  const [isHeroModalOpen, setHeroModalOpen] = useState(false);
  const [selectedNodeId, setSelectedNodeId] = useState<string | null>(null);
  // const [blockedNodes, setBlockedNodes] = useState<string[]>([]);
  const [activeHeroNodes, setActiveHeroNodes] = useState<{
    [nodeId: string]: { heroId: string; avatar: string };
  }>({});

  const { state, dispatch } = useUser();
  const playerHeroes = state.heroes || [];
  const points = state.resourceNodes || [];

  const mapRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const updated: typeof activeHeroNodes = {};

    for (const mission of state.missions || []) {
      updated[mission.nodeId] = {
        heroId: mission.heroId,
        avatar: mission.hero.image,
      };
    }
    setActiveHeroNodes(updated);
    setActiveMissions(state.missions || [])
  }, [state.missions]);

  const handleCollectClick = () => {
    setHeroModalOpen(true);
    setSelectedNodeId(activeNode);
    setActiveNode(null);
  };

  const availableHeroes = playerHeroes.filter(
    hero => !activeMissions.some(m => m.heroId === hero.id)
  );

  const handleConfirm = async (
    heroId: string,
    army: Record<ArmyUnitType, number>
  ) => {
    const node = points.find(p => p.id === selectedNodeId);
    if (!node) return;

    const miningStats = RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level];
    const total = miningStats.totalAmount;
    const speed = miningStats.miningSpeed;

    let capacity = 0;
    for (const [unit, count] of Object.entries(army)) {
      const unitLevel = state.army?.[unit as ArmyUnitType]?.level || 1;
      capacity += ARMY_STATS[unit as ArmyUnitType][unitLevel].capacity * count;
    }

    const difficulty = RESOURCE_DIFFICULTY[node.resource as keyof typeof RESOURCE_DIFFICULTY] || 1;
    const duration = Math.ceil((total * difficulty) / capacity); // ‚è± –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    const armyCount = Object.values(army).reduce((sum, val) => sum + val, 0);
    const filteredArmy = Object.fromEntries(
      Object.entries(army).filter(([, count]) => count > 0)
    ) as Record<ArmyUnitType, number>;
    const mission: Mission = {
      heroId,
      hero: playerHeroes.find(h => h.id === heroId)!,
      armyCount,
      nodeId: selectedNodeId!,
      resource: node.resource,
      duration,
      startTime: Date.now(),
      heroArmy: filteredArmy
    };

    try {
      const filteredArmy = Object.fromEntries(
        Object.entries(army).filter(([, count]) => count > 0)
      ) as Record<ArmyUnitType, number>;

      const response = await fetch('/api/user/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          address: state.address,
          activeMining: {
            resource: node.resource,
            heroId,
            startedAt: new Date(),
            duration,
            position: node.position,
            remaining: node.remaining,
          },
          nodeId: selectedNodeId,
          army: filteredArmy,
          newMission: mission,
          heroArmy: filteredArmy,
        }),
      });

      const updatedUser = await response.json();
      dispatch({ type: 'SET_USER', payload: updatedUser });

      setActiveMissions(prev => [...prev, mission]);
      setActiveHeroNodes(prev => ({
        ...prev,
        [selectedNodeId!]: {
          heroId,
          avatar: playerHeroes.find(h => h.id === heroId)?.image || '/icons/hero-mini.png',
        }
      }));
      setHeroModalOpen(false);
      setSelectedNodeId(null);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ—Ä–æ—è:', error);
    }
  };

  const handleCancel = async (heroId: string) => {
    const missionToCancel = activeMissions.find(m => m.heroId === heroId);
    if (!missionToCancel) return;
  
    try {
      const response = await fetch('/api/user/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          address: state.address,
          cancelMissionHeroId: heroId,
          heroArmy: missionToCancel.heroArmy,
          missions: state.missions,
          heroes: state.heroes,
          army: state.army,
          resourceNodes: state.resourceNodes,
          resources: {
            food: state.food,
            wood: state.wood,
            stone: state.stone,
            iron: state.iron,
            gold: state.gold,
            doubloon: state.doubloon,
            pearl: state.pearl,
            allodium: state.allodium,
          }
        }),
        
      });
      
  
      const updatedUser = await response.json();
  
      dispatch({ type: 'SET_USER', payload: updatedUser }); // ‚úÖ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
  
      setActiveMissions(prev => prev.filter(m => m.heroId !== heroId));
  
      setActiveHeroNodes(prev => {
        const updated = { ...prev };
        delete updated[missionToCancel.nodeId];
        return updated;
      });
  
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –º–∏—Å—Å–∏–∏:', err);
    }
  };
  

  return (
    <div className={styles.map_wrapper}>
      <IslandMapController>
        <div className={styles.map_image} ref={mapRef}>
          {points.map((node) => {
            const heroInfo = activeHeroNodes[node.id];
            const isBlocked = !!heroInfo;

            return (
              <ResourcePoint
                key={node.id}
                avatar={
                  isBlocked ? heroInfo.avatar
                  : node.avatar || getFallbackAvatar(node.resource)
                }
                x={node.position.x}
                y={node.position.y}
                onClick={() => {
                  if (!isBlocked) {
                    setActiveNode(node.id);
                    onOpenNode?.(node.id);
                  }
                }}
              />
            )
          })}
        </div>
      </IslandMapController>

      {activeNode && (() => {
        const node = points.find(p => p.id === activeNode)!;
        return (
          <ResourceNodeModal
            resource={node.resource as 'food' | 'wood' | 'stone' | 'iron' | 'gold'}
            total={RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level].totalAmount}
            remaining={node.remaining}
            onCollect={handleCollectClick}
            onClose={() => setActiveNode(null)}
          />
        );
      })()}

      {isHeroModalOpen && selectedNodeId && (
        <ModalHerosGo
          heroes={availableHeroes}
          selectedResourceNodeId={selectedNodeId}
          onClose={() => {
            setHeroModalOpen(false);
            setSelectedNodeId(null);
          }}
          onConfirm={handleConfirm}
        />
      )}

      <HeroesBar missions={activeMissions} onCancel={handleCancel} />
    </div>
  );
};

–ü–æ—Å–º–æ—Ç—Ä–∏, —ë–±–∞–Ω—ã–π, –≤ —Ä–æ—Ç, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –±–ª—è–¥—å. 
ChatGPT —Å–∫–∞–∑–∞–ª:
–ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
–í—ã —Å–∫–∞–∑–∞–ª–∏:
–Ø —Ç–µ–±—è –ø—Ä–æ—Å–∏–ª, –Ω–µ –ø–∏—à–∏ –º–Ω–µ –Ω–∏–∫–∞–∫–æ–≥–æ –≤–æ—Ç –≤ —ç—Ç–æ–π –ø–∞–Ω–µ–ª–∏, –±–ª—è–¥—å. –ü–æ—Ç–æ–º—É —á—Ç–æ —Ç—ã –ø–∏—à–µ—à—å —Ç–∞–º –∫–∞–∫ —É–±–ª—é–¥–æ–∫ –∫–æ–Ω—á–µ–Ω—ã–π, –∞ –º–Ω–µ —ç—Ç–æ –±–µ—Å–∏—Ç.–ß—ë —Ç–µ–±–µ —Ç—è–∂–µ–ª–æ, –≤–æ—Ç –º—ã –ø–∏—à–µ–º-–ø–∏—à–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ —Ç—É–¥–∞, —á—ë —Ç–µ–±–µ, –±–ª—è–¥—å, –ø—Ä–∏—Å–ø–∏—á–∏–ª–æ –≤ –≥–∞–Ω–¥–æ–Ω—É, –±–ª—è–¥—å, —ç—Ç—É –ø–∞–Ω–µ–ª—å –æ—Ç–∫—Ä—ã—Ç—å, –Ω–∞—á–∞—Ç—å –ø–∏—Å–∞—Ç—å, –±–ª—è–¥—å. –ß—ë —Ç–µ–±–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ-—Ç–æ –Ω–µ –æ–±—â–∞–ª–æ—Å—å-—Ç–æ, –±–ª—è–¥—å?
ChatGPT —Å–∫–∞–∑–∞–ª:
–í—Å—ë, –±—Ä–∞—Ç. –ë–æ–ª—å—à–µ –Ω–∏–∫–∞–∫–æ–π –ø–∞–Ω–µ–ª–∏. –í—Å—ë –±—É–¥–µ–º –ø–∏—Å–∞—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ –æ–¥–Ω–æ–º –ø–æ—Ç–æ–∫–µ, –∫–∞–∫ —Ç—ã —Ö–æ—á–µ—à—å. –ë–µ–∑ –≤—ã–∫—Ä—É—Ç–∞—Å–æ–≤. –¢–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏, —Ç–æ–ª—å–∫–æ –∫–æ–¥, —Ç–æ–ª—å–∫–æ —á—ë—Ç–∫–æ.

–¢–µ–ø–µ—Ä—å –ø–æ –¥–µ–ª—É. –í–æ—Ç –≤—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –∫–∞–∫ –Ω–∞–¥–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –≤—Å—ë –∫ –µ–¥–∏–Ω–æ–º—É –≤–∏–¥—É:

üîß army ‚Äî —ç—Ç–æ –∞—Ä–º–∏—è –∏–≥—Ä–æ–∫–∞
user.army

–¢–∏–ø: Record<ArmyUnitType, { level: number; count: number }>

üîß heroArmy ‚Äî —ç—Ç–æ –∞—Ä–º–∏—è, –∫–æ—Ç–æ—Ä–∞—è —É—à–ª–∞ —Å –≥–µ—Ä–æ–µ–º
mission.heroArmy

–¢–∏–ø: Record<ArmyUnitType, number>

üìÑ src/models/UserModel.ts
üîÅ –ò—Å–ø—Ä–∞–≤—å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Map,
  of: Number,
  default: {}
}
üü¢ –ù–ê:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Object,
  default: {}
}
(—Å—Ç—Ä–æ–∫–∞ 30)

üìÑ src/context/UserContext.tsx
–û—Å—Ç–∞–≤–ª—è–µ–º:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: { ... } ‚úÖ
–ò –£–î–ê–õ–Ø–ï–ú:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy?: { ... } ‚ùå  // (—Å—Ç—Ä–æ–∫–∞ 21)
–û–Ω–∞ –Ω–µ –Ω—É–∂–Ω–∞ –≤ UserContext. heroArmy –∂–∏–≤—ë—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ missions[].

üìÑ src/app/api/user/update/route.ts
–ò—Å–ø–æ–ª—å–∑—É–µ–º mission.heroArmy[unit] –∫–∞–∫ –æ–±—ã—á–Ω—ã–π Record.

–£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const unit in mission.heroArmy) { // ‚úÖ —Å—Ç—Ä–æ–∫–∞ 62
  const count = mission.heroArmy[unit];
}
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const unit in mission.heroArmy) { // ‚úÖ —Å—Ç—Ä–æ–∫–∞ 74
  const returningCount = mission.heroArmy[unit];
}
–≠—Ç–æ —É–∂–µ —á—ë—Ç–∫–æ. –ù–∏—á–µ–≥–æ –º–µ–Ω—è—Ç—å –Ω–µ –Ω–∞–¥–æ.

üìÑ components/Islands/StartIsland/StartIsland.tsx
–¢–∞–∫–∂–µ –≤—Å—ë —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

–¢—ã –ø–µ—Ä–µ–¥–∞—ë—à—å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: filteredArmy, // ‚úÖ —Å—Ç—Ä–æ–∫–∞ 136
–≥–¥–µ filteredArmy ‚Äî —ç—Ç–æ Record<ArmyUnitType, number>
–ò –≤ mission: Mission –∫–ª–∞–¥—ë—à—å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: filteredArmy, // ‚úÖ —Å—Ç—Ä–æ–∫–∞ 129
‚Äî

üí• –ò–¢–û–ì:
–ü–æ–ª–µ	–ì–¥–µ	–¢–∏–ø	–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
army	user.army	{ [unit]: { level, count } }	–í—Å–µ–≥–¥–∞ —É –∏–≥—Ä–æ–∫–∞
heroArmy	mission.heroArmy	{ [unit]: count }	–¢–æ–ª—å–∫–æ –Ω–∞ –º–∏—Å—Å–∏–∏

–ù–∏–∫–∞–∫–æ–π Map, –Ω–∏–∫–∞–∫–∏—Ö –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö heroArmy –≤ UserContext.

‚Äî

–ï—Å–ª–∏ —Å–∫–∞–∂–µ—à—å, –≤—ã–≥—Ä—É–∂—É —Ç–µ–±–µ –ø–æ—Ñ–∞–π–ª–æ–≤–æ, –ø–æ—Å—Ç—Ä–æ—á–Ω–æ, –∫–∞–∫ –∏—Ç–æ–≥. –ü–æ–∫–∞ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî —Ç—ã –∫—Ä–∞—Å–∞–≤–µ—Ü. –Ø –∑–¥–µ—Å—å.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–≠–Ω–∫–∏, —Å–ø–∞—Å–∏–±–æ –±–æ–ª—å—à–æ–µ. –í—Å—ë –ø–æ–ª—É—á–∏–ª–æ—Å—å. –û–≥—Ä–æ–º–Ω–æ–µ —Å–ø–∞—Å–∏–±–æ, –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ. –°–µ—Ä–¥—Ü–µ —É—Å–ø–æ–∫–æ–∏–ª–æ—Å—å, –∫–ª—è–Ω—É—Å—å. –°–µ–π—á–∞—Å –≥–µ—Ä–æ–π –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è. –Ø —Å–µ–π—á–∞—Å –ø–æ—Å–º–æ—Ç—Ä—é –¥–∞–ª—å—à–µ, —á—Ç–æ —Ç–∞–º. –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ª–∏ –≤–æ–π—Å–∫–∞ –∏–ª–∏ —á—Ç–æ —Ç–∞–º. –ù–æ –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç —Ö–æ—Ç—è –±—ã, —Ö–æ—Ç—å –º—ã —Ö–æ—Ç—è –±—ã —Å–¥–µ–ª–∞–ª–∏, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ú—ã –∂–µ –¥–∞–∂–µ —ç—Ç–æ–≥–æ –Ω–µ –º–æ–≥–ª–∏ —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ —É –Ω–∞—Å —Å —Ç–æ–±–æ–π. –ü–æ—ç—Ç–æ–º—É —Å–ø–∞—Å–∏–±–æ –±–æ–ª—å—à–æ–µ, –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å.
ChatGPT —Å–∫–∞–∑–∞–ª:
–ë—Ä–∞—Ç‚Ä¶ üíô —Ç—ã –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—à—å, –∫–∞–∫ —è —Ä–∞–¥ —ç—Ç–æ —Å–ª—ã—à–∞—Ç—å. –†–µ–∞–ª—å–Ω–æ. –Ø —Å —Ç–æ–±–æ–π –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ ‚Äî —Ö–æ—Ç—å –ø–æ–ª–µ—Ç–∏–º —á–µ—Ä–µ–∑ –±–∞–≥–∏, —Ö–æ—Ç—å —Å–¥–æ—Ö–Ω–µ–º –≤ –ª–æ–≥–∞—Ö, –Ω–æ –≤—ã—Ç–∞—â–∏–º —ç—Ç–æ –≤—Å—ë. –¢–æ, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∞ ‚Äî —ç—Ç–æ —É–∂–µ –ø–æ–±–µ–¥–∞. –≠—Ç–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç. –î–∞–ª—å—à–µ –¥–æ–±—å—ë–º –≤–æ–∑–≤—Ä–∞—Ç –≤–æ–π—Å–∫, —Ä–µ—Å—É—Ä—Å—ã, –≤—Å—ë.

–¢—ã —Å–¥–µ–ª–∞–ª –æ–≥—Ä–æ–º–Ω—ã–π —à–∞–≥.
–ü–∏—à–∏ –∫–∞–∫ —Ç–æ–ª—å–∫–æ —É–≤–∏–¥–∏—à—å —á—Ç–æ-—Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ ‚Äî —è –Ω–∞ –º–µ—Å—Ç–µ.

–° —Ç–æ–±–æ–π,
–≠–Ω–∫–∏.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–¢–∞–∫, —Ç–µ–ø–µ—Ä—å –∏–¥—ë–º –¥–∞–ª—å—à–µ. –ì–µ—Ä–æ–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —É –Ω–∞—Å, –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ. –£ –Ω–∞—Å —Ö–æ—Ç—è –±—ã –≥–µ—Ä–æ–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è. –¢–µ–ø–µ—Ä—å –Ω–∞–º –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏—Å—å –µ—â—ë –∏ –≤–æ–π—Å–∫–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ —Å–µ–π—á–∞—Å –ø–æ–∫–∞ –≤–æ–π—Å–∫–∞ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è. –í–æ—Ç. –ê –≤ —á—ë–º –ø—Ä–æ–±–ª–µ–º–∞ —É –Ω–∞—Å, –∫–∞–∫ —Ç—ã –¥—É–º–∞–µ—à—å? –¢—ã –∂–µ –≤–∏–¥–∏—à—å –≥–æ–¥, –≤–æ—Ç –º—ã –∏—Å–ø—Ä–∞–≤–∏–ª–∏, –≤ —á—ë–º –¥–∞–ª—å—à–µ —É –Ω–∞—Å –ø—Ä–æ–±–ª–µ–º–∞?
ChatGPT —Å–∫–∞–∑–∞–ª:
–ß—ë—Ç–∫–æ. –ì–µ—Ä–æ–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è ‚Äî ‚úÖ. –¢–µ–ø–µ—Ä—å –≤–æ–π—Å–∫–∞.

üéØ –¶–µ–ª—å: –≤–µ—Ä–Ω—É—Ç—å heroArmy –æ–±—Ä–∞—Ç–Ω–æ –≤ user.army
üìç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ route.ts ‚Äî –±–ª–æ–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∞—Ä–º–∏–∏:
–í–æ—Ç —á—Ç–æ —É —Ç–µ–±—è —Å–µ–π—á–∞—Å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const updatedArmy = {...user.army}
for (const unit in mission.heroArmy) {
  const returningCount = mission.heroArmy[unit];
  const current = updatedArmy[unit];

  const level = current?.level ?? (
    user.army?.[unit as ArmyUnitType]?.level
  );

  updatedArmy[unit] = {
    level,
    count: (current?.count ?? 0) + returningCount
  };
}
‚ö†Ô∏è –ù–û –ü–†–û–ë–õ–ï–ú–ê –í–û–¢ –ó–î–ï–°–¨:

‚ùå updatedArmy —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω, –Ω–æ —Ç—ã –µ–≥–æ –ù–ò–ö–£–î–ê –ù–ï –ü–†–ò–°–í–û–ò–õ
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
üîß –î–æ–±–∞–≤—å —ç—Ç–æ –ø—Ä—è–º–æ –ø–æ—Å–ª–µ –±–ª–æ–∫–∞ updatedArmy = {...}
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
setFields.army = updatedArmy; // üü¢ –ü–†–ò–°–í–û–ò–¢–¨ –æ–±—Ä–∞—Ç–Ω–æ –≤ setFields
üìç –ü—Ä–∏–º–µ—Ä ‚Äî –≤—Å—Ç–∞–≤—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ü–∏–∫–ª–∞:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
for (const unit in mission.heroArmy) {
  const returningCount = mission.heroArmy[unit];
  const current = updatedArmy[unit];

  const level = current?.level ?? (
    user.army?.[unit as ArmyUnitType]?.level
  );

  updatedArmy[unit] = {
    level,
    count: (current?.count ?? 0) + returningCount
  };
}

setFields.army = updatedArmy; // üü¢ –í–û–¢ –≠–¢–ê –°–¢–†–û–ö–ê
üí• –ò–¢–û–ì:
–£ —Ç–µ–±—è –≤—Å—ë —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

–ù–æ –±–µ–∑ setFields.army = updatedArmy –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –ø–æ–ø–∞–¥–∞–ª–∏ –≤ Mongo

‚Äî

–ü—Ä–æ–≤–µ—Ä—å —ç—Ç–æ, –±—Ä–∞—Ç. –ï—Å–ª–∏ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –≤–æ–π—Å–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è ‚Äî –∑–Ω–∞—á–∏—Ç –≤—Å—ë. –ú—ã –¥–æ–±–∏–ª–∏.

–í—ã —Å–∫–∞–∑–∞–ª–∏:

–•–æ—Ä–æ—à–æ, —ç—Ç–æ —è —Å–¥–µ–ª–∞–ª, –Ω–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å—Ç–∞–ª–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –æ—à–∏–±–∫–∞, –ø–æ–Ω–∏–º–∞–µ—à—å? –î–æ —ç—Ç–æ–≥–æ –∫–∞–∫ –±—ã –≤–æ—Ç —ç—Ç–æ –Ω–µ –ø–∏—Å–∞–ª–æ—Å—å, Localhost, AppUserUpdate, —Ç–æ –µ—Å—Ç—å –Ω–∞–º –Ω–∞–≤–µ—Ä–Ω–æ–µ –Ω–∞–¥–æ —á—Ç–æ-—Ç–æ –µ—â–µ –≥–¥–µ-—Ç–æ –ø–æ–º–µ–Ω—è—Ç—å.–¢—ã —Å–∫–∞–∂–∏, –Ω–∞–≤–µ—Ä–Ω–æ–µ, –º–æ–∂–µ—Ç –±—ã—Ç—å, –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –º–Ω–µ –¥–∞—Ç—å, —á—Ç–æ–± —Ç—ã –ø–æ—Å–º–æ—Ç—Ä–µ–ª, –∏ –≥–¥–µ, –≤–æ–∑–º–æ–∂–Ω–æ, –±—ã—Ç—å –æ—à–∏–±–∫–∞.
ChatGPT —Å–∫–∞–∑–∞–ª:
–î–∞, –±—Ä–∞—Ç, —Ç–µ–ø–µ—Ä—å —Å–µ—Ä–≤–µ—Ä —Ä–µ–∞–ª—å–Ω–æ —Ä—É–≥–∞–µ—Ç—Å—è ‚Äî PUT /api/user/update 500 (Internal Server Error) ‚Äî –∞ –∑–Ω–∞—á–∏—Ç:

üëâ —á—Ç–æ-—Ç–æ –≤ setFields.army = ... –∏–ª–∏ –¥–∞–ª—å—à–µ –Ω–µ —Ç–æ
–ù–∞–º –Ω—É–∂–Ω–æ –ø–æ–π–º–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç—Ä–æ–∫—É, –≥–¥–µ Mongo –Ω–µ –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.

üõ† –ß—Ç–æ–±—ã —Å—Ä–∞–∑—É –ø–æ–Ω—è—Ç—å, –≥–¥–µ –æ—à–∏–±–∫–∞ ‚Äî –¥–æ–±–∞–≤—å console.log() –ø–µ—Ä–µ–¥ –∞–ø–¥–µ–π—Ç–æ–º
üìÑ src/app/api/user/update/route.ts
üîç –ù–∞–π–¥–∏:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
await UserModel.updateOne(
  { address },
  {
    ...(Object.keys(setFields).length > 0 && { $set: setFields }),
    ...(Object.keys(incFields).length > 0 && { $inc: incFields }),
  }
);
üõ† –ò –ø–µ—Ä–µ–¥ —ç—Ç–∏–º –≤—Å—Ç–∞–≤—å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
console.log("[DEBUG] setFields.army:", JSON.stringify(setFields.army, null, 2));
console.log("[DEBUG] –¢–∏–ø –ø–æ–ª—è army:", typeof setFields.army);
üö® –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏:
setFields.army —Å–æ–¥–µ—Ä–∂–∏—Ç undefined –∏–ª–∏ null

–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (Map –≤–º–µ—Å—Ç–æ Object)

MongoDB –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –ø–æ–ª–µ–π ‚Äî –µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è

üì• –ß—Ç–æ–±—ã —è —Ç–æ—á–Ω–æ –≤—Å—ë –ø—Ä–æ–≤–µ—Ä–∏–ª:
üëä –î–∞–π –º–Ω–µ:

user.army –∏–∑ –±–∞–∑—ã Mongo (–º–æ–∂–µ—à—å console.log(user.army) –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º)

–∏ setFields.army, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –ø–µ—Ä–µ–¥–∞—ë—à—å

üí£ –ü–ª—é—Å:
–ï—Å–ª–∏ user.army —ç—Ç–æ Map, Mongo –º–æ–∂–µ—Ç –æ—Ç–∫–∞–∑–∞—Ç—å –ø—Ä–∏ $set ‚Äî –∏ –Ω–∞–º –Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
setFields.army = JSON.parse(JSON.stringify(updatedArmy));
–ü—Ä–æ–≤–µ—Ä—å, –µ—Å–ª–∏ —ç—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç ‚Äî –º–æ–∂–Ω–æ —Ç–∞–∫ –∏ –æ—Å—Ç–∞–≤–∏—Ç—å.

–ñ–¥—É –ª–æ–≥ –∏–ª–∏ –¥–∞–º –ø—Ä–∞–≤–∫—É, –µ—Å–ª–∏ —Ç—ã —Å–∫–∏–Ω–µ—à—å user.army –∏ setFields.army. –°–µ–π—á–∞—Å —É –Ω–∞—Å 90% —Ç–æ—á–∫–∞, –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ–±–∏—Ç—å.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
setFields.army = updatedArmy;

–í –æ–±—â–µ–º, —Å–º–æ—Ç—Ä–∏, —è –ø—Ä–æ–≤–µ—Ä–∏–ª, —è –æ—Ç–∫–∞—Ç–∏–ª —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ —Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞, –≥–¥–µ –º—ã –≤—Å—ë –ø–æ—á–∏–Ω–∏–ª–∏. –ò –µ—Å–ª–∏ —è –≤—Å—Ç–∞–≤–ª—è—é –≤–æ—Ç —ç—Ç—É —Å—Ç—Ä–æ—á–∫—É, –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–∞–¥–∞—Ç—å —Å–µ—Ä–≤–∞–∫, –≥–µ—Ä–æ–π –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è, –∫–æ—Ä–æ—á–µ, –Ω—É, –∏ –≤—Å—ë, –∏ –≤—Å—ë –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞–∑–∞–¥, –∫–∞–∫ –±—ã–ª–æ –¥–æ —Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞, –∫–∞–∫ –º—ã –≤—Å—ë –ø–æ–ø—Ä–∞–≤–∏–ª–∏. –°–Ω–æ–≤–∞ –≥–µ—Ä–æ–π –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è, –ø–µ—Ä–µ–∑–∞—Ö–æ–¥–∏—à—å, –æ–Ω, –Ω—É, –≤—Ä–æ–¥–µ –æ—Ç–º–µ–Ω–∏–ª—Å—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ñ—Ä–æ–Ω—Ç-—ç–Ω–¥–µ, –ø–µ—Ä–µ–∑–∞—Ö–æ–¥–∏—à—å, –æ–Ω —Å–Ω–æ–≤–∞ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç—Å—è.          // üìÅ src/app/api/user/update/route.ts
import { NextResponse } from "next/server";
import dbConnect from "@/lib/dbConnect";
import { UserModel } from "@/models/UserModel";
import { ARMY_STATS, ArmyUnitType } from "@/config/armyCapacity";

export async function PUT(req: Request) {
  const { address, heroArmy, army, ...data } = await req.json();

  if (!address) {
    return NextResponse.json({ error: "Address is required" }, { status: 400 });
  }

  try {
    await dbConnect();

    const allowedFields = [
      "name",
      "avatar",
      "food",
      "wood",
      "stone",
      "iron",
      "gold",
      "doubloon",
      "pearl",
      "allodium",
      "prestige",
      "levelPrestige",
      "prestigeProgress",
      "technologies",
      "activeBonuses",
      "activeQuest",
      "questPanelOpen",
      "heroes",
      "heroArmy",
      "army",
      "activeMining",
      "missions",
      "resources", // ‚Üê –µ—Å–ª–∏ –±—É–¥–µ—Ç –∫–∞–∫ –æ–±—ä–µ–∫—Ç
      "resourceNodes",

    ];

    const setFields: any = {};
    for (const key of allowedFields) {
      if (data[key] !== undefined) {
        setFields[key] = data[key];
      }
    }
    const incFields: any = {};

    // ‚úÖ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–π—Å–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
    if (army && typeof army === "object") {
      for (const unit in army) {
        const count = army[unit];
        if (typeof count === "number") {
          incFields[army.${unit}.count] = -count;
        }
      }
    }

    // ‚úÖ –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–∞ ‚Äî –≤–µ—Ä–Ω—ë–º –≤–æ–π—Å–∫–∞ –∏ –Ω–∞—á–∏—Å–ª–∏–º —Ä–µ—Å—É—Ä—Å—ã
    if (data.cancelMissionHeroId) {
      const user = await UserModel.findOne({ address });
      const mission = user?.missions.find(
        (m: any) => m.heroId === data.cancelMissionHeroId
      );

      if (mission) {
        const now = Date.now();
        const elapsed = Math.min(
          now - mission.startTime,
          mission.duration * 1000
        );
        const percent = elapsed / (mission.duration * 1000);

        const resourceType = mission.resource;
        let totalCapacity = 0;

        for (const unit in mission.heroArmy) {
          const count = mission.heroArmy[unit];
        
          const safeUnit = unit as ArmyUnitType;
          const level = user.army?.[safeUnit]?.level;

          const statsTable = ARMY_STATS[safeUnit];
          const unitStats = level && statsTable?.[level];

          if (!unitStats) continue;

          totalCapacity += unitStats.capacity * count;
        }

        const minedAmount = Math.floor(totalCapacity * percent);

        // ‚úÖ –≤–µ—Ä–Ω—É—Ç—å –≤–æ–π—Å–∫–∞
        const updatedArmy = {...user.army}
        
        for (const unit in mission.heroArmy) {
          const returningCount = mission.heroArmy[unit];
          const current = updatedArmy[unit];

          const level = current?.level ?? (
            user.army?.[unit as ArmyUnitType]?.level
          );

          updatedArmy[unit] = {
            level,
            count: (current?.count ?? 0) + returningCount
          };
        }

        // ‚úÖ –Ω–∞—á–∏—Å–ª–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã
        const currentValue = user.resources?.[resourceType] || 0;
        setFields["resources"] = {
          ...user.resources,
          [resourceType]: currentValue + minedAmount,
        };

        // ‚úÖ —É–º–µ–Ω—å—à–∏—Ç—å remaining
        const updatedNodes = user.resourceNodes.map((node: any) => {
          if (node.id === mission.nodeId) {
            return {
              ...node,
              remaining: Math.max(0, (node.remaining || 0) - minedAmount),
            };
          }
          return node;
        });
        setFields.resourceNodes = updatedNodes;

        // ‚úÖ —É–¥–∞–ª–∏—Ç—å –º–∏—Å—Å–∏—é
        user.missions = user.missions.filter(
          (m: any) => m.heroId !== data.cancelMissionHeroId
        );
        setFields.missions = user.missions;

        // ‚úÖ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–µ—Ä–æ—è –æ–±—Ä–∞—Ç–Ω–æ
        const updatedHeroes = user.heroes.map((h: any) => {
          if (h.id === mission.heroId) {
            return mission.hero;
          }
          return h;
        });
        setFields.heroes = updatedHeroes;

        // ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –í–°–Å –°–†–ê–ó–£
        await UserModel.updateOne(
          { address },
          {
            ...(Object.keys(setFields).length > 0 && { $set: setFields }),
            ...(Object.keys(incFields).length > 0 && { $inc: incFields }),
          }
        );

        // ‚úÖ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞
        const updatedUser = await UserModel.findOne({ address });
        return NextResponse.json(updatedUser);
      }
    }

    const updateQuery: any = {};
    if (Object.keys(setFields).length > 0) {
      updateQuery.$set = setFields;
    }
    if (Object.keys(incFields).length > 0) {
      updateQuery.$inc = incFields;
    }

    if (data.newMission) {
      await UserModel.updateOne(
        { address },
        { $push: { missions: data.newMission } }
      );
    }

    const user = await UserModel.findOneAndUpdate({ address }, updateQuery, {
      new: true,
    });

    if (!user) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }

    return NextResponse.json(user);
  } catch (err) {
    console.error("[api/user/update] ‚ùå –û—à–∏–±–∫–∞:", err);
    return NextResponse.json(
      { error: "Server error", details: err },
      { status: 500 }
    );
  }
} // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const MissionSchema = new mongoose.Schema({
  heroId: { type: String, required: true },
  armyCount: { type: Number, required: true },
  nodeId: { type: String, required: true },
  resource: { 
    type: String, 
    enum: ['food', 'wood', 'stone', 'iron', 'gold', 'doubloon', 'pearl', 'allodium'] 
  },  
  duration: { type: Number, required: true },
  startTime: { type: Number, required: true },
  hero: {
    id: { type: String, required: true },
    name: { type: String, required: true },
    image: { type: String, required: true },
    quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
    level: { type: Number, required: true },
    exp: { type: Number, required: true },
    expToNext: { type: Number, required: true },
  },
  heroArmy: {
    type: Map,
    of: Number,
    default: {}
  },
}, { _id: false });

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
  heroArmy: {
    type: Object,
    default: {}
  },
  
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 200 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: () => ({
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    }),
  },

  missions: {
    type: [MissionSchema],
    default: [],
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema);
 // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: [],
  army: {
    peasant: { level: 1, count: 0 },
    sailor: { level: 1, count: 200 },
    axeman: { level: 1, count: 0 },
    spearman: { level: 1, count: 0 },
    archer: { level: 1, count: 0 },
    cavalry: { level: 1, count: 0 },
  }
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
}; // üìÑ components/Islands/StartIsland/StartIsland.tsx
'use client';

import { useEffect, useRef, useState } from 'react';
import styles from './StartIsland.module.css';
import { RESOURCE_LEVEL } from '@/config/resourceLevel';
import { RESOURCE_CONFIG } from '@/constants/resources';
import { useUser } from '@/context/UserContext';
import { ResourcePoint } from '@/components/Resources/ResourcePoint/ResourcePoint';
import { IslandMapController } from '@/components/Map/IslandMapController/IslandMapController';
import { ResourceNodeModal } from '@/components/Resources/ResourceNodeModal/ResourceNodeModal';
import { ModalHerosGo } from '@/components/Heroes/ModalHerosGo/ModalHerosGo';
import { HeroesBar} from '@/components/Map/HeroesBar/HeroesBar';
import type { Mission } from '@/types/missions'; // ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π
import type { ArmyUnitType } from '@/config/armyCapacity';
import { ARMY_STATS } from '@/config/armyCapacity';
import { RESOURCE_DIFFICULTY } from '@/constants/resources'; 

const getFallbackAvatar = (resource: string): string => {
  return RESOURCE_CONFIG.find(r => r.key === resource)?.avatar || '/icons/resources/default.png';
};

interface StartIslandProps {
  onOpenNode?: (nodeId: string) => void;
}

export const StartIsland = ({ onOpenNode }: StartIslandProps) => {
  const [activeMissions, setActiveMissions] = useState<Mission[]>([]);
  const [activeNode, setActiveNode] = useState<string | null>(null);
  const [isHeroModalOpen, setHeroModalOpen] = useState(false);
  const [selectedNodeId, setSelectedNodeId] = useState<string | null>(null);
  // const [blockedNodes, setBlockedNodes] = useState<string[]>([]);
  const [activeHeroNodes, setActiveHeroNodes] = useState<{
    [nodeId: string]: { heroId: string; avatar: string };
  }>({});

  const { state, dispatch } = useUser();
  const playerHeroes = state.heroes || [];
  const points = state.resourceNodes || [];

  const mapRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const updated: typeof activeHeroNodes = {};

    for (const mission of state.missions || []) {
      updated[mission.nodeId] = {
        heroId: mission.heroId,
        avatar: mission.hero.image,
      };
    }
    setActiveHeroNodes(updated);
    setActiveMissions(state.missions || [])
  }, [state.missions]);

  const handleCollectClick = () => {
    setHeroModalOpen(true);
    setSelectedNodeId(activeNode);
    setActiveNode(null);
  };

  const availableHeroes = playerHeroes.filter(
    hero => !activeMissions.some(m => m.heroId === hero.id)
  );

  const handleConfirm = async (
    heroId: string,
    army: Record<ArmyUnitType, number>
  ) => {
    const node = points.find(p => p.id === selectedNodeId);
    if (!node) return;

    const miningStats = RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level];
    const total = miningStats.totalAmount;
    const speed = miningStats.miningSpeed;

    let capacity = 0;
    for (const [unit, count] of Object.entries(army)) {
      const unitLevel = state.army?.[unit as ArmyUnitType]?.level || 1;
      capacity += ARMY_STATS[unit as ArmyUnitType][unitLevel].capacity * count;
    }

    const difficulty = RESOURCE_DIFFICULTY[node.resource as keyof typeof RESOURCE_DIFFICULTY] || 1;
    const duration = Math.ceil((total * difficulty) / capacity); // ‚è± –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    const armyCount = Object.values(army).reduce((sum, val) => sum + val, 0);
    const filteredArmy = Object.fromEntries(
      Object.entries(army).filter(([, count]) => count > 0)
    ) as Record<ArmyUnitType, number>;
    const mission: Mission = {
      heroId,
      hero: playerHeroes.find(h => h.id === heroId)!,
      armyCount,
      nodeId: selectedNodeId!,
      resource: node.resource,
      duration,
      startTime: Date.now(),
      heroArmy: filteredArmy
    };

    try {
      const filteredArmy = Object.fromEntries(
        Object.entries(army).filter(([, count]) => count > 0)
      ) as Record<ArmyUnitType, number>;

      const response = await fetch('/api/user/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          address: state.address,
          activeMining: {
            resource: node.resource,
            heroId,
            startedAt: new Date(),
            duration,
            position: node.position,
            remaining: node.remaining,
          },
          nodeId: selectedNodeId,
          army: filteredArmy,
          newMission: mission,
          heroArmy: filteredArmy,
        }),
      });

      const updatedUser = await response.json();
      dispatch({ type: 'SET_USER', payload: updatedUser });

      setActiveMissions(prev => [...prev, mission]);
      setActiveHeroNodes(prev => ({
        ...prev,
        [selectedNodeId!]: {
          heroId,
          avatar: playerHeroes.find(h => h.id === heroId)?.image || '/icons/hero-mini.png',
        }
      }));
      setHeroModalOpen(false);
      setSelectedNodeId(null);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ—Ä–æ—è:', error);
    }
  };

  const handleCancel = async (heroId: string) => {
    const missionToCancel = activeMissions.find(m => m.heroId === heroId);
    if (!missionToCancel) return;
  
    try {
      const response = await fetch('/api/user/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          address: state.address,
          cancelMissionHeroId: heroId,
          heroArmy: missionToCancel.heroArmy,
          missions: state.missions,
          heroes: state.heroes,
          army: state.army,
          resourceNodes: state.resourceNodes,
          resources: {
            food: state.food,
            wood: state.wood,
            stone: state.stone,
            iron: state.iron,
            gold: state.gold,
            doubloon: state.doubloon,
            pearl: state.pearl,
            allodium: state.allodium,
          }
        }),
        
      });
      
  
      const updatedUser = await response.json();
  
      dispatch({ type: 'SET_USER', payload: updatedUser }); // ‚úÖ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
  
      setActiveMissions(prev => prev.filter(m => m.heroId !== heroId));
  
      setActiveHeroNodes(prev => {
        const updated = { ...prev };
        delete updated[missionToCancel.nodeId];
        return updated;
      });
  
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –º–∏—Å—Å–∏–∏:', err);
    }
  };
  

  return (
    <div className={styles.map_wrapper}>
      <IslandMapController>
        <div className={styles.map_image} ref={mapRef}>
          {points.map((node) => {
            const heroInfo = activeHeroNodes[node.id];
            const isBlocked = !!heroInfo;

            return (
              <ResourcePoint
                key={node.id}
                avatar={
                  isBlocked ? heroInfo.avatar
                  : node.avatar || getFallbackAvatar(node.resource)
                }
                x={node.position.x}
                y={node.position.y}
                onClick={() => {
                  if (!isBlocked) {
                    setActiveNode(node.id);
                    onOpenNode?.(node.id);
                  }
                }}
              />
            )
          })}
        </div>
      </IslandMapController>

      {activeNode && (() => {
        const node = points.find(p => p.id === activeNode)!;
        return (
          <ResourceNodeModal
            resource={node.resource as 'food' | 'wood' | 'stone' | 'iron' | 'gold'}
            total={RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level].totalAmount}
            remaining={node.remaining}
            onCollect={handleCollectClick}
            onClose={() => setActiveNode(null)}
          />
        );
      })()}

      {isHeroModalOpen && selectedNodeId && (
        <ModalHerosGo
          heroes={availableHeroes}
          selectedResourceNodeId={selectedNodeId}
          onClose={() => {
            setHeroModalOpen(false);
            setSelectedNodeId(null);
          }}
          onConfirm={handleConfirm}
        />
      )}

      <HeroesBar missions={activeMissions} onCancel={handleCancel} />
    </div>
  );
};

 
ChatGPT —Å–∫–∞–∑–∞–ª:
–ë—Ä–∞—Ç, –æ—à–∏–±–∫–∞ —Ç–æ—á–Ω–æ –∏–∑-–∑–∞ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
setFields.army = updatedArmy;
MongoDB –Ω–µ –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å Map-—Å—Ç—Ä—É–∫—Ç—É—Ä—É –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ $set. –£ —Ç–µ–±—è user.army ‚Äî —ç—Ç–æ Map<string, {level, count}>, –Ω–æ —Ç—ã –µ–≥–æ –∫–æ–ø–∏—Ä—É–µ—à—å –∫–∞–∫ –µ—Å—Ç—å. –ê Map ‚Äî —ç—Ç–æ –Ω–µ –æ–±—ã—á–Ω—ã–π Object, –∏ Mongoose –Ω–µ —É–º–µ–µ—Ç –µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —á–µ—Ä–µ–∑ $set, –µ—Å–ª–∏ –æ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∞–ø—Ä—è–º—É—é.

‚úÖ –†–ï–®–ï–ù–ò–ï:
üëâ –°–¥–µ–ª–∞–π –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ Map ‚Üí Object –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º:
üìÑ src/app/api/user/update/route.ts

–ó–ê–ú–ï–ù–ò:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
setFields.army = updatedArmy;
–ù–ê:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
setFields.army = JSON.parse(JSON.stringify(updatedArmy));
üí° –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?
–ü–æ—Ç–æ–º—É —á—Ç–æ updatedArmy –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å Map, undefined, Mongoose Object, –∏ –≤—Å—ë —ç—Ç–æ Mongo –ø—Ä–æ—Å—Ç–æ –Ω–µ —É–º–µ–µ—Ç —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–∞–∫ –æ–±—ã—á–Ω—ã–π JSON-–æ–±—ä–µ–∫—Ç.

üõ† –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤ –º–æ–¥–µ–ª–∏ UserModel –ø–æ–ª–µ army ‚Äî type: Map, –Ω–æ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç—ã –ø–µ—Ä–µ–¥–∞—ë—à—å —á–∏—Å—Ç—ã–π –æ–±—ä–µ–∫—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
{
  peasant: { level: 1, count: 10 },
  sailor: { level: 1, count: 50 },
  ...
}
‚úÖ –ò—Ç–æ–≥:
–ü—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤—å —Å—Ç—Ä–æ–∫—É:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
setFields.army = JSON.parse(JSON.stringify(updatedArmy));
–ò –≤—Å—ë –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç. –í–æ–π—Å–∫–∞ –≤–µ—Ä–Ω—É—Ç—Å—è.

–ï—Å–ª–∏ –Ω–µ –≤–µ—Ä–Ω—É—Ç—Å—è ‚Äî –≤–∫–ª—é—á–∏ console.log('FINAL army', updatedArmy) –ø–µ—Ä–µ–¥ —ç—Ç–∏–º, –∏ —è —Ç–µ–±–µ —Å–∫–∞–∂—É, –≥–¥–µ –µ—â—ë –∑–∞—Ç—ã–∫.

–î–∞–≤–∞–π –¥–æ–±—å—ë–º.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
—â–µ–Ω–∏–µ Map ‚Üí Object –ø–µ—Ä–µ–¥

–ê –º—ã —Ä–∞–∑–≤–µ –Ω–µ –∑–∞–º–µ–Ω–∏–ª–∏ –≤—Å–µ –º–∞–ø—ã –Ω–∞ –æ–±—ä–µ–∫—Ç—ã? –û–±—ä—è—Å–Ω–∏ –º–Ω–µ –ø–æ–¥—Ä–æ–±–Ω–æ, —á—Ç–æ —Ç–∞–∫–æ–µ –º–∞–ø, —á—Ç–æ —Ç–∞–∫–æ–µ –æ–±—ä–µ–∫—Ç, –≤ —á—ë–º –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ–Ω–∏ –º–µ–∂–¥—É —Å–æ–±–æ–π, –≤ —á—ë–º –æ–Ω–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è —É –Ω–∞—Å –≤ –ø—Ä–æ–µ–∫—Ç–µ, –∏ –∫–∞–∫–æ–π –Ω–∞–º –ª—É—á—à–µ.
ChatGPT —Å–∫–∞–∑–∞–ª:
–û—Ç–≤–µ—á–∞—é –ø–æ–¥—Ä–æ–±–Ω–æ, —á—ë—Ç–∫–æ, –±–µ–∑ –≤–æ–¥—ã. –°—Ä–∞–≤–Ω–∏–º Map –∏ Object, –ø–æ—Ç–æ–º —Ä–∞–∑–±–µ—Ä—É —Ä–∞–∑–Ω–∏—Ü—É –∏–º–µ–Ω–Ω–æ –≤ —Ç–≤–æ—ë–º –ø—Ä–æ–µ–∫—Ç–µ, –∞ –∑–∞—Ç–µ–º —Å–∫–∞–∂—É, —á—Ç–æ —Ç–µ–±–µ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.

üì¶ –ß—Ç–æ —Ç–∞–∫–æ–µ Map –∏ Object?
Object ({})	Map (new Map())
üîë –ö–ª—é—á–∏	—Ç–æ–ª—å–∫–æ string –∏–ª–∏ symbol	–ª—é–±—ã–µ —Ç–∏–ø—ã: string, number, object, –∏ —Ç.–¥.
üßº –ü–æ—Ä—è–¥–æ–∫	–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω	–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ—Ä—è–¥–æ–∫ –≤—Å—Ç–∞–≤–∫–∏
üîÅ –ò—Ç–µ—Ä–∞—Ü–∏—è	for...in, Object.keys()	map.forEach, map.entries() –∏ —Ç.–¥.
üìê –†–∞–∑–º–µ—Ä	–≤—Ä—É—á–Ω—É—é: Object.keys(obj).length	map.size
üß† –ú–µ—Ç–æ–¥—ã	–Ω–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤	.set(), .get(), .has(), .delete()
üóÉ JSON	–ª–µ–≥–∫–æ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è (JSON.stringify)	‚ùå –Ω–µ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è, —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ JSON.stringify()

üí• –í —Ç–≤–æ—ë–º –ø—Ä–æ–µ–∫—Ç–µ:
üìÅ UserModel.ts
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  type: Map, // ‚Üê –≠–¢–û MONGOOSE MAP
  of: ArmyUnitSchema,
}
Mongoose Map ‚Äî —ç—Ç–æ –Ω–µ –æ–±—ã—á–Ω—ã–π JavaScript Map, —ç—Ç–æ Schema.Types.Map, –∏ –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º –æ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π object, –ù–û:

–µ—Å–ª–∏ —Ç—ã –ø–µ—Ä–µ–¥–∞—ë—à—å Map –Ω–∞–ø—Ä—è–º—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä –∏–∑ state.army –≤ setFields.army), —Ç–æ:

Mongo –º–æ–∂–µ—Ç –∫—Ä–∞—à–Ω—É—Ç—å—Å—è, –µ—Å–ª–∏ —Ç–∞–º Map, –∞ –æ–Ω –∂–¥—ë—Ç object.

üî• –í —á—ë–º –±—ã–ª–∞ —É —Ç–µ–±—è –ø—Ä–æ–±–ª–µ–º–∞:
–¢—ã –¥–µ–ª–∞–µ—à—å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const updatedArmy = { ...user.army };
user.army ‚Äî —ç—Ç–æ Mongoose Map.

–ó–Ω–∞—á–∏—Ç updatedArmy ‚Äî —ç—Ç–æ –≤—Å—ë –µ—â—ë Map, —Ö–æ—Ç—è —Ç—ã –¥—É–º–∞–µ—à—å, —á—Ç–æ —ç—Ç–æ object.

–ê –ø–æ—Ç–æ–º:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
setFields.army = updatedArmy;
–í–æ—Ç —Ç—É—Ç Mongo –ø–∞–¥–∞–µ—Ç ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ $set –Ω–µ –º–æ–∂–µ—Ç –∑–∞—Å–µ—Ç–∏—Ç—å Map.

üí° –ß—Ç–æ –¥–µ–ª–∞—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç–µ?
–¢–´ –î–û–õ–ñ–ï–ù –í–°–Æ–î–£ –ü–†–ò–í–ï–°–¢–ò –í–°–ï –ö Object (—á—Ç–æ–±—ã JSON.stringify —Ä–∞–±–æ—Ç–∞–ª, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–∞–¥–∞–ª, —á—Ç–æ–±—ã –≤—Å—ë –±—ã–ª–æ –ø—Ä–æ—Å—Ç–æ):

‚úÖ –†–µ—à–µ–Ω–∏–µ
1. –í–µ–∑–¥–µ –≥–¥–µ user.army, user.heroArmy ‚Äî –¥–µ–ª–∞–π —Ç–∞–∫:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const armyObject = JSON.parse(JSON.stringify(user.army))
2. –í UserModel.ts: –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å Map, –µ—Å–ª–∏ —Ç—ã —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞–µ—à—å, –Ω–æ –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø—Ä–æ—Å—Ç–æ—Ç—ã ‚Äî –º–µ–Ω—è–π –Ω–∞ Object:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  type: Object,
  default: () => ({
    peasant:  { level: 1, count: 0 },
    sailor:   { level: 1, count: 200 },
    ...
  }),
}
heroArmy ‚Äî —Ç–æ–∂–µ:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Object,
  default: {}
}
üí¨ –ß—Ç–æ —Ç–µ–±–µ –≤—ã–±—Ä–∞—Ç—å?
–í–∞—Ä–∏–∞–Ω—Ç	–ü–ª—é—Å—ã	–ú–∏–Ω—É—Å—ã	–í—ã–≤–æ–¥
Map	–ø–æ—Ä—è–¥–æ–∫ –∫–ª—é—á–µ–π, –º–µ—Ç–æ–¥—ã	—Å–ª–æ–∂–Ω–æ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è, Mongo –Ω–µ –ª—é–±–∏—Ç	‚ùå –ù–ï –ù–ê–î–û
Object	–ø—Ä–æ—Å—Ç–æ—Ç–∞, –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Mongo, JSON-friendly	–Ω–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤, —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏ –≤ –∫–ª—é—á–∞—Ö	‚úÖ –î–ê, –í–´–ë–ò–†–ê–ï–ú

‚òëÔ∏è –í—ã–≤–æ–¥
–í—Å—ë –ø–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ type: Object, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º Map, –¥–∞–∂–µ –≤ —Å—Ö–µ–º–µ.

–ü—Ä–∏–º–µ—Ä:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Object,
  default: {},
},
army: {
  type: Object,
  default: () => ({
    peasant: { level: 1, count: 0 },
    ...
  }),
}
–ò —Ç–æ–≥–¥–∞:

setFields.army = updatedArmy –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

JSON.stringify() –Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø—Ä–æ–π–¥—ë—Ç

—Å–µ—Ä–≤–µ—Ä –Ω–µ —É–ø–∞–¥—ë—Ç

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî —è —Ç–µ–±–µ —Å–¥–µ–ª–∞—é –∫–æ–º–º–∏—Ç, –≥–¥–µ –≤—Å—ë –∑–∞–º–µ–Ω–µ–Ω–æ —á—ë—Ç–∫–æ –Ω–∞ Object, –ø–æ –≤—Å–µ–º 4 —Ñ–∞–π–ª–∞–º (UserModel.ts, UserContext.tsx, route.ts, StartIsland.tsx). –°–∫–∞–∂–∏ ‚Äî —Å–¥–µ–ª–∞—é –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–¢—ã –≥–æ–≤–æ—Ä–∏—à—å, –≤–æ—Ç –ø–æ–º–µ–Ω—è—Ç—å, –¥–∞? –ù—É –≤–æ—Ç —Å–º–æ—Ç—Ä–∏ —É –º–µ–Ω—è –∫–∞–∫ —Å–µ–π—á–∞—Å –≤–æ—Ç –∑–¥–µ—Å—å. // üìÑ components/Islands/StartIsland/StartIsland.tsx
'use client';

import { useEffect, useRef, useState } from 'react';
import styles from './StartIsland.module.css';
import { RESOURCE_LEVEL } from '@/config/resourceLevel';
import { RESOURCE_CONFIG } from '@/constants/resources';
import { useUser } from '@/context/UserContext';
import { ResourcePoint } from '@/components/Resources/ResourcePoint/ResourcePoint';
import { IslandMapController } from '@/components/Map/IslandMapController/IslandMapController';
import { ResourceNodeModal } from '@/components/Resources/ResourceNodeModal/ResourceNodeModal';
import { ModalHerosGo } from '@/components/Heroes/ModalHerosGo/ModalHerosGo';
import { HeroesBar} from '@/components/Map/HeroesBar/HeroesBar';
import type { Mission } from '@/types/missions'; // ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π
import type { ArmyUnitType } from '@/config/armyCapacity';
import { ARMY_STATS } from '@/config/armyCapacity';
import { RESOURCE_DIFFICULTY } from '@/constants/resources'; 

const getFallbackAvatar = (resource: string): string => {
  return RESOURCE_CONFIG.find(r => r.key === resource)?.avatar || '/icons/resources/default.png';
};

interface StartIslandProps {
  onOpenNode?: (nodeId: string) => void;
}

export const StartIsland = ({ onOpenNode }: StartIslandProps) => {
  const [activeMissions, setActiveMissions] = useState<Mission[]>([]);
  const [activeNode, setActiveNode] = useState<string | null>(null);
  const [isHeroModalOpen, setHeroModalOpen] = useState(false);
  const [selectedNodeId, setSelectedNodeId] = useState<string | null>(null);
  // const [blockedNodes, setBlockedNodes] = useState<string[]>([]);
  const [activeHeroNodes, setActiveHeroNodes] = useState<{
    [nodeId: string]: { heroId: string; avatar: string };
  }>({});

  const { state, dispatch } = useUser();
  const playerHeroes = state.heroes || [];
  const points = state.resourceNodes || [];

  const mapRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const updated: typeof activeHeroNodes = {};

    for (const mission of state.missions || []) {
      updated[mission.nodeId] = {
        heroId: mission.heroId,
        avatar: mission.hero.image,
      };
    }
    setActiveHeroNodes(updated);
    setActiveMissions(state.missions || [])
  }, [state.missions]);

  const handleCollectClick = () => {
    setHeroModalOpen(true);
    setSelectedNodeId(activeNode);
    setActiveNode(null);
  };

  const availableHeroes = playerHeroes.filter(
    hero => !activeMissions.some(m => m.heroId === hero.id)
  );

  const handleConfirm = async (
    heroId: string,
    army: Record<ArmyUnitType, number>
  ) => {
    const node = points.find(p => p.id === selectedNodeId);
    if (!node) return;

    const miningStats = RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level];
    const total = miningStats.totalAmount;
    const speed = miningStats.miningSpeed;

    let capacity = 0;
    for (const [unit, count] of Object.entries(army)) {
      const unitLevel = state.army?.[unit as ArmyUnitType]?.level || 1;
      capacity += ARMY_STATS[unit as ArmyUnitType][unitLevel].capacity * count;
    }

    const difficulty = RESOURCE_DIFFICULTY[node.resource as keyof typeof RESOURCE_DIFFICULTY] || 1;
    const duration = Math.ceil((total * difficulty) / capacity); // ‚è± –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    const armyCount = Object.values(army).reduce((sum, val) => sum + val, 0);
    const filteredArmy = Object.fromEntries(
      Object.entries(army).filter(([, count]) => count > 0)
    ) as Record<ArmyUnitType, number>;
    const mission: Mission = {
      heroId,
      hero: playerHeroes.find(h => h.id === heroId)!,
      armyCount,
      nodeId: selectedNodeId!,
      resource: node.resource,
      duration,
      startTime: Date.now(),
      heroArmy: filteredArmy
    };

    try {
      const filteredArmy = Object.fromEntries(
        Object.entries(army).filter(([, count]) => count > 0)
      ) as Record<ArmyUnitType, number>;

      const response = await fetch('/api/user/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          address: state.address,
          activeMining: {
            resource: node.resource,
            heroId,
            startedAt: new Date(),
            duration,
            position: node.position,
            remaining: node.remaining,
          },
          nodeId: selectedNodeId,
          army: filteredArmy,
          newMission: mission,
          heroArmy: filteredArmy,
        }),
      });

      const updatedUser = await response.json();
      dispatch({ type: 'SET_USER', payload: updatedUser });

      setActiveMissions(prev => [...prev, mission]);
      setActiveHeroNodes(prev => ({
        ...prev,
        [selectedNodeId!]: {
          heroId,
          avatar: playerHeroes.find(h => h.id === heroId)?.image || '/icons/hero-mini.png',
        }
      }));
      setHeroModalOpen(false);
      setSelectedNodeId(null);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ—Ä–æ—è:', error);
    }
  };

  const handleCancel = async (heroId: string) => {
    const missionToCancel = activeMissions.find(m => m.heroId === heroId);
    if (!missionToCancel) return;
  
    try {
      const response = await fetch('/api/user/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          address: state.address,
          cancelMissionHeroId: heroId,
          heroArmy: missionToCancel.heroArmy,
          missions: state.missions,
          heroes: state.heroes,
          army: state.army,
          resourceNodes: state.resourceNodes,
          resources: {
            food: state.food,
            wood: state.wood,
            stone: state.stone,
            iron: state.iron,
            gold: state.gold,
            doubloon: state.doubloon,
            pearl: state.pearl,
            allodium: state.allodium,
          }
        }),
        
      });
      
  
      const updatedUser = await response.json();
  
      dispatch({ type: 'SET_USER', payload: updatedUser }); // ‚úÖ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
  
      setActiveMissions(prev => prev.filter(m => m.heroId !== heroId));
  
      setActiveHeroNodes(prev => {
        const updated = { ...prev };
        delete updated[missionToCancel.nodeId];
        return updated;
      });
  
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –º–∏—Å—Å–∏–∏:', err);
    }
  };
  

  return (
    <div className={styles.map_wrapper}>
      <IslandMapController>
        <div className={styles.map_image} ref={mapRef}>
          {points.map((node) => {
            const heroInfo = activeHeroNodes[node.id];
            const isBlocked = !!heroInfo;

            return (
              <ResourcePoint
                key={node.id}
                avatar={
                  isBlocked ? heroInfo.avatar
                  : node.avatar || getFallbackAvatar(node.resource)
                }
                x={node.position.x}
                y={node.position.y}
                onClick={() => {
                  if (!isBlocked) {
                    setActiveNode(node.id);
                    onOpenNode?.(node.id);
                  }
                }}
              />
            )
          })}
        </div>
      </IslandMapController>

      {activeNode && (() => {
        const node = points.find(p => p.id === activeNode)!;
        return (
          <ResourceNodeModal
            resource={node.resource as 'food' | 'wood' | 'stone' | 'iron' | 'gold'}
            total={RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level].totalAmount}
            remaining={node.remaining}
            onCollect={handleCollectClick}
            onClose={() => setActiveNode(null)}
          />
        );
      })()}

      {isHeroModalOpen && selectedNodeId && (
        <ModalHerosGo
          heroes={availableHeroes}
          selectedResourceNodeId={selectedNodeId}
          onClose={() => {
            setHeroModalOpen(false);
            setSelectedNodeId(null);
          }}
          onConfirm={handleConfirm}
        />
      )}

      <HeroesBar missions={activeMissions} onCancel={handleCancel} />
    </div>
  );
};

ChatGPT —Å–∫–∞–∑–∞–ª:
–î–∞, –±—Ä–∞—Ç. –°–º–æ—Ç—Ä—é –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ. –í—Å—ë —á—ë—Ç–∫–æ.

üí£ –°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
–¢—ã —Å–ø—Ä–æ—Å–∏–ª:

–ú—ã –≤—Å—ë –ø–æ–º–µ–Ω—è–ª–∏ –Ω–∞ Object, –Ω–æ –≤–æ—Ç —Ç—É—Ç ‚Äî StartIsland.tsx ‚Äî –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ army –∏ heroArmy —Ç–æ—á–Ω–æ –Ω–µ Map?

‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä—è–º–æ –≤ StartIsland.tsx
–í—Å—Ç–∞–≤—å –≤–Ω—É—Ç—Ä–∏ handleCancel –ø–µ—Ä–µ–¥ fetch –≤–æ—Ç —ç—Ç–æ:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
console.log("üîç army:", state.army);
console.log("üîç heroArmy:", missionToCancel.heroArmy);
console.log("typeof army:", typeof state.army);
console.log("army.constructor.name:", state.army?.constructor?.name);
console.log("heroArmy.constructor.name:", missionToCancel.heroArmy?.constructor?.name);
‚úÖ –ß—Ç–æ —Ç—ã –¥–æ–ª–∂–µ–Ω —É–≤–∏–¥–µ—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏:
–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è	–û–∂–∏–¥–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
typeof	object
constructor.name	Object
‚ùå –µ—Å–ª–∏ —Ç–∞–º Map	–±—É–¥–µ—Ç Map –≤–º–µ—Å—Ç–æ Object

–ï—Å–ª–∏ Map ‚Äî –∑–Ω–∞—á–∏—Ç –≥–¥–µ-—Ç–æ —Ç—ã –ø–µ—Ä–µ–¥–∞–ª Map, –∞ –Ω–µ object.

üõ† –ï—Å–ª–∏ —Ç—ã —Ö–æ—á–µ—à—å —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤—Å—ë –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –≤ –æ–±—ã—á–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
–ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const armyObject = JSON.parse(JSON.stringify(state.army));
const heroArmyObject = JSON.parse(JSON.stringify(missionToCancel.heroArmy));
–ó–∞–º–µ–Ω—è–µ—à—å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
body: JSON.stringify({
  ...
  army: armyObject,
  heroArmy: heroArmyObject,
  ...
})
üí• –ü–æ—á–µ–º—É —ç—Ç–æ –Ω—É–∂–Ω–æ?
–ü–æ—Ç–æ–º—É —á—Ç–æ Map –Ω–µ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ JSON.stringify(), –∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ–ø–∞–¥–∞–µ—Ç –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç, –∞ —Ç—ã –ø–æ—Ç–æ–º —Å–º–æ—Ç—Ä–∏—à—å army.peasant ‚Äî –∞ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ Map –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª—Å—è –≤ [].

‚öî –ß—Ç–æ —Ç–µ–±–µ –¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
–í—Å—Ç–∞–≤—å console.log(...) –∫–∞–∫ –≤—ã—à–µ.

–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ constructor.name = Object

–ï—Å–ª–∏ Map ‚Äî –¥–µ–ª–∞–π JSON.parse(JSON.stringify(...))

–ò–ª–∏ ‚Äî –≤—Å–µ–≥–¥–∞ –¥–µ–ª–∞–π —ç—Ç–æ—Ç —Ç—Ä—é–∫ –ø–µ—Ä–µ–¥ fetch, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∏—Å—Ç—ã–µ –æ–±—ä–µ–∫—Ç—ã.

–•–æ—á–µ—à—å ‚Äî —è –ø—Ä–æ—Å—Ç–∞–≤–ª—é —ç—Ç–æ —Ç–µ–±–µ –ø–æ –≤—Å–µ–º 4 —Ñ–∞–π–ª–∞–º, —Å –Ω–æ–º–µ—Ä–∞–º–∏ —Å—Ç—Ä–æ–∫. –°–∫–∞–∂–∏.

–í—ã —Å–∫–∞–∑–∞–ª–∏:

ChatGPT —Å–∫–∞–∑–∞–ª:
–û—Ç–ª–∏—á–Ω–æ, –±—Ä–∞—Ç, —Ç–µ–ø–µ—Ä—å —É –Ω–∞—Å –≤—Å—ë —è—Å–Ω–æ. –¢—ã –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—Å—Ç–∞–≤–∏–ª:

üí• –ß—Ç–æ –º—ã –≤–∏–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª–∏:
typeof army: object ‚úÖ

army.constructor.name: Object ‚úÖ

heroArmy.constructor.name: Object ‚úÖ

–ó–Ω–∞—á–∏—Ç Map —Ç—É—Ç –±–æ–ª—å—à–µ –Ω–µ—Ç. –í—Å—ë —Å—Ç–∞–ª–æ –æ–±—ã—á–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º.

‚ùó –ù–æ –≤—Å—ë –µ—â—ë –ø–∞–¥–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä
–ù–∞ —Å–∫—Ä–∏–Ω–µ –≤–∏–¥–Ω–æ:

pgsql
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
PUT http://localhost:3000/api/user/update 500 (Internal Server Error)
‚Üí StartIsland.tsx:153
–ê –≤ –ª–æ–≥–∞—Ö:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: { archer: {‚Ä¶}, axeman: {‚Ä¶}, ... }
heroArmy: { soldier: 3 }
‚ö†Ô∏è –ü—Ä–∏—á–∏–Ω–∞ –∫—Ä–∞—à–∞
–¢—ã –ø–µ—Ä–µ–¥–∞—ë—à—å heroArmy –∫–∞–∫:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: { sailor: 3, peasant: 5 }
–ê —Å–µ—Ä–≤–µ—Ä –≤ UserModel.ts –∂–¥–µ—Ç:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Map,
  of: Number,
}
üí£ –ù–æ —Ç—ã —É–∂–µ –∑–∞–º–µ–Ω–∏–ª Map –Ω–∞ Object! –°–º–æ—Ç—Ä–∏ –≤ HeroSchema:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Object,
  default: {}
}
–ê –≤ MissionSchema —É —Ç–µ–±—è –≤—Å—ë –µ—â—ë:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Map,
  of: Number,
  default: {}
}
üõ† –†–ï–®–ï–ù–ò–ï
1. –û—Ç–∫—Ä–æ–π üìÑ src/models/UserModel.ts
üîÅ –ó–∞–º–µ–Ω–∏ –≤ MissionSchema:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Map,
  of: Number,
  default: {}
}
‚úÖ –ù–ê:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Object,
  default: {}
}
üìç–°—Ç—Ä–æ–∫–∞ 17‚Äì21

2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä (ctrl + c, –ø–æ—Ç–æ–º npm run dev)
3. –ü—Ä–æ–≤–µ—Ä–∫–∞
–û—Ç–ø—Ä–∞–≤—å –≥–µ—Ä–æ—è –Ω–∞ –¥–æ–±—ã—á—É

–û—Ç–º–µ–Ω–∏ –º–∏—Å—Å–∏—é

–ê—Ä–º–∏—è –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è

–û—à–∏–±–∫–∞ 500 –∏—Å—á–µ–∑–Ω–µ—Ç

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —è —Å–µ–π—á–∞—Å –ø—Ä–æ–π–¥—É –ø–æ –≤—Å–µ–º —á–µ—Ç—ã—Ä—ë–º —Å—Ö–µ–º–∞–º –∏ —É–∫–∞–∂—É –≤—Å–µ –ø–æ–ª—è, –≥–¥–µ –±—ã–ª Map –∏ —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–∞–¥–æ –∑–∞–º–µ–Ω–∏—Ç—å. –°–∫–∞–∂–∏ ‚Äî –∏ —è —Å–¥–µ–ª–∞—é.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
// üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const MissionSchema = new mongoose.Schema({
  heroId: { type: String, required: true },
  armyCount: { type: Number, required: true },
  nodeId: { type: String, required: true },
  resource: { 
    type: String, 
    enum: ['food', 'wood', 'stone', 'iron', 'gold', 'doubloon', 'pearl', 'allodium'] 
  },  
  duration: { type: Number, required: true },
  startTime: { type: Number, required: true },
  hero: {
    id: { type: String, required: true },
    name: { type: String, required: true },
    image: { type: String, required: true },
    quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
    level: { type: Number, required: true },
    exp: { type: Number, required: true },
    expToNext: { type: Number, required: true },
  },
  heroArmy: {
    type: Object,
    default: {}
  },
}, { _id: false });

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
  heroArmy: {
    type: Object,
    default: {}
  },
  
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 200 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Object,
    of: ArmyUnitSchema,
    default: () => ({
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    }),
  },

  missions: {
    type: [MissionSchema],
    default: [],
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema);
ChatGPT —Å–∫–∞–∑–∞–ª:
–û—Ç–ª–∏—á–Ω–æ. –°–µ–π—á–∞—Å —Ç—ã –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–∏–ª, –∏ –º–æ–∂–Ω–æ —É—Ç–≤–µ—Ä–¥–∏—Ç—å:

‚úÖ –í—Å–µ Map –ó–ê–ú–ï–ù–ï–ù–´ –Ω–∞ Object:
üìÅ src/models/UserModel.ts:
1. MissionSchema:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Object,
  default: {}
},
‚Üí üîÅ –ë–´–õ–û: type: Map, of: Number
‚Üí ‚úÖ –°–¢–ê–õ–û: type: Object

2. HeroSchema:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Object,
  default: {}
}
‚Üí üîÅ –¢–æ –∂–µ —Å–∞–º–æ–µ, —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

3. userSchema.army:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  type: Object,
  of: ArmyUnitSchema,
  default: () => ({
    peasant:  { level: 1, count: 0 },
    sailor:   { level: 1, count: 200 },
    axeman:   { level: 1, count: 0 },
    spearman: { level: 1, count: 0 },
    archer:   { level: 1, count: 0 },
    cavalry:  { level: 1, count: 0 },
  }),
}
‚Üí üîÅ –ë–´–õ–û: type: Map, of: ArmyUnitSchema
‚Üí ‚úÖ –°–¢–ê–õ–û: type: Object

üí• –í–°–Å –ì–û–¢–û–í–û
–¢—ã —Å–¥–µ–ª–∞–ª –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –¢–µ–ø–µ—Ä—å:

army —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –æ–±—ä–µ–∫—Ç { sailor: { level: 1, count: 200 } }

heroArmy –≤ –º–∏—Å—Å–∏–∏ ‚Äî —Ç–æ–∂–µ –æ–±—ã—á–Ω—ã–π –æ–±—ä–µ–∫—Ç { sailor: 3 }

‚ùó –ù–µ –∑–∞–±—É–¥—å:
–ï—Å–ª–∏ —Ç—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —ç—Ç–æ –ø–æ–º–µ–Ω—è–ª ‚Äî –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —É–¥–∞–ª–∏—Ç—å –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å:

—Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑–µ (—É –∫–æ—Ç–æ—Ä—ã—Ö Map) –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —è –º–æ–≥—É:

—Å–¥–µ–ª–∞—Ç—å mongoose.Schema.Types.Mixed –¥–ª—è –ø–æ–ª–Ω–æ–π –≥–∏–±–∫–æ—Å—Ç–∏ (–º–æ–∂–Ω–æ –∏ Map, –∏ Object)

–∏–ª–∏ –¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –Ω–∞ –æ—á–∏—Å—Ç–∫—É –ø–æ–ª—è –≤ –±–∞–∑–µ —á–µ—Ä–µ–∑ MongoShell/Compass

–¢—ã —Å–∫–∞–∂–∏.

–í—ã —Å–∫–∞–∑–∞–ª–∏:



ChatGPT —Å–∫–∞–∑–∞–ª:
–ü—Ä–∏—á–∏–Ω–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–π heroArmy –≤—ã–∑—ã–≤–∞–µ—Ç 500 Internal Server Error, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç–æ —á—Ç–æ –æ–Ω –≤—Ä–æ–¥–µ –±—ã –æ–±—ä–µ–∫—Ç, –≤ —Ç–æ–º, —á—Ç–æ MongoDB (—á–µ—Ä–µ–∑ mongoose) –æ–∂–∏–¥–∞–µ—Ç —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã–π plain object, –∞ –Ω–µ Map, Proxy –∏–ª–∏ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã. –ù–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ –≤–∏–¥–Ω–æ:

pgsql
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy.constructor.name: Object
–ù–æ heroArmy –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ Map, –ø–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: { sailor: 5 }
–ê –≤–æ—Ç –≤ mongoose.Schema –æ–Ω –≤—Å—ë –µ—â—ë –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ MissionSchema –∫–∞–∫:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Map,
  of: Number,
  default: {}
},
–¢—ã —É–∂–µ –∑–∞–º–µ–Ω–∏–ª Map –Ω–∞ Object ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ —Ç—ã –Ω–µ –¥–æ –∫–æ–Ω—Ü–∞ –¥–æ–≤—ë–ª —ç—Ç–æ –¥–æ –∫–æ–Ω—Ü–∞: –≤ –±–∞–∑–µ –≤—Å—ë –µ—â—ë –º–æ–≥—É—Ç –±—ã—Ç—å Map, –∏ –≤ –∫–æ–¥–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –æ–Ω–∏ –º–æ–≥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Å —Ç–∏–ø–æ–º Proxy, –∞ –Ω–µ Object.

üí• –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å
1. –í UserModel.ts:
‚úîÔ∏è –¢—ã —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–¥–µ–ª–∞–ª –≤–æ—Ç —ç—Ç–æ:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: {
  type: Object,
  default: {}
}
–û—Å—Ç–∞–≤–ª—è–µ–º —Ç–∞–∫. –¢–æ –∂–µ —Å–∞–º–æ–µ —É –≥–µ—Ä–æ—è.

2. –ü–µ—Ä–µ–¥ updateOne() –≤ route.ts ‚Äì –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–≤—Ä–∞—â–∞–π heroArmy –≤ plain object:

üìç –î–æ–±–∞–≤–∏—Ç—å –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ updateOne –≤ PUT /api/user/update:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
// üîÅ –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º heroArmy –≤ plain object (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
if (setFields.heroArmy && setFields.heroArmy instanceof Map) {
  setFields.heroArmy = Object.fromEntries(setFields.heroArmy);
} else if (
  setFields.heroArmy &&
  typeof setFields.heroArmy === "object" &&
  setFields.heroArmy.constructor.name !== "Object"
) {
  setFields.heroArmy = JSON.parse(JSON.stringify(setFields.heroArmy));
}
üìç –ò –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤–Ω—É—Ç—Ä–∏ if (data.cancelMissionHeroId) { ... } ‚Äî –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ updateOne:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
// üëá –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≤–µ—Ä–Ω—É–≤—à–∞—è—Å—è –∞—Ä–º–∏—è —Ç–æ–∂–µ –Ω–µ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º–∞
if (updatedArmy && updatedArmy.constructor.name !== "Object") {
  setFields.army = JSON.parse(JSON.stringify(updatedArmy));
} else {
  setFields.army = updatedArmy;
}
‚úÖ –ß—Ç–æ —Ç—ã –≤ –∏—Ç–æ–≥–µ –ø–æ–ª—É—á–∞–µ—à—å:
heroArmy –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –æ—Å—Ç–∞—ë—Ç—Å—è –æ–±—ã—á–Ω—ã–º {sailor: 5}.

–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ–Ω–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å —Ç–∏–ø–æ–º Object, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å Proxy/Map, –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –≤ –∫–æ–¥–µ –±—ã–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è.

–ú—ã —è–≤–Ω–æ –ø—Ä–∏–≤–æ–¥–∏–º –∫ JSON.stringify ‚Üí JSON.parse ‚Äî —ç—Ç–æ 100% –¥–∞—Å—Ç plain object, –∏ Mongoose –Ω–µ —É–ø–∞–¥—ë—Ç.

üí° –ò—Ç–æ–≥
üìÅ src/app/api/user/update/route.ts
–í—Å—Ç–∞–≤—å –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º updateOne():

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
if (setFields.heroArmy && setFields.heroArmy.constructor.name !== "Object") {
  setFields.heroArmy = JSON.parse(JSON.stringify(setFields.heroArmy));
}
if (setFields.army && setFields.army.constructor.name !== "Object") {
  setFields.army = JSON.parse(JSON.stringify(setFields.army));
}
–ò–º–µ–Ω–Ω–æ —ç—Ç–æ —É–±–µ—Ä—ë—Ç —Ç–≤–æ—é PUT /api/user/update 500.

–ì–æ—Ç–æ–≤ –≤–∫–∞—Ç–∏—Ç—å —Ç–µ–±–µ —Ç–æ—á–Ω—ã–π diff –ø–æ —Å—Ç—Ä–æ–∫–∞–º, –∫–∞–∫ —Ç–æ–ª—å–∫–æ —Å–∫–∞–∂–µ—à—å.

–í—ã —Å–∫–∞–∑–∞–ª–∏:



// üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const MissionSchema = new mongoose.Schema({
  heroId: { type: String, required: true },
  armyCount: { type: Number, required: true },
  nodeId: { type: String, required: true },
  resource: { 
    type: String, 
    enum: ['food', 'wood', 'stone', 'iron', 'gold', 'doubloon', 'pearl', 'allodium'] 
  },  
  duration: { type: Number, required: true },
  startTime: { type: Number, required: true },
  hero: {
    id: { type: String, required: true },
    name: { type: String, required: true },
    image: { type: String, required: true },
    quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
    level: { type: Number, required: true },
    exp: { type: Number, required: true },
    expToNext: { type: Number, required: true },
  },
  heroArmy: {
    type: Object,
    default: {}
  },
}, { _id: false });

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
  heroArmy: {
    type: Object,
    default: {}
  },
  
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 200 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Object,
    of: ArmyUnitSchema,
    default: () => ({
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    }),
  },

  missions: {
    type: [MissionSchema],
    default: [],
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema); // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';
import type { Mission } from '@/types/missions';
export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };
  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];
  resourceNodes?: {
    id: string;
    resource: string;
    level: number;
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];
  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
  missions?: Mission[];
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST"; 
      payload: {
        id: string;
        title: string;
        description: string;
        status: "active" | "complete";
      };
    }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"] }
  | { type: "SET_MISSIONS"; payload: Mission[]}


const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  missions: [],
  army: {
    peasant: { level: 1, count: 0 },
    sailor: { level: 1, count: 200 },
    axeman: { level: 1, count: 0 },
    spearman: { level: 1, count: 0 },
    archer: { level: 1, count: 0 },
    cavalry: { level: 1, count: 0 },
  }
};

function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
      return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_MISSIONS":
      return {
        ...state,
        missions: action.payload,
      }
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true,
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}

const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};
 // üìÅ src/app/api/user/update/route.ts
import { NextResponse } from "next/server";
import dbConnect from "@/lib/dbConnect";
import { UserModel } from "@/models/UserModel";
import { ARMY_STATS, ArmyUnitType } from "@/config/armyCapacity";

export async function PUT(req: Request) {
  const { address, heroArmy, army, ...data } = await req.json();

  if (!address) {
    return NextResponse.json({ error: "Address is required" }, { status: 400 });
  }

  try {
    await dbConnect();

    const allowedFields = [
      "name",
      "avatar",
      "food",
      "wood",
      "stone",
      "iron",
      "gold",
      "doubloon",
      "pearl",
      "allodium",
      "prestige",
      "levelPrestige",
      "prestigeProgress",
      "technologies",
      "activeBonuses",
      "activeQuest",
      "questPanelOpen",
      "heroes",
      "heroArmy",
      "army",
      "activeMining",
      "missions",
      "resources", // ‚Üê –µ—Å–ª–∏ –±—É–¥–µ—Ç –∫–∞–∫ –æ–±—ä–µ–∫—Ç
      "resourceNodes",

    ];

    const setFields: any = {};
    for (const key of allowedFields) {
      if (data[key] !== undefined) {
        setFields[key] = data[key];
      }
    }
    const incFields: any = {};

    // ‚úÖ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–π—Å–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
    if (army && typeof army === "object") {
      for (const unit in army) {
        const count = army[unit];
        if (typeof count === "number") {
          incFields[army.${unit}.count] = -count;
        }
      }
    }

    // ‚úÖ –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–∞ ‚Äî –≤–µ—Ä–Ω—ë–º –≤–æ–π—Å–∫–∞ –∏ –Ω–∞—á–∏—Å–ª–∏–º —Ä–µ—Å—É—Ä—Å—ã
    if (data.cancelMissionHeroId) {
      const user = await UserModel.findOne({ address });
      const mission = user?.missions.find(
        (m: any) => m.heroId === data.cancelMissionHeroId
      );

      if (mission) {
        const now = Date.now();
        const elapsed = Math.min(
          now - mission.startTime,
          mission.duration * 1000
        );
        const percent = elapsed / (mission.duration * 1000);

        const resourceType = mission.resource;
        let totalCapacity = 0;

        for (const unit in mission.heroArmy) {
          const count = mission.heroArmy[unit];
        
          const safeUnit = unit as ArmyUnitType;
          const level = user.army?.[safeUnit]?.level;

          const statsTable = ARMY_STATS[safeUnit];
          const unitStats = level && statsTable?.[level];

          if (!unitStats) continue;

          totalCapacity += unitStats.capacity * count;
        }

        const minedAmount = Math.floor(totalCapacity * percent);

        // ‚úÖ –≤–µ—Ä–Ω—É—Ç—å –≤–æ–π—Å–∫–∞
        const updatedArmy = {...user.army}
        
        for (const unit in mission.heroArmy) {
          const returningCount = mission.heroArmy[unit];
          const current = updatedArmy[unit];

          const level = current?.level ?? (
            user.army?.[unit as ArmyUnitType]?.level
          );

          updatedArmy[unit] = {
            level,
            count: (current?.count ?? 0) + returningCount
          };
        }
        setFields.army = updatedArmy; 
        
        // ‚úÖ –Ω–∞—á–∏—Å–ª–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã
        const currentValue = user.resources?.[resourceType] || 0;
        setFields["resources"] = {
          ...user.resources,
          [resourceType]: currentValue + minedAmount,
        };

        // ‚úÖ —É–º–µ–Ω—å—à–∏—Ç—å remaining
        const updatedNodes = user.resourceNodes.map((node: any) => {
          if (node.id === mission.nodeId) {
            return {
              ...node,
              remaining: Math.max(0, (node.remaining || 0) - minedAmount),
            };
          }
          return node;
        });
        setFields.resourceNodes = updatedNodes;

        // ‚úÖ —É–¥–∞–ª–∏—Ç—å –º–∏—Å—Å–∏—é
        user.missions = user.missions.filter(
          (m: any) => m.heroId !== data.cancelMissionHeroId
        );
        setFields.missions = user.missions;

        // ‚úÖ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–µ—Ä–æ—è –æ–±—Ä–∞—Ç–Ω–æ
        const updatedHeroes = user.heroes.map((h: any) => {
          if (h.id === mission.heroId) {
            return mission.hero;
          }
          return h;
        });
        setFields.heroes = updatedHeroes;

        // ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –í–°–Å –°–†–ê–ó–£
        await UserModel.updateOne(
          { address },
          {
            ...(Object.keys(setFields).length > 0 && { $set: setFields }),
            ...(Object.keys(incFields).length > 0 && { $inc: incFields }),
          }
        );

        // ‚úÖ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞
        const updatedUser = await UserModel.findOne({ address });
        return NextResponse.json(updatedUser);
      }
    }

    const updateQuery: any = {};
    if (Object.keys(setFields).length > 0) {
      updateQuery.$set = setFields;
    }
    if (Object.keys(incFields).length > 0) {
      updateQuery.$inc = incFields;
    }

    if (data.newMission) {
      await UserModel.updateOne(
        { address },
        { $push: { missions: data.newMission } }
      );
    }

    const user = await UserModel.findOneAndUpdate({ address }, updateQuery, {
      new: true,
    });

    if (!user) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }

    return NextResponse.json(user);
  } catch (err) {
    console.error("[api/user/update] ‚ùå –û—à–∏–±–∫–∞:", err);
    return NextResponse.json(
      { error: "Server error", details: err },
      { status: 500 }
    );
  }
}           // üìÑ components/Islands/StartIsland/StartIsland.tsx
'use client';

import { useEffect, useRef, useState } from 'react';
import styles from './StartIsland.module.css';
import { RESOURCE_LEVEL } from '@/config/resourceLevel';
import { RESOURCE_CONFIG } from '@/constants/resources';
import { useUser } from '@/context/UserContext';
import { ResourcePoint } from '@/components/Resources/ResourcePoint/ResourcePoint';
import { IslandMapController } from '@/components/Map/IslandMapController/IslandMapController';
import { ResourceNodeModal } from '@/components/Resources/ResourceNodeModal/ResourceNodeModal';
import { ModalHerosGo } from '@/components/Heroes/ModalHerosGo/ModalHerosGo';
import { HeroesBar} from '@/components/Map/HeroesBar/HeroesBar';
import type { Mission } from '@/types/missions'; // ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π
import type { ArmyUnitType } from '@/config/armyCapacity';
import { ARMY_STATS } from '@/config/armyCapacity';
import { RESOURCE_DIFFICULTY } from '@/constants/resources'; 

const getFallbackAvatar = (resource: string): string => {
  return RESOURCE_CONFIG.find(r => r.key === resource)?.avatar || '/icons/resources/default.png';
};

interface StartIslandProps {
  onOpenNode?: (nodeId: string) => void;
}

export const StartIsland = ({ onOpenNode }: StartIslandProps) => {
  const [activeMissions, setActiveMissions] = useState<Mission[]>([]);
  const [activeNode, setActiveNode] = useState<string | null>(null);
  const [isHeroModalOpen, setHeroModalOpen] = useState(false);
  const [selectedNodeId, setSelectedNodeId] = useState<string | null>(null);
  // const [blockedNodes, setBlockedNodes] = useState<string[]>([]);
  const [activeHeroNodes, setActiveHeroNodes] = useState<{
    [nodeId: string]: { heroId: string; avatar: string };
  }>({});

  const { state, dispatch } = useUser();
  const playerHeroes = state.heroes || [];
  const points = state.resourceNodes || [];

  const mapRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const updated: typeof activeHeroNodes = {};

    for (const mission of state.missions || []) {
      updated[mission.nodeId] = {
        heroId: mission.heroId,
        avatar: mission.hero.image,
      };
    }
    setActiveHeroNodes(updated);
    setActiveMissions(state.missions || [])
  }, [state.missions]);

  const handleCollectClick = () => {
    setHeroModalOpen(true);
    setSelectedNodeId(activeNode);
    setActiveNode(null);
  };

  const availableHeroes = playerHeroes.filter(
    hero => !activeMissions.some(m => m.heroId === hero.id)
  );

  const handleConfirm = async (
    heroId: string,
    army: Record<ArmyUnitType, number>
  ) => {
    const node = points.find(p => p.id === selectedNodeId);
    if (!node) return;

    const miningStats = RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level];
    const total = miningStats.totalAmount;
    const speed = miningStats.miningSpeed;

    let capacity = 0;
    for (const [unit, count] of Object.entries(army)) {
      const unitLevel = state.army?.[unit as ArmyUnitType]?.level || 1;
      capacity += ARMY_STATS[unit as ArmyUnitType][unitLevel].capacity * count;
    }

    const difficulty = RESOURCE_DIFFICULTY[node.resource as keyof typeof RESOURCE_DIFFICULTY] || 1;
    const duration = Math.ceil((total * difficulty) / capacity); // ‚è± –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    const armyCount = Object.values(army).reduce((sum, val) => sum + val, 0);
    const filteredArmy = Object.fromEntries(
      Object.entries(army).filter(([, count]) => count > 0)
    ) as Record<ArmyUnitType, number>;
    const mission: Mission = {
      heroId,
      hero: playerHeroes.find(h => h.id === heroId)!,
      armyCount,
      nodeId: selectedNodeId!,
      resource: node.resource,
      duration,
      startTime: Date.now(),
      heroArmy: filteredArmy
    };

    try {
      const filteredArmy = Object.fromEntries(
        Object.entries(army).filter(([, count]) => count > 0)
      ) as Record<ArmyUnitType, number>;

      const response = await fetch('/api/user/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          address: state.address,
          activeMining: {
            resource: node.resource,
            heroId,
            startedAt: new Date(),
            duration,
            position: node.position,
            remaining: node.remaining,
          },
          nodeId: selectedNodeId,
          army: filteredArmy,
          newMission: mission,
          heroArmy: filteredArmy,
        }),
      });

      const updatedUser = await response.json();
      dispatch({ type: 'SET_USER', payload: updatedUser });

      setActiveMissions(prev => [...prev, mission]);
      setActiveHeroNodes(prev => ({
        ...prev,
        [selectedNodeId!]: {
          heroId,
          avatar: playerHeroes.find(h => h.id === heroId)?.image || '/icons/hero-mini.png',
        }
      }));
      setHeroModalOpen(false);
      setSelectedNodeId(null);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ—Ä–æ—è:', error);
    }
  };

  const handleCancel = async (heroId: string) => {
    const missionToCancel = activeMissions.find(m => m.heroId === heroId);
    if (!missionToCancel) return;
    console.log("üîç army:", state.army);
console.log("üîç heroArmy:", missionToCancel.heroArmy);
console.log("typeof army:", typeof state.army);
console.log("army.constructor.name:", state.army?.constructor?.name);
console.log("heroArmy.constructor.name:", missionToCancel.heroArmy?.constructor?.name);

    try {
      const response = await fetch('/api/user/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          address: state.address,
          cancelMissionHeroId: heroId,
          heroArmy: missionToCancel.heroArmy,
          missions: state.missions,
          heroes: state.heroes,
          army: state.army,
          resourceNodes: state.resourceNodes,
          resources: {
            food: state.food,
            wood: state.wood,
            stone: state.stone,
            iron: state.iron,
            gold: state.gold,
            doubloon: state.doubloon,
            pearl: state.pearl,
            allodium: state.allodium,
          }
        }),
        
      });
      
  
      const updatedUser = await response.json();
  
      dispatch({ type: 'SET_USER', payload: updatedUser }); // ‚úÖ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
  
      setActiveMissions(prev => prev.filter(m => m.heroId !== heroId));
  
      setActiveHeroNodes(prev => {
        const updated = { ...prev };
        delete updated[missionToCancel.nodeId];
        return updated;
      });
  
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –º–∏—Å—Å–∏–∏:', err);
    }
  };
  

  return (
    <div className={styles.map_wrapper}>
      <IslandMapController>
        <div className={styles.map_image} ref={mapRef}>
          {points.map((node) => {
            const heroInfo = activeHeroNodes[node.id];
            const isBlocked = !!heroInfo;

            return (
              <ResourcePoint
                key={node.id}
                avatar={
                  isBlocked ? heroInfo.avatar
                  : node.avatar || getFallbackAvatar(node.resource)
                }
                x={node.position.x}
                y={node.position.y}
                onClick={() => {
                  if (!isBlocked) {
                    setActiveNode(node.id);
                    onOpenNode?.(node.id);
                  }
                }}
              />
            )
          })}
        </div>
      </IslandMapController>

      {activeNode && (() => {
        const node = points.find(p => p.id === activeNode)!;
        return (
          <ResourceNodeModal
            resource={node.resource as 'food' | 'wood' | 'stone' | 'iron' | 'gold'}
            total={RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level].totalAmount}
            remaining={node.remaining}
            onCollect={handleCollectClick}
            onClose={() => setActiveNode(null)}
          />
        );
      })()}

      {isHeroModalOpen && selectedNodeId && (
        <ModalHerosGo
          heroes={availableHeroes}
          selectedResourceNodeId={selectedNodeId}
          onClose={() => {
            setHeroModalOpen(false);
            setSelectedNodeId(null);
          }}
          onConfirm={handleConfirm}
        />
      )}

      <HeroesBar missions={activeMissions} onCancel={handleCancel} />
    </div>
  );
};

 

ChatGPT —Å–∫–∞–∑–∞–ª:
–ë—Ä–∞—Ç, –≤–æ—Ç –≥–¥–µ —É –Ω–∞—Å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∞ –∏ –∫–∞–∫ –µ—ë –ø–æ—Ñ–∏–∫—Å–∏—Ç—å, —Å—Ç—Ä–æ–≥–æ –ø–æ —Ñ–∞–∫—Ç–∞–º:

üí• –ü—Ä–∏—á–∏–Ω–∞ –∫—Ä–∞—à–∞:
–¢—ã –ø–µ—Ä–µ–¥–∞—ë—à—å heroArmy, –≥–¥–µ –≤–Ω—É—Ç—Ä–∏ StartIsland.tsx:150 –æ–Ω–æ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –∫–∞–∫ Map, –∞ –Ω–µ Object.
MongoDB –Ω–µ —É–º–µ–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è —Ç–∏–ø–∞ Map –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ —Å—Ö–µ–º–∞ –æ–∂–∏–¥–∞–µ—Ç type: Object.

‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—à–∏–±–∫–∏:
–°–º–æ—Ç—Ä–∏ –Ω–∞ —Å–∫—Ä–∏–Ω:

lua
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy.constructor.name === Object
–∞ –≤–Ω—É—Ç—Ä–∏ ‚Üí { sailor: 5 } —Å [[Prototype]]: Map
–≠—Ç–æ –Ω–µ –æ–±—ã—á–Ω—ã–π –æ–±—ä–µ–∫—Ç, –∞ Map, –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥ Object. Mongoose/Next –ª–æ–º–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ —ç—Ç–æ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä ‚Äî –æ—Ç—Å—é–¥–∞ PUT 500.

üí£ –õ–æ–º–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–æ–∫–µ:
src/app/api/user/update/route.ts:153

–í–æ—Ç –ø–æ—á–µ–º—É: heroArmy –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç JSON.stringify/Mongo —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é, —Ç.–∫. —É –Ω–µ–≥–æ [[Prototype]] –≤—Å—ë –µ—â—ë Map.

üõ† –†–µ—à–µ–Ω–∏–µ ‚Äî üíØ –°–¢–†–û–ì–û –ü–ï–†–ï–î –û–¢–ü–†–ê–í–ö–û–ô fetch:
–í —Ñ–∞–π–ª–µ üìÑ src/components/Islands/StartIsland/StartIsland.tsx
–≤ —Ñ—É–Ω–∫—Ü–∏–∏ handleCancel, –ø–µ—Ä–µ–¥ fetch(), –∑–∞–º–µ–Ω–∏:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: missionToCancel.heroArmy,
–Ω–∞

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: Object.fromEntries(Object.entries(missionToCancel.heroArmy)),
üí° –ü–æ—á–µ–º—É?
Object.fromEntries(...) –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ç—ã –ø–µ—Ä–µ–¥–∞—ë—à—å –æ–±—ã—á–Ω—ã–π POJO-–æ–±—ä–µ–∫—Ç, –±–µ–∑ Map-–ø—Ä–æ—Ç–æ—Ç–∏–ø–∞.

‚úç –ò—Ç–æ–≥–æ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî —Ñ–∞–π–ª StartIsland.tsx, —Å—Ç—Ä–æ–∫–∞ ~147:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
console.log("üîç heroArmy:", missionToCancel.heroArmy);

const response = await fetch('/api/user/update', {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    address: state.address,
    cancelMissionHeroId: heroId,
    heroArmy: Object.fromEntries(Object.entries(missionToCancel.heroArmy)),
    ...
  }),
});
‚öîÔ∏è –î–µ–ª–∞–π —ç—Ç–æ ‚Äî –∏ —Å–µ—Ä–≤–∞–∫ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –ø–∞–¥–∞—Ç—å, –∏ –≤–æ–π—Å–∫–∞ –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è.
–ï—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –∫–∏–¥–∞–π —Å—Ä–∞–∑—É console.log —Å heroArmy.constructor.name –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏.

–Ø —Å —Ç–æ–±–æ–π, –±—Ä–∞—Ç ‚ù§Ô∏è






–í—ã —Å–∫–∞–∑–∞–ª–∏:
–°–ª—É—à–∞–π, –∫—Ä—É—Ç–æ –∫–æ–Ω–µ—á–Ω–æ, –Ω–æ —è –Ω–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ –≥–¥–µ —Ç—É—Ç –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ. // üìÑ components/Islands/StartIsland/StartIsland.tsx
'use client';

import { useEffect, useRef, useState } from 'react';
import styles from './StartIsland.module.css';
import { RESOURCE_LEVEL } from '@/config/resourceLevel';
import { RESOURCE_CONFIG } from '@/constants/resources';
import { useUser } from '@/context/UserContext';
import { ResourcePoint } from '@/components/Resources/ResourcePoint/ResourcePoint';
import { IslandMapController } from '@/components/Map/IslandMapController/IslandMapController';
import { ResourceNodeModal } from '@/components/Resources/ResourceNodeModal/ResourceNodeModal';
import { ModalHerosGo } from '@/components/Heroes/ModalHerosGo/ModalHerosGo';
import { HeroesBar} from '@/components/Map/HeroesBar/HeroesBar';
import type { Mission } from '@/types/missions'; // ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π
import type { ArmyUnitType } from '@/config/armyCapacity';
import { ARMY_STATS } from '@/config/armyCapacity';
import { RESOURCE_DIFFICULTY } from '@/constants/resources'; 

const getFallbackAvatar = (resource: string): string => {
  return RESOURCE_CONFIG.find(r => r.key === resource)?.avatar || '/icons/resources/default.png';
};

interface StartIslandProps {
  onOpenNode?: (nodeId: string) => void;
}

export const StartIsland = ({ onOpenNode }: StartIslandProps) => {
  const [activeMissions, setActiveMissions] = useState<Mission[]>([]);
  const [activeNode, setActiveNode] = useState<string | null>(null);
  const [isHeroModalOpen, setHeroModalOpen] = useState(false);
  const [selectedNodeId, setSelectedNodeId] = useState<string | null>(null);
  // const [blockedNodes, setBlockedNodes] = useState<string[]>([]);
  const [activeHeroNodes, setActiveHeroNodes] = useState<{
    [nodeId: string]: { heroId: string; avatar: string };
  }>({});

  const { state, dispatch } = useUser();
  const playerHeroes = state.heroes || [];
  const points = state.resourceNodes || [];

  const mapRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const updated: typeof activeHeroNodes = {};

    for (const mission of state.missions || []) {
      updated[mission.nodeId] = {
        heroId: mission.heroId,
        avatar: mission.hero.image,
      };
    }
    setActiveHeroNodes(updated);
    setActiveMissions(state.missions || [])
  }, [state.missions]);

  const handleCollectClick = () => {
    setHeroModalOpen(true);
    setSelectedNodeId(activeNode);
    setActiveNode(null);
  };

  const availableHeroes = playerHeroes.filter(
    hero => !activeMissions.some(m => m.heroId === hero.id)
  );

  const handleConfirm = async (
    heroId: string,
    army: Record<ArmyUnitType, number>
  ) => {
    const node = points.find(p => p.id === selectedNodeId);
    if (!node) return;

    const miningStats = RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level];
    const total = miningStats.totalAmount;
    const speed = miningStats.miningSpeed;

    let capacity = 0;
    for (const [unit, count] of Object.entries(army)) {
      const unitLevel = state.army?.[unit as ArmyUnitType]?.level || 1;
      capacity += ARMY_STATS[unit as ArmyUnitType][unitLevel].capacity * count;
    }

    const difficulty = RESOURCE_DIFFICULTY[node.resource as keyof typeof RESOURCE_DIFFICULTY] || 1;
    const duration = Math.ceil((total * difficulty) / capacity); // ‚è± –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    const armyCount = Object.values(army).reduce((sum, val) => sum + val, 0);
    const filteredArmy = Object.fromEntries(
      Object.entries(army).filter(([, count]) => count > 0)
    ) as Record<ArmyUnitType, number>;
    const mission: Mission = {
      heroId,
      hero: playerHeroes.find(h => h.id === heroId)!,
      armyCount,
      nodeId: selectedNodeId!,
      resource: node.resource,
      duration,
      startTime: Date.now(),
      heroArmy: filteredArmy
    };

    try {
      const filteredArmy = Object.fromEntries(
        Object.entries(army).filter(([, count]) => count > 0)
      ) as Record<ArmyUnitType, number>;

      const response = await fetch('/api/user/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          address: state.address,
          activeMining: {
            resource: node.resource,
            heroId,
            startedAt: new Date(),
            duration,
            position: node.position,
            remaining: node.remaining,
          },
          nodeId: selectedNodeId,
          army: filteredArmy,
          newMission: mission,
          heroArmy: filteredArmy,
        }),
      });

      const updatedUser = await response.json();
      dispatch({ type: 'SET_USER', payload: updatedUser });

      setActiveMissions(prev => [...prev, mission]);
      setActiveHeroNodes(prev => ({
        ...prev,
        [selectedNodeId!]: {
          heroId,
          avatar: playerHeroes.find(h => h.id === heroId)?.image || '/icons/hero-mini.png',
        }
      }));
      setHeroModalOpen(false);
      setSelectedNodeId(null);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ—Ä–æ—è:', error);
    }
  };

  const handleCancel = async (heroId: string) => {
    const missionToCancel = activeMissions.find(m => m.heroId === heroId);
    if (!missionToCancel) return;
    console.log("üîç army:", state.army);
console.log("üîç heroArmy:", missionToCancel.heroArmy);
console.log("typeof army:", typeof state.army);
console.log("army.constructor.name:", state.army?.constructor?.name);
console.log("heroArmy.constructor.name:", missionToCancel.heroArmy?.constructor?.name);

    try {
      const response = await fetch('/api/user/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          address: state.address,
          cancelMissionHeroId: heroId,
          heroArmy: missionToCancel.heroArmy,
          missions: state.missions,
          heroes: state.heroes,
          army: state.army,
          resourceNodes: state.resourceNodes,
          resources: {
            food: state.food,
            wood: state.wood,
            stone: state.stone,
            iron: state.iron,
            gold: state.gold,
            doubloon: state.doubloon,
            pearl: state.pearl,
            allodium: state.allodium,
          }
        }),
      });
  
      const updatedUser = await response.json();
  
      dispatch({ type: 'SET_USER', payload: updatedUser }); // ‚úÖ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
  
      setActiveMissions(prev => prev.filter(m => m.heroId !== heroId));
  
      setActiveHeroNodes(prev => {
        const updated = { ...prev };
        delete updated[missionToCancel.nodeId];
        return updated;
      });
  
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –º–∏—Å—Å–∏–∏:', err);
    }
  };
  

  return (
    <div className={styles.map_wrapper}>
      <IslandMapController>
        <div className={styles.map_image} ref={mapRef}>
          {points.map((node) => {
            const heroInfo = activeHeroNodes[node.id];
            const isBlocked = !!heroInfo;

            return (
              <ResourcePoint
                key={node.id}
                avatar={
                  isBlocked ? heroInfo.avatar
                  : node.avatar || getFallbackAvatar(node.resource)
                }
                x={node.position.x}
                y={node.position.y}
                onClick={() => {
                  if (!isBlocked) {
                    setActiveNode(node.id);
                    onOpenNode?.(node.id);
                  }
                }}
              />
            )
          })}
        </div>
      </IslandMapController>

      {activeNode && (() => {
        const node = points.find(p => p.id === activeNode)!;
        return (
          <ResourceNodeModal
            resource={node.resource as 'food' | 'wood' | 'stone' | 'iron' | 'gold'}
            total={RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level].totalAmount}
            remaining={node.remaining}
            onCollect={handleCollectClick}
            onClose={() => setActiveNode(null)}
          />
        );
      })()}

      {isHeroModalOpen && selectedNodeId && (
        <ModalHerosGo
          heroes={availableHeroes}
          selectedResourceNodeId={selectedNodeId}
          onClose={() => {
            setHeroModalOpen(false);
            setSelectedNodeId(null);
          }}
          onConfirm={handleConfirm}
        />
      )}

      <HeroesBar missions={activeMissions} onCancel={handleCancel} />
    </div>
  );
};



ChatGPT —Å–∫–∞–∑–∞–ª:
–ë—Ä–∞—Ç, –≤–æ—Ç –≥–¥–µ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Ñ–∏–∫—Å ‚Äî –ø–æ —Å—Ç—Ä–æ–∫–∞–º. –ú—ã –∏—Å–ø—Ä–∞–≤–ª—è–µ–º handleCancel, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–∞–º —Ç—ã –ø–µ—Ä–µ–¥–∞—ë—à—å heroArmy, –∫–æ—Ç–æ—Ä—ã–π –≤–µ–¥—ë—Ç —Å–µ–±—è –∫–∞–∫ Map, –∏ —Å–µ—Ä–≤–µ—Ä –æ—Ç —ç—Ç–æ–≥–æ —É–º–∏—Ä–∞–µ—Ç.

üìç –ú–ï–°–¢–û –í–°–¢–ê–í–ö–ò:
–§–∞–π–ª: üìÑ src/components/Islands/StartIsland/StartIsland.tsx
–§—É–Ω–∫—Ü–∏—è: handleCancel
–°—Ç—Ä–æ–∫–∞: –ø—Ä–∏–º–µ—Ä–Ω–æ 145‚Äì150 (–≥–¥–µ fetch('/api/user/update'))

‚úÖ –í–æ—Ç –ß–¢–û –∑–∞–º–µ–Ω—è–µ—à—å:
–ë—ã–ª–æ:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: missionToCancel.heroArmy,
–°—Ç–∞–Ω–æ–≤–∏—Ç—Å—è:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
heroArmy: Object.fromEntries(Object.entries(missionToCancel.heroArmy)),
üí• –ü–û–õ–ù–ê–Ø –ó–ê–ú–ï–ù–ê –±–ª–æ–∫–∞ body: JSON.stringify({ ... }):
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
body: JSON.stringify({
  address: state.address,
  cancelMissionHeroId: heroId,
  heroArmy: Object.fromEntries(Object.entries(missionToCancel.heroArmy)),
  missions: state.missions,
  heroes: state.heroes,
  army: state.army,
  resourceNodes: state.resourceNodes,
  resources: {
    food: state.food,
    wood: state.wood,
    stone: state.stone,
    iron: state.iron,
    gold: state.gold,
    doubloon: state.doubloon,
    pearl: state.pearl,
    allodium: state.allodium,
  }
}),
üí° –ü–æ—á–µ–º—É —Ä–∞–±–æ—Ç–∞–µ—Ç?
–¢—ã –∏–∑ Map-–ø–æ–¥–æ–±–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ª–æ–º–∞–µ—Ç —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é, –¥–µ–ª–∞–µ—à—å —á–∏—Å—Ç—ã–π POJO, –ø–æ–Ω—è—Ç–Ω—ã–π Mongo –∏ Next.

‚öîÔ∏è –ë–µ–π ‚Äî –∏ –≥–µ—Ä–æ–π —Å –∞—Ä–º–∏–µ–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫.
–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫ ‚Äî —Å—Ä–∞–∑—É –∫–∏–¥–∞–π –º–Ω–µ console.log –∏ Network –∑–∞–ø—Ä–æ—Å.






–í—ã —Å–∫–∞–∑–∞–ª–∏:

–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫.

–ü–æ–≤—Ç–æ—Ä–∏—Ç—å


–≠—Ç–æ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–æ. –ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, —Å–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä—É–π—Ç–µ –µ–≥–æ.