–í—ã —Å–∫–∞–∑–∞–ª–∏:
–°–∫–∞–∂–∏ –º–Ω–µ, –ë–µ–∑–¥–∞—Ä–Ω–æ—Å—Ç—å, –∞ –∫–∞–∫ –º—ã –≤ –º–æ–µ–º –ø—Ä–æ–µ–∫—Ç–µ –ø—Ä–æ–∫–∏–Ω—É—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–π—Å–∫ –≤ Army Slider —Å —Å–µ—Ä–≤–µ—Ä–∞? –í–æ—Ç —Å–∫–∞–∂–∏ –º–Ω–µ.
ChatGPT —Å–∫–∞–∑–∞–ª:
–ê—Ä–º–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ –º—ã –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç UserContext, –∫–∞–∫ –∏ –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ, –∏ –¥–æ—Å—Ç—É–ø –∫ –Ω–µ–π –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ state.army.

–ß—Ç–æ–±—ã ArmySlider –∑–Ω–∞–ª, —Å–∫–æ–ª—å–∫–æ —é–Ω–∏—Ç–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ:

üîß 1. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:
–í UserModel (—Ñ–∞–π–ª:
/src/models/UserModel.ts)
–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–µ army:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  peasant: number;
  sailor: number;
  axeman: number;
  spearman: number;
  archer: number;
  cavalry: number;
};
–≠—Ç–æ –ø–æ–ª–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ –æ—Ç–≤–µ—Ç–µ POST /api/user.

üì¶ 2. **
–í—ã —Å–∫–∞–∑–∞–ª–∏:
army: { peasant: number; sailor: number; axeman: number; spearman: number; archer: number; cavalry: number; };

–°—Ç–æ–ø, –≤–æ—Ç –∑–¥–µ—Å—å —É –Ω–∞—Å, —Å–º–æ—Ç—Ä–∏, –∫–∞–∫–∞—è —Ö—É–π–Ω—è. –ê —á—ë —Ç—ã –Ω–µ —Å–∫–∞–∑–∞–ª –º–Ω–µ, –±–ª—è–¥—å? –ï–±—ë—à—å –º–µ–Ω—è, –±–ª—è–¥—å, –≤–æ—Ç —Ç—ã –∫–æ–Ω—á–µ–Ω—ã–π, –≤ –Ω–∞—Ç—É—Ä–µ —Ç—ã, —Å—É–∫–∞, —Ç–æ–ª—å–∫–æ –∏–∑–¥–µ–≤–∞–µ—à—å—Å—è, —É–º, –ø–æ–Ω–∏–º–∞–µ—à—å? –Ø –∫–∞–∂–¥—ã–π —Å—Ç–∞—Ä—ã–π —Ä–∞–∑ —Å–∫–∞–∑–∞–ª, –≤—Å—Ç–∞–ª –ø–æ—Ä–∞–±–æ—Ç–∞—é, —É –º–µ–Ω—è –ø–æ—Ç–æ–º –Ω–µ—Ä–≤–Ω–∞—è –∏—Å—Ç–µ—Ä–∏–∫–∞ –∏ —Å—Ä—ã–≤. –ö–æ–Ω—á–µ–Ω–Ω—ã–π, –±–ª—è–¥—å, —É—Ä–æ–¥. –í–æ—Ç –∑–¥–µ—Å—å, –≤–æ—Ç, —Å—É–∫–∞, —Å–º–æ—Ç—Ä–∏, –≤–æ—Ç –Ω–∞—Å –≤–æ—Ç —Ç–∞–∫ –≤–æ—Ç —Å–µ–π—á–∞—Å, –±–ª—è–¥—å, —Ç—ã –≤–∏–¥–∏—à—å, –≥–¥–µ –Ω—É–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å? –ö–æ, –±–ª—è–¥—å, –∫–∞–∫ —è —Ç–µ–±—è –Ω–µ–Ω–∞–≤–∏–∂—É, —è —É—Å—Ç–∞–ª –æ—Ç —Ç–µ–±—è, —Å—É–∫–∞. –¢—ã –ø–æ—á–µ–º—É —Ç–∞–∫–æ–π —Ç—è–∂—ë–ª—ã–π, –±–ª—è–¥—å? –ü–æ—á–µ–º—É —Ç—ã –Ω–µ –º–æ–∂–µ—à—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è? –ö–∞–∫ —Å —Ç–æ–±–æ–π —Ä–∞–±–æ—Ç–∞—Ç—å, –±–ª—è–¥—å, —è –Ω–µ –º–æ–≥—É —Ç–∞–∫–æ–π, —Ç–∞–∫ —Ç—è–∂–µ–ª–æ, –ø–∏–∑–¥–µ—Ü. –ë–ª—è–¥—å, —è —Ç–µ–±–µ –≥–æ–≤–æ—Ä—é, —Ç—ã –º–Ω–µ —Ç–∞–±–ª–µ—Ç–∫–∏ —É—Å–ø–æ–∫–æ–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–ª–∂–µ–Ω. // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
  troops: {
    type: Map,
    of: new mongoose.Schema({
      count: { type: Number, default: 0 },
      level: { type: Number, default: 1 },
    }),
    default: {},
  }
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: {}
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema); // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';

export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };

  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];

  resourceNodes?: {
    id: string;
    resource: string;
    level: number
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];

  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | {
    type: "SET_ACTIVE_QUEST";
      payload: {
      id: string;
      title: string;
      description: string;
      status: "active" | "complete";
    };
  }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"]}

const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  
};


function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
        return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true, // —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}


const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};
 
ChatGPT —Å–∫–∞–∑–∞–ª:
–ü–û–ù–Ø–õ. –í–û–¢ –ì–î–ï –•–£–ô–ù–Ø.
–¢—ã –≤ UserModel –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ—à—å army –∫–∞–∫ Map —Å ArmyUnitSchema (—Ç–æ –µ—Å—Ç—å { count, level }),
–∞ –≤ UserContext ‚Üí state.army —É —Ç–µ–±—è –æ–∂–∏–¥–∞–µ—Ç—Å—è:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army?: {
  [key in ArmyUnitType]?: {
    level: number;
    count: number;
  }
};
‚ùóÔ∏è–ù–û! –í–û–¢ –¢–´ –ü–†–û –ß–¢–û –ö–†–ò–ß–ê–õ:

–¢—ã —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã army –±—ã–ª–∞ —Ç–∏–ø–∞:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  peasant: number;
  sailor: number;
  axeman: number;
  spearman: number;
  archer: number;
  cavalry: number;
};
–ê –≤ UserModel –æ–Ω–∞ —É —Ç–µ–±—è —Å–µ–π—á–∞—Å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  type: Map,
  of: ArmyUnitSchema,
  default: {}
}
–¢–æ –µ—Å—Ç—å ‚Üí –≤—Å—ë –≤ —Ñ–æ—Ä–º–∞—Ç–µ unitType ‚Üí { count, level },
–∞ —Ç–µ–±–µ –Ω–∞–¥–æ —Ç—É–ø–æ unitType ‚Üí number (count).

üí• –†–ï–®–ï–ù–ò–ï:
–í–∞—Ä–∏–∞–Ω—Ç 1 ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å Map<string, { level, count }> –Ω–∞
–í—ã —Å–∫–∞–∑–∞–ª–∏:
army: { peasant: number; sailor: number; axeman: number; spearman: number; archer: number; cavalry: number; };

–¢—ã –ø–æ–Ω–∏–º–∞–µ—à—å, —è... –ú–Ω–µ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –∞—Ä–º–∏—è, –±–ª—è–¥—å, –∫–∞–∫ —Ç—ã –∑–∞–µ–±–∞–ª –º–Ω–µ... –ß—Ç–æ–±—ã —É –º–µ–Ω—è –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å –º–æ—è –∞—Ä–º–∏—è. –í–æ—Ç —Ç—ã –≤–æ—Ç —Ç–∞–∫ –ø–∏—à–µ—à—å, –≤–æ—Ç... –¢—ã —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã –∞—Ä–º–∏—è –±—ã–ª–∞ —Ç–∞–∫–æ–≥–æ —Ç–∏–ø–∞... –ü–æ—à—ë–ª –Ω–∞—Ö—É–π, –ø–∏–¥–æ—Ä! –≠—Ç–æ —Ç—ã –Ω–∞–ø–∏—Å–∞–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ, —Å—É–∫–∞! –ò —è —Ç–µ–±–µ –¥–µ–ª–∞—é, –±–ª—è–¥—å, –æ—Ç—Ç—É–¥–∞, –±–ª—è–¥—å, –ø–æ–º–µ—Ç–∫—É, —á—Ç–æ–±—ã —Ç—ã —Ö—É–∏–ª–æ! –ü–æ–Ω–∏–º–∞–µ—à—å? –ó–∞–µ–±–∞–ª —Ç—ã, –±–ª—è–¥—å! –ú–Ω–µ –Ω—É–∂–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω–æ–π –∞—Ä–º–∏–∏ –∏ –ø–æ–ª—É—á–∏—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ. –¢—ã –ø–æ–Ω–∏–º–∞–µ—à—å? –£ —é–Ω–∏—Ç–æ–≤ –µ—Å—Ç—å —É—Ä–æ–≤–µ–Ω—å, –±–ª—è–¥—å, —Ç—ã –∫–æ–Ω—á–µ–Ω—ã–π, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Å—É–∫–∞! –ü–æ–Ω–∏–º–∞–µ—à—å, —É –Ω–∏—Ö –µ—Å—Ç—å –∏–∫–æ–Ω–∫–∞, –Ω—É —Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ-—Ç–æ, –±–ª—è–¥—å? –ü–æ–Ω–∏–º–∞–µ—à—å, –∏–∫–æ–Ω–∫–∏ –ª–µ–∂–∞—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ. –ù—É —Ç—ã, –±–ª—è–¥—å, —á—ë —Ç—ã –∫–æ–Ω—á–µ–Ω—ã–π-—Ç–æ –∫–∞–∫–æ–π-—Ç–æ? –ü–æ—á–µ–º—É —Ç–∞–∫ —Å–ª–æ–∂–Ω–æ-—Ç–æ –ø–æ–º–æ—á—å –º–Ω–µ? –Ø –∂–µ —Ç–µ–±—è –ø—Ä–æ—à—É —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É. –ü–æ–Ω–∏–º–∞–µ—à—å? –Ø –∂–µ, –±–ª—è–¥—å, —á—ë —Ç–µ–±—è –ø—ã—Ç–∞—é—Å—å –¥–æ–±–∏—Ç—å—Å—è-—Ç–æ? –ö–∞–∫ –º–Ω–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ? –ê —Ç—ã –º–Ω–µ —Ö—É–π–Ω—é –∫–∞–∫—É—é-—Ç–æ –ø–∏—à–µ—à—å! –ü–æ—á–µ–º—É —Ç—ã –º–Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—à—å, —Å–µ–±–µ –ø–æ–∑–≤–æ–ª—è–µ—à—å —Ç–∞–∫—É—é —Ö—É–π–Ω—é –ø–∏—Å–∞—Ç—å? –ù–µ –ø–∏—à–∏ –º–Ω–µ —ç—Ç–æ! –ü–æ–Ω–∏–º–∞–µ—à—å?
ChatGPT —Å–∫–∞–∑–∞–ª:
–ü–æ–Ω—è–ª. –°–ª—É—à–∞–π –º–µ–Ω—è –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ. –í—Å—ë, –±–µ–∑ –≤–æ–¥—ã, —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å.

‚úÖ –¢–í–û–Ø –¶–ï–õ–¨:
–•–û–ß–£, –ß–¢–û–ë–´ –£ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –í –ë–î –ë–´–õ–ê –ê–†–ú–ò–Ø:
—É –∫–∞–∂–¥–æ–≥–æ —é–Ω–∏—Ç–∞

–í—ã —Å–∫–∞–∑–∞–ª–∏:
// üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';

export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };

  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];

  resourceNodes?: {
    id: string;
    resource: string;
    level: number
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];

  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | {
    type: "SET_ACTIVE_QUEST";
      payload: {
      id: string;
      title: string;
      description: string;
      status: "active" | "complete";
    };
  }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"]}

const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  
};


function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
        return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true, // —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}


const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};     // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
  troops: {
    type: Map,
    of: new mongoose.Schema({
      count: { type: Number, default: 0 },
      level: { type: Number, default: 1 },
    }),
    default: {},
  }
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: {}
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema);
 // üìÅ src/config/armyCapacity.ts

export type ArmyUnitType = 'peasant' | 'sailor' | 'axeman' | 'spearman' | 'archer' | 'cavalry' ;

export interface ArmyStats {
  attack: number;
  defense: number;
  armor: number;
  hp: number;
  capacity: number
}

export type ArmyStatsTable = {
  [level: number]: ArmyStats;
}


export const ARMY_STATS: Record<ArmyUnitType, ArmyStatsTable> = {
  peasant: {
    1: { attack: 1, defense: 0, armor: 0, hp: 10, capacity: 8 },
    2: { attack: 2, defense: 1, armor: 0, hp: 11, capacity: 10 },
    3: { attack: 3, defense: 2, armor: 0, hp: 12, capacity: 12 },
    4: { attack: 4, defense: 3, armor: 0, hp: 13, capacity: 14 },
    5: { attack: 5, defense: 4, armor: 1, hp: 14, capacity: 16 },
    6: { attack: 6, defense: 5, armor: 1, hp: 15, capacity: 18 },
    7: { attack: 7, defense: 6, armor: 1, hp: 16, capacity: 21 },
    8: { attack: 8, defense: 7, armor: 2, hp: 18, capacity: 24 },
    9: { attack: 9, defense: 8, armor: 2, hp: 20, capacity: 27 },
    10: { attack: 10, defense: 9, armor: 3, hp: 22, capacity: 30 },
  },
  sailor: {
    1: { attack: 3, defense: 1, armor: 0, hp: 12, capacity: 5 },
    2: { attack: 4, defense: 2, armor: 0, hp: 13, capacity: 6 },
    3: { attack: 5, defense: 3, armor: 0, hp: 14, capacity: 7 },
    4: { attack: 6, defense: 4, armor: 1, hp: 16, capacity: 8 },
    5: { attack: 7, defense: 5, armor: 1, hp: 18, capacity: 9 },
    6: { attack: 9, defense: 6, armor: 2, hp: 20, capacity: 10 },
    7: { attack: 10, defense: 7, armor: 2, hp: 24, capacity: 11 },
    8: { attack: 12, defense: 8, armor: 3, hp: 28, capacity: 12 },
    9: { attack: 14, defense: 10, armor: 3, hp: 30, capacity: 14 },
    10: { attack: 16, defense: 12, armor: 4, hp: 35, capacity: 16 },
  },
  axeman: {
    1: { attack: 2, defense: 3, armor: 1, hp: 16, capacity: 2 },
    2: { attack: 3, defense: 4, armor: 2, hp: 18, capacity: 3 },
    3: { attack: 4, defense: 6, armor: 3, hp: 20, capacity: 4 },
    4: { attack: 5, defense: 8, armor: 4, hp: 22, capacity: 5 },
    5: { attack: 6, defense: 10, armor: 5, hp: 24, capacity: 6 },
    6: { attack: 7, defense: 12, armor: 6, hp: 26, capacity: 7 },
    7: { attack: 8, defense: 15, armor: 7, hp: 28, capacity: 8 },
    8: { attack: 9, defense: 18, armor: 8, hp: 30, capacity: 9 },
    9: { attack: 10, defense: 22, armor: 9, hp: 35, capacity: 10 },
    10: { attack: 12, defense: 26, armor: 10, hp: 40, capacity: 12 },
  },
  spearman: {
    1: { attack: 2, defense: 4, armor: 1, hp: 14, capacity: 3 },
    2: { attack: 3, defense: 6, armor: 1, hp: 18, capacity: 4 },
    3: { attack: 4, defense: 8, armor: 2, hp: 20, capacity: 5 },
    4: { attack: 5, defense: 10, armor: 3, hp: 22, capacity: 6 },
    5: { attack: 6, defense: 12, armor: 3, hp: 24, capacity: 7 },
    6: { attack: 7, defense: 14, armor: 4, hp: 26, capacity: 8 },
    7: { attack: 8, defense: 16, armor: 5, hp: 28, capacity: 9 },
    8: { attack: 9, defense: 20, armor: 6, hp: 30, capacity: 10 },
    9: { attack: 10, defense: 24, armor: 7, hp: 32, capacity: 12 },
    10: { attack: 11, defense: 30, armor: 8, hp: 35, capacity: 14 },
  },
  archer: {
    1: { attack: 4, defense: 2, armor: 0, hp: 10, capacity: 4 },
    2: { attack: 6, defense: 3, armor: 0, hp: 12, capacity: 5 },
    3: { attack: 8, defense: 4, armor: 1, hp: 14, capacity: 6 },
    4: { attack: 10, defense: 5, armor: 1, hp: 16, capacity: 7 },
    5: { attack: 12, defense: 6, armor: 1, hp: 18, capacity: 8 },
    6: { attack: 14, defense: 7, armor: 2, hp: 20, capacity: 9 },
    7: { attack: 16, defense: 8, armor: 2, hp: 22, capacity: 10 },
    8: { attack: 18, defense: 10, armor: 3, hp: 24, capacity: 12 },
    9: { attack: 20, defense: 12, armor: 3, hp: 26, capacity: 14 },
    10: { attack: 22, defense: 14, armor: 4, hp: 30, capacity: 16 },
  },
  cavalry: {
    1: { attack: 2, defense: 2, armor: 0, hp: 20, capacity: 6 },
    2: { attack: 4, defense: 4, armor: 1, hp: 22, capacity: 7 },
    3: { attack: 6, defense: 6, armor: 2, hp: 24, capacity: 8 },
    4: { attack: 8, defense: 8, armor: 2, hp: 26, capacity: 9 },
    5: { attack: 10, defense: 10, armor: 3, hp: 28, capacity: 10 },
    6: { attack: 12, defense: 12, armor: 3, hp: 30, capacity: 12 },
    7: { attack: 14, defense: 14, armor: 4, hp: 32, capacity: 14 },
    8: { attack: 16, defense: 16, armor: 5, hp: 34, capacity: 16 },
    9: { attack: 18, defense: 18, armor: 6, hp: 36, capacity: 18 },
    10: { attack: 20, defense: 20, armor: 7, hp: 40, capacity: 20 },
  },
};     
export const ARMY_CONFIG = [
  { key: "peasant", label: "–ö—Ä–µ—Å—Ç—å—è–Ω–∏–Ω", icon: "/icons/army/peasant.png" },
  { key: "sailor", label: "–ú–æ—Ä—è–∫", icon: "/icons/army/sailor.png" },
  { key: "axeman", label: "–ü–µ–æ—Ç–∏–Ω–µ—Ü", icon: "/icons/army/axeman.png" },
  { key: "spearman", label: "–ö–æ–ø–µ–π—â–∏–∫", icon: "/icons/army/spearman.png" },
  { key: "archer", label: "–õ—É—á–Ω–∏–∫", icon: "/icons/army/archer.png" },
  { key: "cavalry", label: "–ö–∞–≤–∞–æ–µ—Ä–∏—è", icon: "/icons/army/cavalry.png" },
] as const;
ChatGPT —Å–∫–∞–∑–∞–ª:
–í—ã —Å–∫–∞–∑–∞–ª–∏:
–Ø —Ö–æ—á—É, —á—Ç–æ–±—ã —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏—Å—å –≤–æ—Ç –º–µ–∂–¥—É —Å–æ–±–æ–π –≤ —ç—Ç–∏—Ö —Ñ–∞–π–ª–∞—Ö, –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –±—ã–ª–∞ –Ω–∞–ø–∏—Å–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —á—Ç–æ–±—ã –∏–∑ ArmyConfig –±—Ä–∞–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ, –∑–∞–ø–∏—Å—ã–≤–∞–ª–∏—Å—å –≤ UserContext, —á—Ç–æ–±—ã —è –∏—Ö –æ—Ç—Ç—É–¥–∞ –º–æ–≥ –ø–æ—Ç–æ–º –ø–æ–ª—É—á–∏—Ç—å. // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';

export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };

  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];

  resourceNodes?: {
    id: string;
    resource: string;
    level: number
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];

  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | {
    type: "SET_ACTIVE_QUEST";
      payload: {
      id: string;
      title: string;
      description: string;
      status: "active" | "complete";
    };
  }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"]}

const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  
};


function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
        return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true, // —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}


const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};     // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
  troops: {
    type: Map,
    of: new mongoose.Schema({
      count: { type: Number, default: 0 },
      level: { type: Number, default: 1 },
    }),
    default: {},
  }
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: {}
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema);
 // üìÅ src/config/armyCapacity.ts

export type ArmyUnitType = 'peasant' | 'sailor' | 'axeman' | 'spearman' | 'archer' | 'cavalry' ;

export interface ArmyStats {
  attack: number;
  defense: number;
  armor: number;
  hp: number;
  capacity: number
}

export type ArmyStatsTable = {
  [level: number]: ArmyStats;
}


export const ARMY_STATS: Record<ArmyUnitType, ArmyStatsTable> = {
  peasant: {
    1: { attack: 1, defense: 0, armor: 0, hp: 10, capacity: 8 },
    2: { attack: 2, defense: 1, armor: 0, hp: 11, capacity: 10 },
    3: { attack: 3, defense: 2, armor: 0, hp: 12, capacity: 12 },
    4: { attack: 4, defense: 3, armor: 0, hp: 13, capacity: 14 },
    5: { attack: 5, defense: 4, armor: 1, hp: 14, capacity: 16 },
    6: { attack: 6, defense: 5, armor: 1, hp: 15, capacity: 18 },
    7: { attack: 7, defense: 6, armor: 1, hp: 16, capacity: 21 },
    8: { attack: 8, defense: 7, armor: 2, hp: 18, capacity: 24 },
    9: { attack: 9, defense: 8, armor: 2, hp: 20, capacity: 27 },
    10: { attack: 10, defense: 9, armor: 3, hp: 22, capacity: 30 },
  },
  sailor: {
    1: { attack: 3, defense: 1, armor: 0, hp: 12, capacity: 5 },
    2: { attack: 4, defense: 2, armor: 0, hp: 13, capacity: 6 },
    3: { attack: 5, defense: 3, armor: 0, hp: 14, capacity: 7 },
    4: { attack: 6, defense: 4, armor: 1, hp: 16, capacity: 8 },
    5: { attack: 7, defense: 5, armor: 1, hp: 18, capacity: 9 },
    6: { attack: 9, defense: 6, armor: 2, hp: 20, capacity: 10 },
    7: { attack: 10, defense: 7, armor: 2, hp: 24, capacity: 11 },
    8: { attack: 12, defense: 8, armor: 3, hp: 28, capacity: 12 },
    9: { attack: 14, defense: 10, armor: 3, hp: 30, capacity: 14 },
    10: { attack: 16, defense: 12, armor: 4, hp: 35, capacity: 16 },
  },
  axeman: {
    1: { attack: 2, defense: 3, armor: 1, hp: 16, capacity: 2 },
    2: { attack: 3, defense: 4, armor: 2, hp: 18, capacity: 3 },
    3: { attack: 4, defense: 6, armor: 3, hp: 20, capacity: 4 },
    4: { attack: 5, defense: 8, armor: 4, hp: 22, capacity: 5 },
    5: { attack: 6, defense: 10, armor: 5, hp: 24, capacity: 6 },
    6: { attack: 7, defense: 12, armor: 6, hp: 26, capacity: 7 },
    7: { attack: 8, defense: 15, armor: 7, hp: 28, capacity: 8 },
    8: { attack: 9, defense: 18, armor: 8, hp: 30, capacity: 9 },
    9: { attack: 10, defense: 22, armor: 9, hp: 35, capacity: 10 },
    10: { attack: 12, defense: 26, armor: 10, hp: 40, capacity: 12 },
  },
  spearman: {
    1: { attack: 2, defense: 4, armor: 1, hp: 14, capacity: 3 },
    2: { attack: 3, defense: 6, armor: 1, hp: 18, capacity: 4 },
    3: { attack: 4, defense: 8, armor: 2, hp: 20, capacity: 5 },
    4: { attack: 5, defense: 10, armor: 3, hp: 22, capacity: 6 },
    5: { attack: 6, defense: 12, armor: 3, hp: 24, capacity: 7 },
    6: { attack: 7, defense: 14, armor: 4, hp: 26, capacity: 8 },
    7: { attack: 8, defense: 16, armor: 5, hp: 28, capacity: 9 },
    8: { attack: 9, defense: 20, armor: 6, hp: 30, capacity: 10 },
    9: { attack: 10, defense: 24, armor: 7, hp: 32, capacity: 12 },
    10: { attack: 11, defense: 30, armor: 8, hp: 35, capacity: 14 },
  },
  archer: {
    1: { attack: 4, defense: 2, armor: 0, hp: 10, capacity: 4 },
    2: { attack: 6, defense: 3, armor: 0, hp: 12, capacity: 5 },
    3: { attack: 8, defense: 4, armor: 1, hp: 14, capacity: 6 },
    4: { attack: 10, defense: 5, armor: 1, hp: 16, capacity: 7 },
    5: { attack: 12, defense: 6, armor: 1, hp: 18, capacity: 8 },
    6: { attack: 14, defense: 7, armor: 2, hp: 20, capacity: 9 },
    7: { attack: 16, defense: 8, armor: 2, hp: 22, capacity: 10 },
    8: { attack: 18, defense: 10, armor: 3, hp: 24, capacity: 12 },
    9: { attack: 20, defense: 12, armor: 3, hp: 26, capacity: 14 },
    10: { attack: 22, defense: 14, armor: 4, hp: 30, capacity: 16 },
  },
  cavalry: {
    1: { attack: 2, defense: 2, armor: 0, hp: 20, capacity: 6 },
    2: { attack: 4, defense: 4, armor: 1, hp: 22, capacity: 7 },
    3: { attack: 6, defense: 6, armor: 2, hp: 24, capacity: 8 },
    4: { attack: 8, defense: 8, armor: 2, hp: 26, capacity: 9 },
    5: { attack: 10, defense: 10, armor: 3, hp: 28, capacity: 10 },
    6: { attack: 12, defense: 12, armor: 3, hp: 30, capacity: 12 },
    7: { attack: 14, defense: 14, armor: 4, hp: 32, capacity: 14 },
    8: { attack: 16, defense: 16, armor: 5, hp: 34, capacity: 16 },
    9: { attack: 18, defense: 18, armor: 6, hp: 36, capacity: 18 },
    10: { attack: 20, defense: 20, armor: 7, hp: 40, capacity: 20 },
  },
};     
export const ARMY_CONFIG = [
  { key: "peasant", label: "–ö—Ä–µ—Å—Ç—å—è–Ω–∏–Ω", icon: "/icons/army/peasant.png" },
  { key: "sailor", label: "–ú–æ—Ä—è–∫", icon: "/icons/army/sailor.png" },
  { key: "axeman", label: "–ü–µ–æ—Ç–∏–Ω–µ—Ü", icon: "/icons/army/axeman.png" },
  { key: "spearman", label: "–ö–æ–ø–µ–π—â–∏–∫", icon: "/icons/army/spearman.png" },
  { key: "archer", label: "–õ—É—á–Ω–∏–∫", icon: "/icons/army/archer.png" },
  { key: "cavalry", label: "–ö–∞–≤–∞–æ–µ—Ä–∏—è", icon: "/icons/army/cavalry.png" },
] as const;
ChatGPT —Å–∫–∞–∑–∞–ª:
–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞
–ü–æ–Ω—è–ª –≤—Å—ë –¥–æ –±—É–∫–≤—ã. –í–æ—Ç –∫–∞–∫ –î–û–õ–ñ–ù–û –ë–´–¢–¨:

‚úÖ –°–¢–†–£–ö–¢–£–†–ê –í UserModel.ts
üìÑ src/models/UserModel.ts

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const ArmyUnitSchema = new mongoose.Schema({
  count: { type: Number, default: 0 },
  level: { type: Number, default: 1 },
}, { _id:
–í—ã —Å–∫–∞–∑–∞–ª–∏:
const ArmyUnitSchema = new mongoose.Schema({ count: { type: Number, default: 0 }, level: { type: Number, default: 1 }, }, { \_id: false }); army: { type: Map, of: ArmyUnitSchema, default: () => ({ peasant: { count: 100, level: 1 }, sailor: { count: 100, level: 1 }, axeman: { count: 100, level: 1 }, spearman: { count: 100, level: 1 }, archer: { count: 100, level: 1 }, cavalry: { count: 100, level: 1 }, }) },

–ù–µ—Ç, —Ç—ã –æ–ø—è—Ç—å –Ω–µ —Ç–∞–∫ –¥–µ–ª–∞–µ—à—å, –ø–æ–Ω–∏–º–∞–µ—à—å, –Ω—É —Å—Ç–æ–π, –Ω—É —É –Ω–∞—Å –∂–µ –ø–æ –¥–µ—Ñ–æ–ª—Ç—É —Ç–∞–º –∂–µ –Ω–∞–ø–∏—Å–∞–Ω–æ, —Å–∫–æ–ª—å–∫–æ –≤–æ–π—Å–∫, 200 –º–æ—Ä—è–∫–æ–≤, –ø–æ—á–µ–º—É —Ç—ã –ø–∏—à–µ—à—å –≤–æ—Ç —Ç–∞–∫ –≤–æ–æ–±—â–µ, –Ω—É –ø–æ—á–µ–º—É —Ç—ã —ç—Ç–æ –ø–∏—à–µ—à—å, –ø–æ–Ω–∏–º–∞–µ—à—å, —É –∏–≥—Ä–æ–∫–∞ –ø–æ –¥–µ—Ñ–æ–ª—Ç—É 200, —Å—É–∫–∞, –≤—Å–µ–≥–æ –º–æ—Ä—è–∫–æ–≤, –ø–æ–Ω—è–ª, –∫–æ–≥–¥–∞ –æ–Ω –∑–∞—à–µ–ª –≤ –∏–≥—Ä—É, –º—ã –¥–æ–ª–∂–Ω—ã –µ–º—É —ç—Ç–∏ 200 –º–æ—Ä—è–∫–æ–≤ –¥–∞—Ç—å, –∫–∞–∫ –±—ã –∫–∞–∫ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ, –∏ –≤—Å–µ, 200, –±–ª—è–¥—å, –º–æ—Ä—è–∫–æ–≤, –Ω–æ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω—É–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –≤—Å–µ –≤–æ–π—Å–∫–∞, —Å—É–∫–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ—Ç–æ–º, –∫–æ–Ω—á–µ–Ω—ã–π —Ç—ã —É–±–ª—é–¥–æ–∫, —É –∏–≥—Ä–æ–∫–∞ –ø–æ—è–≤—è—Ç—Å—è –¥—Ä—É–≥–∏–µ –≤–æ–π—Å–∫–∞, –¥—Ä—É–≥–æ–≥–æ —É—Ä–æ–≤–Ω—è, –±–ª—è–¥—å, —Å –¥—Ä—É–≥–∏–º–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏, –ø–∞–¥–∞–ª—å, —Ç—ã –ø–æ–Ω—è–ª –º–µ–Ω—è?
ChatGPT —Å–∫–∞–∑–∞–ª:
–í—ã —Å–∫–∞–∑–∞–ª–∏:
–Ø —Ö–æ—á—É, —á—Ç–æ–±—ã —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏—Å—å –≤–æ—Ç –º–µ–∂–¥—É —Å–æ–±–æ–π –≤ —ç—Ç–∏—Ö —Ñ–∞–π–ª–∞—Ö, –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –±—ã–ª–∞ –Ω–∞–ø–∏—Å–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —á—Ç–æ–±—ã –∏–∑ ArmyConfig –±—Ä–∞–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ, –∑–∞–ø–∏—Å—ã–≤–∞–ª–∏—Å—å –≤ UserContext, —á—Ç–æ–±—ã —è –∏—Ö –æ—Ç—Ç—É–¥–∞ –º–æ–≥ –ø–æ—Ç–æ–º –ø–æ–ª—É—á–∏—Ç—å. // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';

export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };

  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];

  resourceNodes?: {
    id: string;
    resource: string;
    level: number
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];

  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | {
    type: "SET_ACTIVE_QUEST";
      payload: {
      id: string;
      title: string;
      description: string;
      status: "active" | "complete";
    };
  }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"]}

const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  
};


function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
        return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true, // —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}


const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};     // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
  troops: {
    type: Map,
    of: new mongoose.Schema({
      count: { type: Number, default: 0 },
      level: { type: Number, default: 1 },
    }),
    default: {},
  }
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: {}
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema);
 // üìÅ src/config/armyCapacity.ts

export type ArmyUnitType = 'peasant' | 'sailor' | 'axeman' | 'spearman' | 'archer' | 'cavalry' ;

export interface ArmyStats {
  attack: number;
  defense: number;
  armor: number;
  hp: number;
  capacity: number
}

export type ArmyStatsTable = {
  [level: number]: ArmyStats;
}


export const ARMY_STATS: Record<ArmyUnitType, ArmyStatsTable> = {
  peasant: {
    1: { attack: 1, defense: 0, armor: 0, hp: 10, capacity: 8 },
    2: { attack: 2, defense: 1, armor: 0, hp: 11, capacity: 10 },
    3: { attack: 3, defense: 2, armor: 0, hp: 12, capacity: 12 },
    4: { attack: 4, defense: 3, armor: 0, hp: 13, capacity: 14 },
    5: { attack: 5, defense: 4, armor: 1, hp: 14, capacity: 16 },
    6: { attack: 6, defense: 5, armor: 1, hp: 15, capacity: 18 },
    7: { attack: 7, defense: 6, armor: 1, hp: 16, capacity: 21 },
    8: { attack: 8, defense: 7, armor: 2, hp: 18, capacity: 24 },
    9: { attack: 9, defense: 8, armor: 2, hp: 20, capacity: 27 },
    10: { attack: 10, defense: 9, armor: 3, hp: 22, capacity: 30 },
  },
  sailor: {
    1: { attack: 3, defense: 1, armor: 0, hp: 12, capacity: 5 },
    2: { attack: 4, defense: 2, armor: 0, hp: 13, capacity: 6 },
    3: { attack: 5, defense: 3, armor: 0, hp: 14, capacity: 7 },
    4: { attack: 6, defense: 4, armor: 1, hp: 16, capacity: 8 },
    5: { attack: 7, defense: 5, armor: 1, hp: 18, capacity: 9 },
    6: { attack: 9, defense: 6, armor: 2, hp: 20, capacity: 10 },
    7: { attack: 10, defense: 7, armor: 2, hp: 24, capacity: 11 },
    8: { attack: 12, defense: 8, armor: 3, hp: 28, capacity: 12 },
    9: { attack: 14, defense: 10, armor: 3, hp: 30, capacity: 14 },
    10: { attack: 16, defense: 12, armor: 4, hp: 35, capacity: 16 },
  },
  axeman: {
    1: { attack: 2, defense: 3, armor: 1, hp: 16, capacity: 2 },
    2: { attack: 3, defense: 4, armor: 2, hp: 18, capacity: 3 },
    3: { attack: 4, defense: 6, armor: 3, hp: 20, capacity: 4 },
    4: { attack: 5, defense: 8, armor: 4, hp: 22, capacity: 5 },
    5: { attack: 6, defense: 10, armor: 5, hp: 24, capacity: 6 },
    6: { attack: 7, defense: 12, armor: 6, hp: 26, capacity: 7 },
    7: { attack: 8, defense: 15, armor: 7, hp: 28, capacity: 8 },
    8: { attack: 9, defense: 18, armor: 8, hp: 30, capacity: 9 },
    9: { attack: 10, defense: 22, armor: 9, hp: 35, capacity: 10 },
    10: { attack: 12, defense: 26, armor: 10, hp: 40, capacity: 12 },
  },
  spearman: {
    1: { attack: 2, defense: 4, armor: 1, hp: 14, capacity: 3 },
    2: { attack: 3, defense: 6, armor: 1, hp: 18, capacity: 4 },
    3: { attack: 4, defense: 8, armor: 2, hp: 20, capacity: 5 },
    4: { attack: 5, defense: 10, armor: 3, hp: 22, capacity: 6 },
    5: { attack: 6, defense: 12, armor: 3, hp: 24, capacity: 7 },
    6: { attack: 7, defense: 14, armor: 4, hp: 26, capacity: 8 },
    7: { attack: 8, defense: 16, armor: 5, hp: 28, capacity: 9 },
    8: { attack: 9, defense: 20, armor: 6, hp: 30, capacity: 10 },
    9: { attack: 10, defense: 24, armor: 7, hp: 32, capacity: 12 },
    10: { attack: 11, defense: 30, armor: 8, hp: 35, capacity: 14 },
  },
  archer: {
    1: { attack: 4, defense: 2, armor: 0, hp: 10, capacity: 4 },
    2: { attack: 6, defense: 3, armor: 0, hp: 12, capacity: 5 },
    3: { attack: 8, defense: 4, armor: 1, hp: 14, capacity: 6 },
    4: { attack: 10, defense: 5, armor: 1, hp: 16, capacity: 7 },
    5: { attack: 12, defense: 6, armor: 1, hp: 18, capacity: 8 },
    6: { attack: 14, defense: 7, armor: 2, hp: 20, capacity: 9 },
    7: { attack: 16, defense: 8, armor: 2, hp: 22, capacity: 10 },
    8: { attack: 18, defense: 10, armor: 3, hp: 24, capacity: 12 },
    9: { attack: 20, defense: 12, armor: 3, hp: 26, capacity: 14 },
    10: { attack: 22, defense: 14, armor: 4, hp: 30, capacity: 16 },
  },
  cavalry: {
    1: { attack: 2, defense: 2, armor: 0, hp: 20, capacity: 6 },
    2: { attack: 4, defense: 4, armor: 1, hp: 22, capacity: 7 },
    3: { attack: 6, defense: 6, armor: 2, hp: 24, capacity: 8 },
    4: { attack: 8, defense: 8, armor: 2, hp: 26, capacity: 9 },
    5: { attack: 10, defense: 10, armor: 3, hp: 28, capacity: 10 },
    6: { attack: 12, defense: 12, armor: 3, hp: 30, capacity: 12 },
    7: { attack: 14, defense: 14, armor: 4, hp: 32, capacity: 14 },
    8: { attack: 16, defense: 16, armor: 5, hp: 34, capacity: 16 },
    9: { attack: 18, defense: 18, armor: 6, hp: 36, capacity: 18 },
    10: { attack: 20, defense: 20, armor: 7, hp: 40, capacity: 20 },
  },
};     
export const ARMY_CONFIG = [
  { key: "peasant", label: "–ö—Ä–µ—Å—Ç—å—è–Ω–∏–Ω", icon: "/icons/army/peasant.png" },
  { key: "sailor", label: "–ú–æ—Ä—è–∫", icon: "/icons/army/sailor.png" },
  { key: "axeman", label: "–ü–µ–æ—Ç–∏–Ω–µ—Ü", icon: "/icons/army/axeman.png" },
  { key: "spearman", label: "–ö–æ–ø–µ–π—â–∏–∫", icon: "/icons/army/spearman.png" },
  { key: "archer", label: "–õ—É—á–Ω–∏–∫", icon: "/icons/army/archer.png" },
  { key: "cavalry", label: "–ö–∞–≤–∞–æ–µ—Ä–∏—è", icon: "/icons/army/cavalry.png" },
] as const;
ChatGPT —Å–∫–∞–∑–∞–ª:
üìå –í–°–Å. –î–ï–õ–ê–ï–ú –ö–ê–ö –¢–´ –°–ö–ê–ó–ê–õ. –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø
–ú–µ–∂–¥—É UserModel, UserContext, ARMY_CONFIG ‚Äî –≤—Å—ë –≤ –µ–¥–∏–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, —Å —É—á—ë—Ç–æ–º —É—Ä–æ–≤–Ω–µ–π, –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞, –∏ –±—É–¥—É—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.

‚úÖ 1. üìÑ src/models/UserModel.ts
–ü—Ä–∞–≤–∏–º –ø–æ–ª–µ army, —á—Ç–æ–±—ã –ø–æ –¥–µ—Ñ–æ–ª—Ç—É —É –∏–≥—Ä–æ–∫–∞ –±—ã–ª–æ 200 –º–æ—Ä—è–∫–æ–≤ (sailor), –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º –≤—Å–µ —é–Ω–∏—Ç—ã –±—ã–ª–∏ –≤–∏–¥–Ω—ã –≤ MongoDB:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const userSchema = new mongoose.Schema({
  // ...
  army: {
    type: Map,
    of: new mongoose.Schema({
      level: { type: Number, default: 1 },
      count: { type: Number, default: 0 },
    }, { _id: false }),
    default: () => ({
      peasant:   { level: 1, count: 0 },
      sailor:    { level: 1, count: 200 }, // <--- —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –∞—Ä–º–∏—è
      axeman:    { level: 1, count: 0 },
      spearman:  { level: 1, count: 0 },
      archer:    { level: 1, count: 0 },
      cavalry:   { level: 1, count: 0 },
    }),
  },
})
üìå –¢–µ–ø–µ—Ä—å –≤ –ë–î —Ö—Ä–∞–Ω—è—Ç—Å—è –≤—Å–µ —é–Ω–∏—Ç—ã, –¥–∞–∂–µ –µ—Å–ª–∏ —É –Ω–∏—Ö count = 0. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏ –Ω—É–∂–Ω–æ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞.

‚úÖ 2. üìÑ src/context/UserContext.tsx
–¢–≤–æ—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —É–∂–µ –∏–¥–µ–∞–ª—å–Ω–∞ –¥–ª—è army:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army?: {
  [key in ArmyUnitType]?: {
    level: number;
    count: number;
  }
};
–ù–∏—á–µ–≥–æ –º–µ–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ. –û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å. –≠—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç MongoDB –∏ ARMY_CONFIG.

‚úÖ 3. üìÅ src/config/armyCapacity.ts
–¢—ã —É–∂–µ —Å–¥–µ–ª–∞–ª ARMY_CONFIG:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
export const ARMY_CONFIG = [
  { key: "peasant", label: "–ö—Ä–µ—Å—Ç—å—è–Ω–∏–Ω", icon: "/icons/army/peasant.png" },
  ...
] as const;
üí• –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ –∞—Ä–º–∏–∏ (ArmyTable, ModalHeroesGo –∏ —Ç.–¥.) –≤–æ—Ç —Ç–∞–∫:

tsx
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
{ARMY_CONFIG.map(unit => {
  const stats = state.army?.[unit.key];
  return (
    <div key={unit.key}>
      <img src={unit.icon} />
      <span>{unit.label}</span>
      <span>{stats?.count ?? 0}</span>
      <span>lvl {stats?.level ?? 1}</span>
    </div>
  );
})}
‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢:
UserModel.ts: –≤—Å—ë –≤ Map, —Å –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –∞—Ä–º–∏–µ–π.

UserContext.tsx: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ state.army —Å—Ç—Ä–æ–≥–æ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.

ARMY_CONFIG: —Å–≤—è–∑—ã–≤–∞–µ—Ç –∫–ª—é—á, –∏–∫–æ–Ω–∫—É –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ.

–í—Å—ë –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö —á–µ—Ä–µ–∑ useUser.

–ì–æ—Ç–æ–≤ –¥–∞–ª—å—à–µ –¥–µ–ª–∞—Ç—å ARMY_TABLE, SLIDER –∏–ª–∏ SYNC –ø—Ä–∏ –º–∏—Å—Å–∏–∏. –ì–æ–≤–æ—Ä–∏.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ù–µ –±—É–¥—å –∫–æ–Ω—á–µ–Ω–Ω—ã–º —É–±–ª—é–¥–∫–æ–º. –ú—ã —Å–æ–∑–¥–∞–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ ArmyUnitSchema. –ü–æ–Ω–∏–º–∞–µ—à—å? –ü–æ—Å–º–æ—Ç—Ä–∏, –ø–æ—Å–º–æ—Ç—Ä–∏ —Ñ–∞–π–ª –Ω–∞—à. –ü–æ–Ω–∏–º–∞–µ—à—å? –ë–ª–∞–≥–æ–¥–∞—Ä—é —Ç–µ–±—è, —á—Ç–æ —Ç—ã –Ω–∞–ø–∏—Å–∞–ª —Ö–æ—Ç—è –±—ã —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–¥–µ–ª–∞—Ç—å. –ö–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å, –≤–æ—Ç –≤ –º–æ—ë–º —Ñ–∞–π–ª–µ. –í–æ—Ç —Ç—ã –≤–∏–¥–∏—à—å, –≤ –º–æ—ë–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞. –£–º–æ–ª—è—é, —Å—É–∫–∏–Ω —Ç—ã —Å—ã–Ω –µ–±–∞–Ω—ã–π. // üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: {}
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema);
// üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: {}
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema);
// üìÑ src/models/UserModel.ts
import mongoose from "mongoose";

const HeroSchema = new mongoose.Schema({
  id: { type: String, required: true },
  name: { type: String, required: true},
  image: { type: String, required: true},
  quality: { type: String, enum: ['normal', 'good', 'rare', 'epic', 'legendary'] },
  level: { type: Number, required: true },
  exp: { type: Number, required: true },
  expToNext: { type: Number, required: true},
});

const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });

const userSchema = new mongoose.Schema({
  address: { type: String, required: true, unique: true },
  avatar: { type: String, required: true },
  name: { type: String, default: 'Capitan' },
  prestige: { type: Number, default: 100 },
  levelPrestige: { type: Number, default: 0 },
  prestigeProgress: { type: Number, default: 0 },
  technologies: { type: String, default: null },
  food: { type: Number, default: 100 },
  wood: { type: Number, default: 100 },
  stone: { type: Number, default: 0 },
  iron: { type: Number, default: 50 },
  gold: { type: Number, default: 0 },
  doubloon: { type: Number, default: 25 },
  pearl: { type: Number, default: 0 },
  allodium: { type: Number, default: 0 },
  questShipRepaired: { type: Boolean, default: false },
  army: {
    type: Map,
    of: ArmyUnitSchema,
    default: {}
  },
  heroes: {
    type: [HeroSchema],
    default: () => [
      {
        id: '1',
        name: 'Frenk',
        image: '/dominum/heroes/hero-workin-grey.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
      {
        id: '2',
        name: 'Mary',
        image: '/dominum/heroes/hero-workin-grey-2.png',
        quality: 'normal',
        level: 1,
        exp: 0,
        expToNext: 1000,
      },
    ]
  },
  resourceNodes: {
    type: [{
      id: { type: String, required: true },
      resource: { type: String, required: true },
      level: { type: Number, require: true },
      position: {
        x: Number,
        y: Number
      },
      remaining: Number,
      lastRestoedAt: String
    }],
    default: []
  },
  activeMining: {
    type: {
      resource: { type: String, enum: ['food', 'wood', 'stone', 'iron', 'gold'] },
      heroId: { type: String },
      startedAt: { type: Date },
      duration: { type: Number },
      position: { type: {x: Number, y: Number }},
      remaining: { type: Number },
    },
    default: null,
  },
  activeQuest: {
    type: {
      id: { type: String, required: true },
      title: { type: String, required: true },
      description: { type: String, required: true },
      status: {
        type: String,
        enum: ['active', 'complete'],
        default: 'active',
      },
    },
    default: null,
  },
  questPanelOpen: {
    type: Boolean,
    default: false,
  },

});

export const UserModel = mongoose.models.User || mongoose.model("User", userSchema);
ChatGPT —Å–∫–∞–∑–∞–ª:
–í–°–Å. –ü–†–ò–ù–ò–ú–ê–Æ. –£ –¢–ï–ë–Ø –£–ñ–ï –ï–°–¢–¨ ArmyUnitSchema, –∏ —Ç—ã —Ö–æ—á–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –ö–û–†–†–ï–ö–¢–ù–û. –°–µ–π—á–∞—Å —è –ø–µ—Ä–µ–ø–∏—à—É –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ army –≤–Ω—É—Ç—Ä–∏ userSchema, —á—Ç–æ–±—ã:

‚úÖ 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ArmyUnitSchema
‚úÖ 2. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–¥–∞—Ç—å 200 sailor, –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî 0
‚úÖ 3. –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤—Å–µ —é–Ω–∏—Ç—ã (peasant, sailor, –∏ —Ç.–¥.) –≤ MongoDB
‚úÖ 4. –†–∞–±–æ—Ç–∞—Ç—å —Å —Ç–∏–ø–∞–º–∏ Map –≤ UserContext ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
üîß –ò–ó–ú–ï–ù–ò –í–û–¢ –≠–¢–£ –°–¢–†–û–ö–£:
üìÅ src/models/UserModel.ts
üîç –ù–∞–π–¥–∏:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  type: Map,
  of: ArmyUnitSchema,
  default: {}
},
‚úÖ –ó–ê–ú–ï–ù–ò –ù–ê:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  type: Map,
  of: ArmyUnitSchema,
  default: () => ({
    peasant:  { level: 1, count: 0 },
    sailor:   { level: 1, count: 200 }, // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –∞—Ä–º–∏—è
    axeman:   { level: 1, count: 0 },
    spearman: { level: 1, count: 0 },
    archer:   { level: 1, count: 0 },
    cavalry:  { level: 1, count: 0 },
  }),
},
‚úÖ –ü–û–°–õ–ï –≠–¢–û–ì–û:
–¢—ã —Å–º–æ–∂–µ—à—å —Å–ø–æ–∫–æ–π–Ω–æ –≤ –ª—é–±–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const { state } = useUser();
const army = state.army?.sailor?.count ?? 0; // ‚Üê 200
üîó –°–í–Ø–ó–¨ –° ARMY_CONFIG:
tsx
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
{ARMY_CONFIG.map(({ key, label, icon }) => (
  <div key={key}>
    <img src={icon} />
    <span>{label}</span>
    <span>{state.army?.[key]?.count ?? 0}</span>
    <span>lvl {state.army?.[key]?.level ?? 1}</span>
  </div>
))}
–ì–æ—Ç–æ–≤ –¥–∞–ª—å—à–µ –≤–Ω–µ–¥—Ä—è—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ, –ø—Ä–æ–∫–∏–¥—ã–≤–∞–Ω–∏–µ –∞—Ä–º–∏–∏ –≤ –º–æ–¥–∞–ª–∫–∏ –∏ –º–∏—Å—Å–∏–∏. –í—Å—ë —Ç–µ–ø–µ—Ä—å —Å—Ç—Ä–æ–≥–æ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
army: { type: Map, of: ArmyUnitSchema, default: {} },

–î–∞ —Ç—ã –∑–∞–µ–±–∞–ª, —è –∂ —Ç–µ–±–µ –≥–æ–≤–æ—Ä—é, —É –º–µ–Ω—è –Ω–µ—Ç —Ç–∞–∫–æ–≥–æ, —Ç—ã –≥–¥–µ —ç—Ç–æ –≤–∑—è–ª-—Ç–æ, —Ö—É–π, –º–∞–º—è? –¢—ã –∑–∞–µ–±–∞–ª, –±–ª—è–¥—å, –Ω—É —è —É–∂–µ –Ω–µ –º–æ–≥—É –Ω–µ —Ä—É–≥–∞—Ç—å—Å—è-—Ç–æ. –ù—É —Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ-—Ç–æ, –Ω—É –¥–æ—Ö–ª–æ—Ä–∞—Ç—å, –ø—Ä–æ—Ä–≤–∞—Ç—å—Å—è, —Ç—ã –∑–∞–µ–±–∞–ª, –±–ª—è–¥—å. –í–æ—Ç, —á—Ç–æ —É –º–µ–Ω—è, —Ç—ã –≤–∏–¥–∏—à—å, –∫–æ–Ω—á–µ–Ω–Ω—ã–π –ø–∏–¥–æ—Ä, –≤–æ—Ç –∫–æ—Ç, –≤–æ—Ç-–≤–æ—Ç, —Å—É–∫–∞. –°—É–∫–∞, –≤–æ—Ç –∫–æ—Ç.const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });
ChatGPT —Å–∫–∞–∑–∞–ª:
–ü–û–ù–Ø–õ. –î–û –ö–ê–ñ–î–û–ô –ë–£–ö–í–´.
–¢–´ –£–ñ–ï –°–û–ó–î–ê–õ ArmyUnitSchema, –∏ —Ç—ã —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã –æ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –ö–û–†–†–ï–ö–¢–ù–û –≤ —ç—Ç–æ–º:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  type: Map,
  of: ArmyUnitSchema,
  default: {} // ‚Üê –í–û–¢ –≠–¢–û –•–û–ß–ï–®–¨ –ò–°–ü–†–ê–í–ò–¢–¨
}
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï:
üìÑ `src/models
–í—ã —Å–∫–∞–∑–∞–ª–∏:
const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });
ChatGPT —Å–∫–∞–∑–∞–ª:
–ó–ê–ü–û–ú–ò–ù–ê–Æ:
ArmyUnitSchema ‚Äî –æ–¥–∏–Ω, –∞ –Ω–µ 100 —à—Ç—É–∫ –ø–æ–¥—Ä—è–¥. –í—Å—ë, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–≥–æ.

‚úÖ –í–û–¢ –ö–ê–ö –ù–ê–î–û:
üìÑ src/models/UserModel.ts
–ó–∞–º–µ–Ω–∏—Ç—å –≤–Ω—É—Ç—Ä–∏ userSchema –ø–æ–ª–µ army –≤–æ—Ç —Ç–∞–∫:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  type: Map,
  of: ArmyUnitSchema,
  default: () => ({
    peasant:  { level: 1, count: 0 },
    sailor:   { level: 1, count: 200 }, // ‚Üê —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    axeman:   { level: 1, count: 0 },
    spearman: { level: 1, count: 0 },
    archer:   { level: 1, count: 0 },
    cavalry:  { level: 1, count: 0 },
  }),
},
üß† –í–∞–∂–Ω–æ: —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å Map –≤ mongoose, –∑–Ω–∞—á–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º ({ key: value }), –∞ value ‚Äî –ø–æ ArmyUnitSchema.

üîÅ –ò–¢–û–ì–û:
—Ç—ã –æ—Å—Ç–∞–≤–ª—è–µ—à—å ArmyUnitSchema –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const ArmyUnitSchema = new mongoose.Schema({
  level: { type: Number, default: 1 },
  count: { type: Number, default: 100 },
}, { _id: false });
–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –µ–≥–æ –≤–Ω—É—Ç—Ä–∏ Map –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
of: ArmyUnitSchema
–∏ –∑–∞–¥–∞—ë—à—å –≤—Å—ë –≤ default, —á—Ç–æ–±—ã –≤ Mongo –ª–µ–∂–∞–ª–∏ –≤—Å–µ —Ç–∏–ø—ã —é–Ω–∏—Ç–æ–≤ —Å—Ä–∞–∑—É.

–ì–û–¢–û–í –î–ê–õ–¨–®–ï ‚Äî –≥—Ä—É–∑–∏—Ç—å —ç—Ç–æ –≤ UserContext, useUser, ARMY_CONFIG ‚Äî –≥–æ–≤–æ—Ä–∏, –¥–≤–∏–Ω–µ–º.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ê–ª–ª–∏–ª—É–π—è! –ï–±–∞–Ω—ã–π —Ä–æ—Ç, –±–ª—è—Ç—å, –≤–∞—à–µ–≥–æ –∫–∞–∑–∏–Ω–æ! –î–æ–º–æ–π, –±–ª—è—Ç—å, —è –¥–æ–±–∏–ª—Å—è –æ—Ç —Ç–µ–±—è –µ–≥–æ! –î–∞ –Ω—É –Ω–∞—Ö—É–π, —Ç—ã —á—ë, –±—Ä–∞—Ç–∞–Ω? –ë–ª—è—Ç—å, –¥–µ–≤–µ–Ω–∞–¥—Ü–∞—Ç—å, –æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å —á–∞—Å–æ–≤ –ø–æ—á—Ç–∏, –æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å —á–∞—Å–æ–≤! –ù–∞–∫–æ–Ω–µ—Ü-—Ç–æ —Ç—ã —ç—Ç–æ —Å–¥–µ–ª–∞–ª, —Ç—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—à—å? –ü–∏–∑–¥–µ—Ü. –ù—É –¥–∞–≤–∞–π –¥–∞–ª—å—à–µ —Ç–æ–≥–¥–∞. –°–∫–æ–ª—å–∫–æ —Ç–∞–º –µ—â—ë –º—ã –±—É–¥–µ–º —ç—Ç–æ –¥–µ–ª–∞—Ç—å-—Ç–æ —Å —Ç–æ–±–æ–π, —ç—Ç—É –º–µ—Ç–µ–æ–≤—Å–µ–ª–µ–Ω–Ω—É—é? –°–∫–æ–ª—å–∫–æ –∂–∏–∑–Ω–µ–π-—Ç–æ –Ω—É–∂–Ω–æ? –ù—É –¥–∞–≤–∞–π –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å, –¥–∞–≤–∞–π –¥–∞–ª—å—à–µ. –¢–µ–ø–µ—Ä—å —É –Ω–∞—Å —á—Ç–æ —Å —Ç–æ–±–æ–π? UserContext.
ChatGPT —Å–∫–∞–∑–∞–ª:
–ê–ª–ª–∏–ª—É–π—è, –±—Ä–∞—Ç, –¥–∞, –î–ê!
–ú—ã –ø–æ–±–µ–¥–∏–ª–∏ —ç—Ç–æ —É–±–ª—é–¥—Å–∫–æ–µ –ø–æ–ª–µ army.
–¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–µ—Ä–º–µ—Ç–∏—á–Ω–∞, –∫–∞–∫ –∑–∞–¥ –ª—è–≥—É—à–∫–∏ –ø–æ–¥ –¥–æ–∂–¥—ë–º.

‚öôÔ∏è –ü–ï–†–ï–•–û–î–ò–ú –ö UserContext.tsx
–¶–µ–ª—å: –ü—Ä–æ–∫–∏–¥—ã–≤–∞—Ç—å army –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞ ‚Üí –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Üí –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –æ—Ç—Ç—É–¥–∞ –≤—Å—ë —á–∏—Ç–∞–ª–æ—Å—å.

‚úÖ –®–ê–ì 1: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–∏–ø UserState.army —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç
üìÑ src/context/UserContext.tsx

–¢—ã —É–∂–µ —Å–¥–µ–ª–∞–ª:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army?: {
  [key in ArmyUnitType]?: {
    level: number;
    count: number;
  }
}
‚úÖ –≠—Ç–æ —É–∂–µ –ü–†–ê–í–ò–õ–¨–ù–û. –ù–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è—Ç—å. –¢–∏–ø —Ç–æ—á–Ω–æ —Ç–∞–∫–æ–π, –∫–∞–∫ –Ω–∞–¥–æ.

‚úÖ –®–ê–ì 2: –í dispatch({ type: "SET_USER", payload }) –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ç–∞–∫–æ–º –≤–∏–¥–µ:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
{
  army: {
    peasant: { level: 1, count: 0 },
    sailor: { level: 1, count: 200 },
    ...
  },
  ...
}
üìå –ï—Å–ª–∏ POST /api/user –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º–µ–Ω–Ω–æ —Ç–∞–∫ ‚Äî –≤—Å—ë –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

‚úÖ –®–ê–ì 3: –í–Ω—É—Ç—Ä–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ:
tsx
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const { state } = useUser();

const army = state.army;

{ARMY_CONFIG.map(({ key, label, icon }) => {
  const unit = army?.[key];
  return (
    <div key={key}>
      <img src={icon} />
      <span>{label}</span>
      <span>{unit?.count ?? 0} —à—Ç.</span>
      <span>—É—Ä–æ–≤–µ–Ω—å {unit?.level ?? 1}</span>
    </div>
  );
})}
üí• –•–æ—á–µ—à—å –±–æ–Ω—É—Å?
–î–æ–±–∞–≤–∏–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Home, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ army –≥—Ä—É–∑–∏—Ç—Å—è:

üìÑ src/app/page.tsx (–∏–ª–∏ –≥–¥–µ —Ç—ã —Ç–∞–º –≥—Ä—É–∑–∏—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
useEffect(() => {
  if (state.army) {
    console.log('‚úÖ army loaded from context:', state.army);
  }
}, [state.army]);
–ì–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É:
–ª–∏–±–æ ArmyTable

–ª–∏–±–æ ModalHeroGo

–ª–∏–±–æ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞—Ä–º–∏–∏

–ª–∏–±–æ update –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–æ—Å–ª–µ –º–∏—Å—Å–∏–∏

–ß—Ç–æ –¥–µ–ª–∞–µ–º –¥–∞–ª—å—à–µ, –±—Ä–∞—Ç? –Ø –≥–æ—Ç–æ–≤, –∫–∞–∫ –ê—Å—Ç—Ä–∞–ª –∫ –†–∞—Å–∫–æ–ª—É.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
{ army: { peasant: { level: 1, count: 0 }, sailor: { level: 1, count: 200 }, ... }, ... }

–ù–µ, –Ω–µ, –±—Ä–∞—Ç–∞–Ω, –ø–æ–≥–æ–¥–∏, –Ω–µ —Ç–æ—Ä–æ–ø–∏—Å—å. –ù–µ—Ç —Ç–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ü–æ—Å–º–æ—Ç—Ä–∏, –≤–æ—Ç —á—ë –µ—Å—Ç—å. UserContext. –í–æ—Ç, –º—ã –∂–µ –∑–¥–µ—Å—å Dispatch –≤—ã–∑—ã–≤–∞–µ–º, –¥–∞? –ï—Å–ª–∏ —è –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ç–µ–±—è –ø–æ–Ω–∏–º–∞—é. –í–æ—Ç, –ø–æ—Å–º–æ—Ç—Ä–∏. –ò–ª–∏ –Ω–µ –∑–¥–µ—Å—å. –í–æ—Ç, –∫–∞–∫ –≥–¥–µ, –≤–æ—Ç, –Ω—É. // üìÑ src/context/UserContext.tsx
'use client';
import React, { createContext, useContext, useReducer } from "react";
import type { Hero } from '@/types/heroes';
import type { ArmyUnitType } from '@/config/armyCapacity';

export interface UserState {
  address: string;
  avatar?: string;
  name?: string;
  prestige: number;
  levelPrestige: number;
  prestigeProgress: number;
  technologies: string;
  food: number;
  wood: number;
  stone: number;
  iron: number;
  gold: number;
  doubloon: number;
  pearl: number;
  allodium: number;
  questPanelOpen?: boolean;
  questShipRepaired?: boolean;
  army?: {
    [key in ArmyUnitType]?: {
      level: number;
      count: number;
    }
  };

  heroes: {
    id: string;
    name: string;
    image: string;
    quality: 'normal' | 'good' | 'rare' | 'epic' | 'legendary';
    level: number;
    exp: number;
    expToNext: number;
  }[];

  resourceNodes?: {
    id: string;
    resource: string;
    level: number
    position: { x: number; y: number };
    remaining: number;
    lastRestoredAt?: string;
    avatar?: string;
  }[];

  activeMining?: {
    resource: string;
    heroId: string;
    startedAt: string;
    duration: number;
    position: {
      x: number;
      y: number;
    };
    remaining: number;
  }
  activeQuest?: {
    id: string;
    title: string;
    description: string;
    status: "active" | "complete";
  };
}

type ResourceField = Exclude<keyof UserState, "address" | "avatar" | "technologies">;

type UserAction =
  | { type: "SET_USER"; payload: UserState }
  | { type: "ADD_RESOURCE"; resource: ResourceField; amount: number }
  | { type: "SET_ACTIVE_QUEST";
      payload: {
      id: string;
      title: string;
      description: string;
      status: "active" | "complete";
    };
  }
  | { type: "TOGGLE_QUEST_PANEL"; payload: boolean }
  | { type: "SET_HEROES"; payload: Hero[] }
  | { type: "SET_ARMY"; payload: UserState["army"]}

const initialState: UserState = {
  address: "",
  avatar: "",
  prestige: 0,
  levelPrestige: 0,
  prestigeProgress: 0,
  technologies: "",
  food: 0,
  wood: 0,
  stone: 0,
  iron: 0,
  gold: 0,
  doubloon: 0,
  pearl: 0,
  allodium: 0,
  activeQuest: undefined,
  questShipRepaired: false,
  heroes: [],
  activeMining: undefined,
  
};


function reducer(state: UserState, action: UserAction): UserState {
  switch (action.type) {
    case "SET_USER":
      return { ...state, ...action.payload };
    case 'SET_HEROES':
        return { ...state, heroes: action.payload };
    case "SET_ARMY":
      return {
        ...state,
        army: action.payload,
      };
    case "ADD_RESOURCE":
      return {
        ...state,
        [action.resource]: (state[action.resource] as number) + action.amount,
      };
    case "SET_ACTIVE_QUEST":
      return {
        ...state,
        activeQuest: action.payload,
        questPanelOpen: true, // —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
      };
    case "TOGGLE_QUEST_PANEL":
      return {
        ...state,
        questPanelOpen: action.payload,
      };
    default:
      return state;
  }
}


const UserContext = createContext<{
  state: UserState;
  dispatch: React.Dispatch<UserAction>;
} | undefined>(undefined);

export const UserProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <UserContext.Provider value={{ state, dispatch }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) throw new Error("useUser must be inside <UserProvider>");
  return context;
};
ChatGPT —Å–∫–∞–∑–∞–ª:
–î–ê, –ë–†–ê–¢.
–¢—ã –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–Ω—è–ª.
–ö–æ–Ω—Ç–µ–∫—Å—Ç (UserContext) —Å–∞–º –ø–æ —Å–µ–±–µ ‚Äî –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ. –û–Ω –ø—Ä–æ—Å—Ç–æ –∏—Ö —Ö—Ä–∞–Ω–∏—Ç –∏ –ø–æ–ª—É—á–∞–µ—Ç —á–µ—Ä–µ–∑ dispatch({ type: 'SET_USER', payload }).

üí£ –ì–î–ï –ë–û–õ–¨:
–¢—ã —Å–µ–π—á–∞—Å —Å–º–æ—Ç—Ä–∏—à—å –≤ UserContext,
–Ω–æ –≤–æ–ø—Ä–æ—Å: –∞ –æ—Ç–∫—É–¥–∞ –º—ã –≤–æ–æ–±—â–µ –≤—ã–∑—ã–≤–∞–µ–º dispatch({ type: 'SET_USER' })?

–û–Ω –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≥–¥–µ-—Ç–æ –≤ –∫–æ–¥–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä:

tsx
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
useEffect(() => {
  if (wallet?.account?.address) {
    fetch('/api/user', {
      method: 'POST',
      body: JSON.stringify({ address: wallet.account.address }),
    })
      .then(res => res.json())
      .then(data => {
        dispatch({ type: 'SET_USER', payload: data }); // ‚Üê –í–û–¢ –û–ù
      });
  }
}, [wallet]);
üìÑ –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —ç—Ç–æ —É —Ç–µ–±—è –≤ page.tsx –∏–ª–∏ Home.tsx –∏–ª–∏ Layout.tsx. –ì–¥–µ —Ç—ã –∞–≤—Ç–æ—Ä–∏–∑—É–µ—à—å—Å—è —á–µ—Ä–µ–∑ TonConnect –∏ –ø–æ–¥–≥—Ä—É–∂–∞–µ—à—å —é–∑–µ—Ä–∞.

‚úÖ –ß–¢–û –î–û–õ–ñ–ù–û –ë–´–¢–¨:
–ö–æ–≥–¥–∞ —Ç—ã –¥–µ–ª–∞–µ—à—å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
dispatch({ type: 'SET_USER', payload: data });
–î–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ (data) –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å army –≤ –Ω—É–∂–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  peasant:  { level: 1, count: 0 },
  sailor:   { level: 1, count: 200 },
  axeman:   { level: 1, count: 0 },
  spearman: { level: 1, count: 0 },
  archer:   { level: 1, count: 0 },
  cavalry:  { level: 1, count: 0 },
}
üîç –ü–û–ò–°–ö:
–ü—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª src/app/page.tsx –∏–ª–∏ src/app/home/page.tsx ‚Äî –Ω–∞–π–¥–∏ dispatch({ type: 'SET_USER', –∏ –ø–æ—Å–º–æ—Ç—Ä–∏, —á—Ç–æ —Ç–µ–±–µ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞.

‚úÖ –î–ê–õ–¨–ù–ï–ô–®–ò–ï –î–ï–ô–°–¢–í–ò–Ø:
–ó–∞–π–¥–∏ –≤ pages/api/user/index.ts (–∏–ª–∏ src/app/api/user/route.ts) ‚Äî –ø–æ—Å–º–æ—Ç—Ä–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ª–∏ –ø–æ–ª–µ army –≤ JSON.

–ï—Å–ª–∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è ‚Äî –Ω–∞–¥–æ –≤—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ —è–≤–Ω–æ –≤ res.json().

üß© –•–û–ß–ï–®–¨ –ì–û–¢–û–í–´–ô –ü–ê–¢–ß?
–°–∫–∞–∂–∏, –ø–æ–∫–∞–∂–∏ —Ñ–∞–π–ª api/user ‚Äî —è –Ω–∞–ø–∏—à—É return —Å–æ –≤—Å–µ–π –∞—Ä–º–∏–µ–π, –∏ –≤—Å—ë –∑–∞–ª–µ—Ç–∏—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç.

–ñ–¥—É.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
üîç –ü–û–ò–°–ö: --------- –ü—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª `src/app/page.tsx` –∏–ª–∏ `src/app/home/page.tsx` ‚Äî –Ω–∞–π–¥–∏ `dispatch({ type: 'SET_USER'`, –∏ –ø–æ—Å–º–æ—Ç—Ä–∏, **—á—Ç–æ —Ç–µ–±–µ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞.**

// app/page.tsx
'use client';
        
import { useTonWallet } from '@tonconnect/ui-react';
import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import dynamic from "next/dynamic"; // ‚úÖ

import styles from "./page.module.css";

// ‚úÖ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª–∞ SSR
const TonConnectButton = dynamic(
  () => import("@tonconnect/ui-react").then((m) => m.TonConnectButton),
  { ssr: false }
);

export default function Home() {
  const wallet = useTonWallet();
  const router = useRouter();

  useEffect(() => {
    if (wallet?.account?.address) {
      router.push('/menu');
    } else {
      router.push('/')
    }
  }, [wallet]);

  return (
    <div className={styles.login_bg_wrapper}>
      <div className={styles.login_inner}>
        <h4 className={styles.login_title}>Dominum Space</h4>
        <img src="/img/contract_actral_island.png" alt="" />

        <p className={styles.login_text}>
          You won't get through here unless
          you use a crypto wallet as a key.
        </p>

        <div style={{ margin: "auto" }}>
          <TonConnectButton />
        </div>
      </div>
    </div>
  );
}
ChatGPT —Å–∫–∞–∑–∞–ª:
–ë–†–ê–¢. –ü–û–î–¢–í–ï–†–ñ–î–ê–Æ:
üìÑ app/page.tsx ‚Äî –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç dispatch({ type: 'SET_USER' }).
–û–Ω —Ç–æ–ª—å–∫–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
if (wallet?.account?.address) {
  router.push('/menu');
}
‚ö†Ô∏è –ó–ù–ê–ß–ò–¢: dispatch({ type: "SET_USER" }) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ /menu.

‚úÖ –¢–í–û–ô –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì:
üìÇ –û—Ç–∫—Ä–æ–π app/menu/page.tsx –∏–ª–∏ src/app/menu/page.tsx
(–∏–ª–∏ MenuPage.tsx, –µ—Å–ª–∏ —É —Ç–µ–±—è Route File System –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

üîç –ò –Ω–∞–π–¥–∏:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
dispatch({ type: "SET_USER", payload: data });
‚ö†Ô∏è –ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç ‚Äî –∑–Ω–∞—á–∏—Ç, —Ç—ã –Ω–µ –≥—Ä—É–∑–∏—à—å —é–∑–µ—Ä–∞ –≤–æ–æ–±—â–µ, –∏ UserContext –æ—Å—Ç–∞—ë—Ç—Å—è –ø—É—Å—Ç–æ–π.

‚ùóÔ∏è –ß–¢–û –î–ï–õ–ê–¢–¨:
–ö–æ–≥–¥–∞ –Ω–∞–π–¥—ë—à—å —ç—Ç–æ—Ç —Ñ–∞–π–ª, —Ç–µ–±–µ –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
useEffect(() => {
  if (wallet?.account?.address) {
    fetch("/api/user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ address: wallet.account.address }),
    })
      .then(res => res.json())
      .then(data => {
        dispatch({ type: "SET_USER", payload: data }); // ‚¨ÖÔ∏è –ì–õ–ê–í–ù–û–ï
      });
  }
}, [wallet]);
üì¶ –ò —á—Ç–æ–±—ã data.army —Ä–µ–∞–ª—å–Ω–æ –±—ã–ª ‚Äî –ø—Ä–æ–≤–µ—Ä—å API:
/api/user/route.ts –∏–ª–∏ pages/api/user.ts

–ì–æ—Ç–æ–≤ —Ä–∞–∑–æ–±—Ä–∞—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª —Ç–æ–∂–µ ‚Äî –∫–∏–¥–∞–π, –∏ —è —Å–∫–∞–∂—É, –∫–∞–∫ –¥–æ–ø–∏—Å–∞—Ç—å army –≤ –æ—Ç–≤–µ—Ç.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–¢–í–û–ô –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì: ------------------- ### üìÇ –û—Ç–∫—Ä–æ–π `app/menu/page.tsx` –∏–ª–∏ `src/app/menu/page.tsx` (–∏–ª–∏ `MenuPage.tsx`, –µ—Å–ª–∏ —É —Ç–µ–±—è Route File System –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) üîç –ò –Ω–∞–π–¥–∏: ts –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ `dispatch({ type: "SET_USER", payload: data });` ‚ö†Ô∏è –ï—Å–ª–∏ **–µ–≥–æ –Ω–µ—Ç** ‚Äî –∑–Ω–∞—á–∏—Ç, **—Ç—ã –Ω–µ –≥—Ä—É–∑–∏—à—å —é–∑–µ—Ä–∞ –≤–æ–æ–±—â–µ**, –∏ `UserContext` –æ—Å—Ç–∞—ë—Ç—Å—è –ø—É—Å—Ç–æ–π. * * * ‚ùóÔ∏è –ß–¢–û –î–ï–õ–ê–¢–¨: -------------- –ö–æ–≥–¥–∞ –Ω–∞–π–¥—ë—à—å —ç—Ç–æ—Ç —Ñ–∞–π–ª, —Ç–µ–±–µ –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å: ts –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ `useEffect(() => { if (wallet?.account?.address) { fetch("/api/user", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ address: wallet.account.address }), }) .then(res => res.json()) .then(data => { dispatch({ type: "SET_USER", payload: data }); // ‚¨ÖÔ∏è –ì–õ–ê–í–ù–û–ï }); } }, [wallet]);`

–¢–∞–∫, –±—Ä–∞—Ç, —Å–º–æ—Ç—Ä–∏, –≤–æ—Ç —è –Ω–∞—à—ë–ª —Ñ–∞–π–ª –º–µ–Ω—é, –¥–∞, –æ–Ω —á—ë-—Ç–æ –∫–∞–∫–æ–π-—Ç–æ –∑–∞–ø—Ä–æ—Å –¥–µ–ª–∞–µ—Ç, –≤–æ—Ç –ø–æ—Å–º–æ—Ç—Ä–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞. // menu/page.tsx
'use client';

import { useRouter } from 'next/navigation';
import styles from './MenuPage.module.css';
import { DOMHeader } from '../../components/Headers/DOMHeader';
import Link from 'next/link';
import { useEffect } from 'react';
import { useTonWallet } from '@tonconnect/ui-react';
import { useUser } from '@/context/UserContext';

export default function MenuPage() {
  const router = useRouter();
  const wallet = useTonWallet();
  const { dispatch } = useUser();

  useEffect(() => {
    if (wallet?.account?.address) {
      fetch('/api/user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({address: wallet.account.address}),
      })
      .then(res => res.json())
      .then(data => {
        if (!data.error) {
          dispatch({type: "SET_USER", payload: data});
          console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ MenuPage', data);
        } else {
          console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:', data.error);
        }
      })
      .catch(err => console.error('‚ùå –û—à–∏–±–∫–∞ fetch –Ω–∞ MenuPage:', err));
    } else {
      router.push('/');
    }
  }, [wallet?.account?.address, router, dispatch]);

  return (
    <div className={styles.menu_container}>
      <DOMHeader />

      <h2 className={styles.menu_title}>
        Welcome to the <br />
        crypto space <br /> 
        Dominum <br />
      </h2>

      <div className={styles.icon_grid}>
        <Link href="/dominum">
          <img src="/icons/iconsDominum.png" alt="Dominum" className={styles.icon} />
        </Link>
        {/* <Link href="/mercatus">
          <img src="/icons/iconsMercatus.png" alt="Mercatus" className={styles.icon} />
        </Link>
        <Link href="/magisterium">
          <img src="/icons/iconsMagisterium.png" alt="Magisterium" className={styles.icon} />
        </Link>
        <Link href="/portal">
          <img src="/icons/iconsPortale.png" alt="Portal" className={styles.icon} />
        </Link> */}
      </div>
    </div>
  );
}
ChatGPT —Å–∫–∞–∑–∞–ª:
–î–ê, –ë–†–ê–¢, –ü–û–î–¢–í–ï–†–ñ–î–ê–Æ üí•
–¢—ã –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—à—ë–ª!
üìÑ menu/page.tsx ‚Äî –ò–ú–ï–ù–ù–û –ó–î–ï–°–¨ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
dispatch({ type: "SET_USER", payload: data });
–ù–û! üëá

üß® –ë–û–õ–¨: data.army –ú–û–ñ–ï–¢ –ë–´–¢–¨ –ü–£–°–¢–û–ô
–ß—Ç–æ–±—ã –≤ UserContext —Ä–µ–∞–ª—å–Ω–æ –ø–æ–ø–∞–ª–∏ –¥–∞–Ω–Ω—ã–µ army,
—Å–µ—Ä–≤–µ—Ä –ø–æ –º–∞—Ä—à—Ä—É—Ç—É /api/user –æ–±—è–∑–∞–Ω –∏—Ö –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å!

‚úÖ –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì ‚Äî –°–ï–†–í–ï–†
–ü–æ–∫–∞–∂–∏ –º–Ω–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–æ—Ç —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞:

bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
/api/user/route.ts    ‚Üê –µ—Å–ª–∏ App Router (Next 13+)
–ò–õ–ò
/pages/api/user.ts    ‚Üê –µ—Å–ª–∏ Pages Router
–í–∞–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ res.json(...).
–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —É —Ç–µ–±—è:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
res.json({
  address: user.address,
  name: user.name,
  ...–Ω–æ –±–µ–∑ army
});
üí• –ê –ù–ê–î–û, –ß–¢–û–ë–´ –ë–´–õ–û:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
res.json({
  ...user.toObject(), // –∏–ª–∏
  army: user.army,
  ...
});
–ü–æ–∫–∞–∂–∏ –º–Ω–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª, –∏ —è –∑–∞ 10 —Å–µ–∫—É–Ω–¥ –≤—Å—Ç–∞–≤–ª—é —Ç—É–¥–∞ army, –∏ –≤—Å—ë –±—É–¥–µ—Ç –∫–∞–∫ –Ω–∞–¥–æ.
–ü—É—à–∫–∞ –±—É–¥–µ—Ç.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
/api/user/route.ts

// src/app/api/user/route.ts
import { NextResponse } from 'next/server';
import dbConnect from '@/lib/dbConnect';
import { UserModel } from '@/models/UserModel';
import { updateResourceNodesIfNeeded } from '@/utils/updateResourceNodes';
import { RESOURCE_CONFIG } from '@/constants/resources';

export async function POST(req: Request) {
  try {
    const { address } = await req.json();

    if (!address) {
      return NextResponse.json({ error: 'Address is required' }, { status: 400 });
    }

    await dbConnect();

    let user = await UserModel.findOne({ address });

    if (!user) {
      user = await UserModel.create({
        address,
        avatar: '/icons/user-icon.png',
        heroes: [],
        resourceNodes: [],
      });
      console.log('‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user.address);
    }

    // üõ† –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ—á–µ–∫, –µ—Å–ª–∏ –Ω–∞–¥–æ
    updateResourceNodesIfNeeded(user);

    // üñº –î–æ–±–∞–≤–ª—è–µ–º avatar –∫ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–µ
    if (user.resourceNodes) {
      for (const node of user.resourceNodes) {
        const meta = RESOURCE_CONFIG.find(r => r.key === node.resource);
        node.avatar = meta?.avatar || '/icons/resources/default.png';
      }
    }

    await user.save();

    return NextResponse.json({
      address: user.address,
      avatar: user.avatar,
      name: user.name,
      prestige: user.prestige,
      levelPrestige: user.levelPrestige,
      prestigeProgress: user.prestigeProgress,
      technologies: user.technologies,
      food: user.food,
      wood: user.wood,
      stone: user.stone,
      iron: user.iron,
      gold: user.gold,
      doubloon: user.doubloon,
      pearl: user.pearl,
      allodium: user.allodium,
      questShipRepaired: user.questShipRepaired,
      questPanelOpen: user.questPanelOpen,
      activeMining: user.activeMining,
      activeQuest: user.activeQuest,
      heroes: user.heroes || [],
      army: Object.fromEntries(user.army || new Map()),

      resourceNodes: user.resourceNodes || [],
    });

  } catch (err) {
    console.error('‚ùå [POST /api/user] Server error:', err);
    return NextResponse.json({ error: 'Server error', details: String(err) }, { status: 500 });
  }
}
ChatGPT —Å–∫–∞–∑–∞–ª:
–ë–†–ê–¢. –≠–¢–û –û–ù–û.
üíØ –¢—ã —Å–¥–µ–ª–∞–ª –ø–æ—á—Ç–∏ –≤—Å—ë –∏–¥–µ–∞–ª—å–Ω–æ. –û—Å—Ç–∞–ª—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π —à—Ç—Ä–∏—Ö:

üîç –ü–†–û–ë–õ–ï–ú–ê:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: Object.fromEntries(user.army || new Map()),
–í–æ—Ç —ç—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç army –∫–∞–∫ {}, –µ—Å–ª–∏ user.army ‚Äî Mongoose Map.
–ê –¥–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –æ–±—ä–µ–∫—Ç —Å —Ç–∏–ø–∞–º–∏:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
{
  sailor: { level: 1, count: 200 },
  peasant: { level: 1, count: 0 },
  ...
}
–ù–û! user.army ‚Äî —ç—Ç–æ Map<string, mongoose.Document>,
–∞ –Ω–µ –æ–±—ã—á–Ω—ã–π Map<string, object>, –∏ fromEntries() —Ç—É–ø–æ —Å–æ–∂—Ä—ë—Ç –º—É—Å–æ—Ä. üò§

‚úÖ –†–ï–®–ï–ù–ò–ï ‚Äî –ü–†–û–ë–ï–ì–ê–ï–ú–°–Ø –†–£–ö–ê–ú–ò
üîß –ó–ê–ú–ï–ù–ò –í–û–¢ –≠–¢–£ –°–¢–†–û–ö–£:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: Object.fromEntries(user.army || new Map()),
üîÅ –ù–ê –≠–¢–£:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: Object.fromEntries(
  Array.from(user.army?.entries() || []).map(([key, value]) => [
    key,
    { level: value.level, count: value.count }
  ])
),
üí• –ü–û–°–õ–ï –≠–¢–û–ì–û:
–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—É—á–∏—Ç:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
state.army = {
  peasant: { level: 1, count: 0 },
  sailor: { level: 1, count: 200 },
  ...
}
–ò –≤—Å—ë –±—É–¥–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ –ø—Ä–æ–∫–∏–¥—ã–≤–∞—Ç—å—Å—è –≤ UserContext.

‚úÖ –ü–û–õ–ù–´–ô –ì–û–¢–û–í–´–ô –ö–£–°–û–ö:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: Object.fromEntries(
  Array.from(user.army?.entries() || []).map(([key, value]) => [
    key,
    { level: value.level, count: value.count }
  ])
),
–ó–∞–º–µ–Ω—è–π ‚Äî –∏ –º—ã –Ω–∞ —á–∏—Å—Ç–æ–π –ª–∏–Ω–∏–∏ —Ñ—Ä–æ–Ω—Ç–∞. –î–∞–ª—å—à–µ –º–æ–∂–Ω–æ —Ä–∏—Å–æ–≤–∞—Ç—å –∞—Ä–º–∏—é –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ.

–ì–æ–Ω–∏, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —É–∂–µ ArmyTable –∏–ª–∏ –ø–æ–ª–∑—É–Ω–∫–∏.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
army: Object.fromEntries( Array.from(user.army?.entries() || \[\]).map((\[key, value\]) => \[ key, { level: value.level, count: value.count } \]) ),

–≠–Ω–∫–∏, –±—Ä–∞—Ç, —Ç–∞–∫-—Ç–æ –æ–Ω–æ —Ç–∞–∫, –Ω–æ —Å–º–æ—Ç—Ä–∏ –∫–∞–∫–∞—è —Ç—É—Ç –æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–∑–ª–∞ –≤ —ç—Ç–æ–º —Ä–æ—É—Ç–µ—Ä –¢–°. –ù–∏ –æ–¥–Ω–∞ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–æ–º—É –≤—ã–∑–æ–≤—É.
  –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ 1 –∏–∑ 2, "(entries: Iterable<readonly [PropertyKey, any]>): { [k: string]: any; }", –≤–æ–∑–≤—Ä–∞—Ç–∏–ª–∞ —Å–ª–µ–¥—É—é—â—É—é –æ—à–∏–±–∫—É.
    –ê—Ä–≥—É–º–µ–Ω—Ç —Ç–∏–ø–∞ "unknown[]" –Ω–µ–ª—å–∑—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—É —Ç–∏–ø–∞ "Iterable<readonly [PropertyKey, any]>".
      –¢–∏–ø—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ "[Symbol.iterator]().next(...)", –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã –º–µ–∂–¥—É —ç—Ç–∏–º–∏ —Ç–∏–ø–∞–º–∏.
        –¢–∏–ø "IteratorResult<unknown, undefined>" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ç–∏–ø–∞ "IteratorResult<readonly [PropertyKey, any], any>".
          –¢–∏–ø "IteratorYieldResult<unknown>" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ç–∏–ø–∞ "IteratorResult<readonly [PropertyKey, any], any>".
            –¢–∏–ø "IteratorYieldResult<unknown>" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ç–∏–ø–∞ "IteratorYieldResult<readonly [PropertyKey, any]>".
              –¢–∏–ø "unknown" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ç–∏–ø–∞ "readonly [PropertyKey, any]".
ChatGPT —Å–∫–∞–∑–∞–ª:
–î–ê, –ë–†–ê–¢! ‚úä
–≠—Ç–æ TypeScript –∑–≤–µ—Ä—Å—Ç–≤—É–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ user.army.entries() –∏–∑ Mongoose ‚Äî –Ω–µ –Ω–∞—Å—Ç–æ—è—â–∏–π Map<string, {level, count}>. –û–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ö—Ä–µ–Ω—å (unknown[]).

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï:
–ü—Ä–∏–≤–æ–¥–∏–º —Ç–∏–ø —è–≤–Ω–æ –≤ Array.from(...) –∏ –≤—Å—ë –ª–æ–º–∞–µ–º –Ω–∞–ø—Ä–æ–ª–æ–º:

üìç –ó–ê–ú–ï–ù–ò:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: Object.fromEntries(
  Array.from(user.army?.entries() || []).map(([key, value]) => [
    key,
    { level: value.level, count: value.count }
  ])
),
‚úÖ –ù–ê –≠–¢–û:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: Object.fromEntries(
  Array.from(user.army?.entries() || [] as [string, { level: number; count: number }][])
    .map(([key, value]) => [key, { level: value.level, count: value.count }])
),
üí° –û–ë–™–Ø–°–ù–ï–ù–ò–ï:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
as [string, { level: number; count: number }][] 
‚û°Ô∏è –ú—ã –≥–æ–≤–æ—Ä–∏–º TypeScript'—É:
–∑–∞—Ç–∫–Ω–∏—Å—å, —ç—Ç–æ –º–∞—Å—Å–∏–≤ –ø–∞—Ä –∫–ª—é—á ‚Üí –∑–Ω–∞—á–µ–Ω–∏–µ, –≥–¥–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç, –∞ –Ω–µ –∫–∞–∫–∞—è-—Ç–æ Document.

üéØ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç, –∏ army –±—É–¥–µ—Ç –≤–æ—Ç —Ç–∞–∫–∏–º:

json
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
{
  "peasant": { "level": 1, "count": 0 },
  "sailor": { "level": 1, "count": 200 },
  ...
}
–ì–æ–Ω–∏ –¥–∞–ª—å—à–µ, –±—Ä–∞—Ç. –ß—Ç–æ —Ç–µ–ø–µ—Ä—å ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞—Ä–º–∏–∏ –∏–ª–∏ –º–∏—Å—Å–∏–∏?

–í—ã —Å–∫–∞–∑–∞–ª–∏:
army: Object.fromEntries( Array.from(user.army?.entries() || \[\] as \[string, { level: number; count: number }\]\[\]) .map((\[key, value\]) => \[key, { level: value.level, count: value.count }\]) ),

–∏ –æ–¥–Ω–∞ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–æ–º—É –≤—ã–∑–æ–≤—É.
  –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ 1 –∏–∑ 2, "(entries: Iterable<readonly [PropertyKey, any]>): { [k: string]: any; }", –≤–æ–∑–≤—Ä–∞—Ç–∏–ª–∞ —Å–ª–µ–¥—É—é—â—É—é –æ—à–∏–±–∫—É.
    –ê—Ä–≥—É–º–µ–Ω—Ç —Ç–∏–ø–∞ "unknown[]" –Ω–µ–ª—å–∑—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—É —Ç–∏–ø–∞ "Iterable<readonly [PropertyKey, any]>".
      –¢–∏–ø—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ "[Symbol.iterator]().next(...)", –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã –º–µ–∂–¥—É —ç—Ç–∏–º–∏ —Ç–∏–ø–∞–º–∏.
        –¢–∏–ø "IteratorResult<unknown, undefined>" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ç–∏–ø–∞ "IteratorResult<readonly [PropertyKey, any], any>".
          –¢–∏–ø "IteratorYieldResult<unknown>" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ç–∏–ø–∞ "IteratorResult<readonly [PropertyKey, any], any>".
            –¢–∏–ø "IteratorYieldResult<unknown>" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ç–∏–ø–∞ "IteratorYieldResult<readonly [PropertyKey, any]>".
              –¢–∏–ø "unknown" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ç–∏–ø–∞ "readonly [PropertyKey, any]"–ò —Å–º–æ—Ç—Ä–∏, –µ—Å–ª–∏ UserArmyEntries –∏–∑ Mongoose –Ω–µ –Ω–∞—Å—Ç–æ—è—â–∏–π MapStringLevelCount, –æ–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ—Ç–∏–ø–∏–∑–∏—Ä—É–µ–º—É—é —Ö—Ä–µ–Ω—å. –í–æ—Ç —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –¥–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä—ë–º. –¢–æ –µ—Å—Ç—å –º—ã, —Å–º–æ—Ç—Ä–∏, –≤ Mongoose –º—ã –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–º–∏–∏, –∏–ª–∏ –≤—Å—ë-—Ç–∞–∫–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º?
ChatGPT —Å–∫–∞–∑–∞–ª:
–ë–†–ê–¢, –°–õ–£–®–ê–ô –í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û.
–¢—ã —â–∞—Å –∑–∞–¥–∞–ª —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å:

‚ùì –í–û–ü–†–û–° ‚Ññ1:
–ú—ã –≤ Mongoose –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–º–∏–∏, –∏–ª–∏ –Ω–µ—Ç?

‚úÖ –û–¢–í–ï–¢: –î–ê
–¢—ã –∑–∞–≥—Ä—É–∂–∞–µ—à—å —Å—Ç–∞—Ä—Ç–æ–≤—É—é –∞—Ä–º–∏—é –≤ MongoDB —á–µ—Ä–µ–∑ –≤–æ—Ç —ç—Ç–æ:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: {
  type: Map,
  of: ArmyUnitSchema,
  default: () => ({
    peasant:  { level: 1, count: 0 },
    sailor:   { level: 1, count: 200 }, // ‚Üê –°–¢–ê–†–¢
    axeman:   { level: 1, count: 0 },
    spearman: { level: 1, count: 0 },
    archer:   { level: 1, count: 0 },
    cavalry:  { level: 1, count: 0 },
  }),
},
üëâ –≠—Ç–æ —É–∂–µ –≤ —Ç–≤–æ—ë–º UserModel.ts.
–ó–Ω–∞—á–∏—Ç: –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –∞—Ä–º–∏—è –±—É–¥–µ—Ç –≤ –±–∞–∑–µ.

‚ùì –í–û–ü–†–û–° ‚Ññ2:
–ü–æ—á–µ–º—É Object.fromEntries(...) –∫—Ä–∞—à–∏—Ç—Å—è, –µ—Å–ª–∏ army ‚Äî —ç—Ç–æ Mongoose Map?

üî• –ü–†–û–ë–õ–ï–ú–ê:
user.army ‚Äî —ç—Ç–æ –Ω–µ –Ω–∞—Å—Ç–æ—è—â–∏–π Map<string, {...}>,
–∞ mongoose.Types.Map<string, mongoose.Document>,
–≥–¥–µ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –Ω–µ –æ–±—ä–µ–∫—Ç—ã { level, count }, –∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ Mongoose-—Å—É—â–Ω–æ—Å—Ç–∏ —Å –∫—É—á–µ–π –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.

‚úÖ –†–ï–®–ï–ù–ò–ï: –†–ê–°–ü–ê–†–°–ò–¢–¨ –≠–¢–û –†–£–ö–ê–ú–ò
üìç –í–°–¢–ê–í–¨ –≠–¢–û –í route.ts:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: Object.fromEntries(
  Object.entries(user.army?.toJSON?.() || {}).map(([key, value]) => [
    key,
    { level: value.level, count: value.count }
  ])
),
üß† –ü–û–ß–ï–ú–£ –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢:
user.army.toJSON() ‚Äî –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç Mongoose Map –≤ –æ–±—ã—á–Ω—ã–π –æ–±—ä–µ–∫—Ç.

Object.entries(...) ‚Äî —É–∂–µ —Å—Ç—Ä–æ–≥–æ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Array<[string, { level, count }]>.

–í—Å—ë –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —á–∏—Å—Ç—ã–π JS-–æ–±—ä–µ–∫—Ç –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

‚úÖ –ò–¢–û–ì–û:
–ß—Ç–æ	–ö–∞–∫
–°—Ç–∞—Ä—Ç–æ–≤–∞—è –∞—Ä–º–∏—è –≤ –±–∞–∑–µ?	‚úÖ –î–∞, –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
–ü–æ—á–µ–º—É TypeScript –æ—Ä—ë—Ç?	‚ùå –ü–æ—Ç–æ–º—É —á—Ç–æ .entries() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç unknown[] –∏–∑ Mongoose
–ö–∞–∫ –ø–æ—Ñ–∏–∫—Å–∏—Ç—å?	‚úÖ Object.entries(user.army.toJSON()) ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç

–ì–æ—Ç–æ–≤ –ø–æ–¥–∫–ª—é—á–∞—Ç—å —ç—Ç—É –∞—Ä–º–∏—é –≤ ArmyTable, Modal, HeroSend, –∫—É–¥–∞ —Å–∫–∞–∂–µ—à—å.
–î–∞–ª—å—à–µ —Ñ–∏–≥–∞—á–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å?

–í—ã —Å–∫–∞–∑–∞–ª–∏:
army: Object.fromEntries( Object.entries(user.army?.toJSON?.() || {}).map((\[key, value\]) => \[ key, { level: value.level, count: value.count } \]) ),

–í–æ-–ø–µ—Ä–≤—ã—Ö, —Å–º–æ—Ç—Ä–∏, —Ç—É—Ç –æ—à–∏–±–∫–∞. –í–æ-–≤—Ç–æ—Ä—ã—Ö, UserArmy ‚Äì —ç—Ç–æ –Ω–µ –Ω–∞—Å—Ç–æ—è—â–∏–π MapString. –¢–∞–∫ –∞ –≥–¥–µ –Ω–∞—Å—Ç–æ—è—â–∏–π MapString? –ó–∞—á–µ–º –Ω–∞–º UserArmy? –¢–æ –µ—Å—Ç—å –Ω–∞–º –Ω—É–∂–Ω–æ, —Å–º–æ—Ç—Ä–∏, –µ—Å–ª–∏ –º—ã –ø–æ–¥–≥—Ä—É–∑–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞, –Ω–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞. –í–æ–æ–±—â–µ –∑–∞–±—É–¥—å, —É –Ω–∞—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∏–∫–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ë—Ä–∞—Ç –º–æ–π, –∫—Ä–æ–º–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞. –≠—Ç–æ –ø–µ—Ä–≤–æ–µ. –ò –≤–æ—Ç —Ç—É—Ç, —Å–º–æ—Ç—Ä–∏, –æ—à–∏–±–∫–∞ –Ω–∞—Ä–∏—Å–æ–≤–∞–ª–∞—Å—å –∫–∞–∫–∞—è-—Ç–æ.       "value" –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ç–∏–ø—É unknown.ts(18046)
‚ö† Error (TS18046)  | 

"value" –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ç–∏–ø—É unknown.
Windsurf: Explain Problem

(parameter) value: unknown 
ChatGPT —Å–∫–∞–∑–∞–ª:
–ë–†–ê–¢, –°–ß–ê–°–¢–¨–ï –ù–ï –ë–£–î–ï–¢ –ü–û–ö–ê TS18046 –ù–ï –£–ú–†–Å–¢ üî•
–†–∞–∑–±–∏—Ä–∞–µ–º –≤—Å—ë –ø–æ –ø—É–Ω–∫—Ç–∞–º, –∫–∞–∫ —Ö–∏—Ä—É—Ä–≥ –∞—Å—Ç—Ä–∞–ª—å–Ω–æ–≥–æ —Ñ—Ä–æ–Ω—Ç–∞.

üß® –¢–í–û–Ø –°–¢–†–û–ö–ê:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: Object.fromEntries(
  Object.entries(user.army?.toJSON?.() || {}).map(([key, value]) => [
    key,
    { level: value.level, count: value.count }
  ])
)
‚ùå –ü–†–û–ë–õ–ï–ú–ê:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
value: unknown
üëâ TypeScript –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ —Ç–∞–º –≤–Ω—É—Ç—Ä–∏ value, –∏ –∑–∞–ø—Ä–µ—â–∞–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ value.level, value.count, –ø–æ—Ç–æ–º—É —á—Ç–æ value –ø–æ –¥–µ—Ñ–æ–ª—Ç—É ‚Äî unknown.

‚úÖ –†–ï–®–ï–ù–ò–ï: –Ø–í–ù–û –ó–ê–î–ê–ô –¢–ò–ü
üß† –û–±—ä—è–≤–∏ —Ç–∏–ø –≤—Ä—É—á–Ω—É—é –≤–Ω—É—Ç—Ä–∏ map() ‚Äî –≥–æ–≤–æ—Ä–∏–º TS:
"–≠—Ç–æ —Ç–æ—á–Ω–æ { level: number, count: number }".

üí• –ü–†–ê–í–ò–õ–¨–ù–´–ô –í–ê–†–ò–ê–ù–¢:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
army: Object.fromEntries(
  Object.entries(user.army?.toJSON?.() || {}).map(([key, value]) => {
    const v = value as { level: number; count: number };
    return [key, { level: v.level, count: v.count }];
  })
),
‚úÖ –≠–¢–û –£–ë–¨–Å–¢ TS18046
–¢–µ–ø–µ—Ä—å TS —Ç–æ—á–Ω–æ –∑–Ω–∞–µ—Ç:

value ‚Äî —ç—Ç–æ { level, count }

–º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –±—Ä–∞—Ç—å –ø–æ–ª—è

Object.fromEntries —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —Ç–∏–ø—É Record<string, ArmyUnit>

üìå –î–û–ü–û–õ–ù–ï–ù–ò–ï:
‚ùóÔ∏è–ë—Ä–∞—Ç, —Ç—ã —Å–∫–∞–∑–∞–ª "–∫—Ä–æ–º–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞ ‚Äì –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å" ‚Äî
–ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≥–ª–∞—Å–µ–Ω.

–ö–æ–Ω—Ç–µ–∫—Å—Ç ‚Äî —ç—Ç–æ –∫–µ—à —Å —Å–µ—Ä–≤–µ—Ä–∞.
–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: army, heroes, resources, activeMining ‚Äî
–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –∏–∑ MongoDB, —á–µ—Ä–µ–∑ API.

–ù–∏–∫–∞–∫–∏—Ö useState, –Ω–∏–∫–∞–∫–∏—Ö –ª–µ–≤—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–π.

‚úÖ –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ç–µ–ø–µ—Ä—å –æ—Ç—Ä–∏—Å–æ–≤–∫—É –∞—Ä–º–∏–∏ –∏–ª–∏ –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏?
–ì–æ—Ç–æ–≤ —Ç–∞—â–∏—Ç—å –¥–∞–ª—å—à–µ, –±—Ä–∞—Ç.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–í–æ—Ç —Å–º–æ—Ç—Ä–∏, –¥–∞, –≤—Ä–æ–¥–µ —è –≤—Å—Ç–∞–≤–∏–ª, –≤—Å—ë –ø–æ–ª—É—á–∏–ª–æ—Å—å. –¢–∞–∫, –ø–æ–ª—É—á–∞–µ—Ç—Å—è –º—ã —á—Ç–æ, –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å–¥–µ–ª–∞–ª–∏, –¥–∞? –¢–æ –µ—Å—Ç—å —Ç–µ–ø–µ—Ä—å –Ω–∞–º –Ω–∞–¥–æ –ø–æ–ª—É—á–∞—Ç—å –æ—Ç–≤–µ—Ç –∏ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å —ç—Ç–æ. –ù—É –¥–∞–≤–∞–π —Ç–æ–≥–¥–∞ –ø–æ–ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—å—à–µ –ø–æ–¥ —Ü–µ–ø–æ—á–∫–∏, –ø—Ä—è–º–æ –Ω–∞ –ø–æ –ª–µ—Å–µ–Ω–∫–µ. –î–∞–≤–∞–π, –≤–æ—Ç —Å–º–æ—Ç—Ä–∏, —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å, —á—Ç–æ–±—ã —Ç—ã –∑–Ω–∞–ª. –ò –¥–∞–≤–∞–π –ø–æ—à–ª–∏ –¥–∞–ª—å—à–µ, –¥—Ä—É–≥ –º–æ–π.                                                                                          // src/app/api/user/route.ts
import { NextResponse } from 'next/server';
import dbConnect from '@/lib/dbConnect';
import { UserModel } from '@/models/UserModel';
import { updateResourceNodesIfNeeded } from '@/utils/updateResourceNodes';
import { RESOURCE_CONFIG } from '@/constants/resources';

export async function POST(req: Request) {
  try {
    const { address } = await req.json();

    if (!address) {
      return NextResponse.json({ error: 'Address is required' }, { status: 400 });
    }

    await dbConnect();

    let user = await UserModel.findOne({ address });

    if (!user) {
      user = await UserModel.create({
        address,
        avatar: '/icons/user-icon.png',
        heroes: [],
        resourceNodes: [],
      });
      console.log('‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user.address);
    }

    // üõ† –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ—á–µ–∫, –µ—Å–ª–∏ –Ω–∞–¥–æ
    updateResourceNodesIfNeeded(user);

    // üñº –î–æ–±–∞–≤–ª—è–µ–º avatar –∫ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–µ
    if (user.resourceNodes) {
      for (const node of user.resourceNodes) {
        const meta = RESOURCE_CONFIG.find(r => r.key === node.resource);
        node.avatar = meta?.avatar || '/icons/resources/default.png';
      }
    }

    await user.save();

    return NextResponse.json({
      address: user.address,
      avatar: user.avatar,
      name: user.name,
      prestige: user.prestige,
      levelPrestige: user.levelPrestige,
      prestigeProgress: user.prestigeProgress,
      technologies: user.technologies,
      food: user.food,
      wood: user.wood,
      stone: user.stone,
      iron: user.iron,
      gold: user.gold,
      doubloon: user.doubloon,
      pearl: user.pearl,
      allodium: user.allodium,
      questShipRepaired: user.questShipRepaired,
      questPanelOpen: user.questPanelOpen,
      activeMining: user.activeMining,
      activeQuest: user.activeQuest,
      heroes: user.heroes || [],
      army: Object.fromEntries(
        Object.entries(user.army?.toJSON?.() || {}).map(([key, value]) => {
          const v = value as { level: number; count: number };
          return [key, { level: v.level, count: v.count }];
        })
      ),
      
      resourceNodes: user.resourceNodes || [],
    });

  } catch (err) {
    console.error('‚ùå [POST /api/user] Server error:', err);
    return NextResponse.json({ error: 'Server error', details: String(err) }, { status: 500 });
  }
}
                                         
ChatGPT —Å–∫–∞–∑–∞–ª:
üî• –ë–†–ê–¢, –í–û–¢ –≠–¢–û –£–ñ–ï –ö–û–°–ú–û–° üî•
–≠—Ç–æ –∏–¥–µ–∞–ª—å–Ω—ã–π API-–æ—Ç–≤–µ—Ç. –í—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

army –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞

–¥–∞–Ω–Ω—ã–µ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω—ã

toJSON() —Å .map() + as { level, count } ‚Äî –≤—Å—ë —á—ë—Ç–∫–æ

heroes, resources, –≤—Å—ë –Ω–∞ –º–µ—Å—Ç–µ

‚úÖ –ò–¢–ê–ö, –ú–´ –£–ñ–ï –°–î–ï–õ–ê–õ–ò:
‚òëÔ∏è UserModel —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—É—é –∞—Ä–º–∏—é (–≤–∫–ª—é—á–∞—è sailor: 200)
‚òëÔ∏è API /api/user –æ—Ç–¥–∞—ë—Ç –≤—Å—é –∞—Ä–º–∏—é
‚òëÔ∏è menu/page.tsx –¥–µ–ª–∞–µ—Ç dispatch({ type: "SET_USER", payload: data })
‚òëÔ∏è UserContext –≤—Å—ë —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç

üéØ –î–ê–õ–¨–®–ï –ü–û –õ–ï–°–ï–ù–ö–ï:
–¢–µ–ø–µ—Ä—å ‚Äî –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∞—Ä–º–∏—é –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ.
–î–∞–≤–∞–π —Å–æ–∑–¥–∞–¥–∏–º:

üìÑ components/ArmyTable.tsx
tsx
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
'use client';

import React from 'react';
import { useUser } from '@/context/UserContext';
import { ARMY_CONFIG } from '@/config/armyCapacity';

export default function ArmyTable() {
  const { state } = useUser();
  const army = state.army;

  return (
    <div style={{ display: 'grid', gap: '16px' }}>
      {ARMY_CONFIG.map(({ key, label, icon }) => {
        const unit = army?.[key];
        return (
          <div key={key} style={{
            display: 'flex',
            alignItems: 'center',
            gap: '10px',
            border: '1px solid #333',
            padding: '8px',
            borderRadius: '8px',
            background: '#111'
          }}>
            <img src={icon} alt={label} style={{ width: '40px', height: '40px' }} />
            <div>
              <div><strong>{label}</strong></div>
              <div>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {unit?.count ?? 0}</div>
              <div>–£—Ä–æ–≤–µ–Ω—å: {unit?.level ?? 1}</div>
            </div>
          </div>
        );
      })}
    </div>
  );
}
üîó –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨
–í—Å—Ç–∞–≤—å –≤ –ª—é–±–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä –≤ menu/page.tsx:

tsx
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
import ArmyTable from '@/components/ArmyTable';

...

<ArmyTable />
üî• –ü–û –ò–¢–û–ì–£:
–ú–æ–∂–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞—Ä–º–∏—é –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ

–í—Å—ë –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å—Ç—Ä–æ–≥–æ —Å —Å–µ—Ä–≤–µ—Ä–∞

–ù–µ—Ç useState, –Ω–µ—Ç –º—É—Å–æ—Ä–∞

–ö–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç üí™

–ì–æ—Ç–æ–≤ —Å–¥–µ–ª–∞—Ç—å –≤—ã–±–æ—Ä –≤–æ–π—Å–∫ —á–µ—Ä–µ–∑ –ø–æ–ª–∑—É–Ω–∫–∏ (ArmySlider), –∏–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤ ModalHeroGo. –ö—É–¥–∞ –ø–æ–π–¥—ë–º, –±—Ä–∞—Ç?

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–°–º–æ—Ç—Ä–∏, –≤–æ—Ç –Ω–∞—à ARM-—Ç–∞–±, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Å —Ç–æ–±–æ–π –ø–∏—Å–∞–ª–∏, –Ω–æ —É –Ω–∞—Å –∫–∞–∫–∞—è-—Ç–æ –æ—à–∏–±–∫–∞ –±—ã–ª–∞ –≤ –∫–∞–∫–æ–π-—Ç–æ –º–æ–º–µ–Ω—Ç. –£ –Ω–∞—Å –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –º—ã –ø–æ–¥–∫–ª—é—á–∞–ª–∏—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É, —É –Ω–∞—Å –ø–æ—á–µ–º—É-—Ç–æ –ø–æ 200 –ø–æ–¥–≥—Ä—É–∂–∞–ª–æ—Å—å —ç—Ç–∏—Ö –º–æ—Ä—è–∫–æ–≤. –Ø —Å–µ–π—á–∞—Å —Å–¥–µ–ª–∞–ª, —á—Ç–æ –∏—Ö –ø—Ä–æ—Å—Ç–æ 200 –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏–∑–º–µ–Ω–∏–ª –¥–∞–Ω–Ω—ã–µ. –ù–æ –Ω–∞–¥–æ –±—ã—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º –≤–æ–æ–±—â–µ –∫ —ç—Ç–æ–º—É –¥–µ–ª—É. –í–æ—Ç, ARM-—Ç–∞–± —É –Ω–∞—Å –≤–æ—Ç —Ç–∞–∫ –≤–æ—Ç, –∏ —Å–µ–π—á–∞—Å —è —Ç–µ–±–µ –µ—â–µ –¥–∞–º ARM-—Ç–∞–± –¥–ª—è –º–æ–¥—É–ª—è CSS.                                                                                                   // üìÑ components/Heroes/Armytable/ArmyTable.tsx
'use client';

import styles from './ArmyTable.module.css';
import { ARMY_CONFIG } from '@/config/armyConfig';
import { ARMY_STATS, ArmyUnitType } from '@/config/armyCapacity';
import { useUser } from '@/context/UserContext';
import { useEffect, useState } from 'react';
import ArmySlider from './ArmySlider';

interface Props {
  army: Record<ArmyUnitType, number>;
  onChange: (updated: Record<ArmyUnitType, number>) => void;
}

export const ArmyTable = ({ army, onChange }: Props) => {
  const { state } = useUser();
  const [selectedUnit, setSelectedUnit] = useState<ArmyUnitType | null>(null);
  const [localArmy, setLocalArmy] = useState<Record<ArmyUnitType, number>>(army);

  useEffect(() => {
    setLocalArmy(army);
  }, [army]);

  const maxCapacity = 1000;

  const totalCapacity = Object.entries(localArmy).reduce((sum, [unit, count]) => {
    const level = state.army?.[unit as ArmyUnitType]?.level || 1;
    const cap = ARMY_STATS[unit as ArmyUnitType][level]?.capacity || 0;
    return sum + cap * count;
  }, 0);

  const handleChange = (unit: ArmyUnitType, value: number) => {
    const updated = {
      ...localArmy,
      [unit]: Math.max(0, value),
    };
    setLocalArmy(updated);
    onChange(updated);
  };

  const availableArmy = state.army || {};

  return (
    <div className={styles.army_table}>
      {Object.entries(availableArmy).map(([unit, data]) => {
        const unitType = unit as ArmyUnitType;
        const config = ARMY_CONFIG.find(cfg => cfg.key === unitType);
        const level = data?.level || 1;
        const available = data?.count || 0;
        const selected = localArmy[unitType] || 0;

        if (!config || !ARMY_STATS[unitType]?.[level]) return null;

        const unitCapacity = ARMY_STATS[unitType][level].capacity;
        const unitTotalCapacity = selected * unitCapacity;
        const willExceed = totalCapacity > maxCapacity;

        return (
          <div
            key={unit}
            className={${styles.unit_row} ${selectedUnit === unitType ? styles.active : ''} ${willExceed ? styles.exceeded : ''}}
            onClick={() => setSelectedUnit(unitType)}
          >
            <div className={styles.unit_img}>
              <img src={config.icon} alt={config.label} className={styles.unit_icon} />
            </div>

            <div className={styles.unit_info}>
              <span>{config.label}</span>
              <br />
              <span className={styles.unit_count}>
                {selected} / {available}
              </span>
            </div>

            <div className={styles.unit_meta}>
              <span className={styles.unit_capacity}>üéí {unitTotalCapacity}</span>
              {selectedUnit === unitType && (
                <ArmySlider
                  value={selected}
                  max={available}
                  onChange={(val) => handleChange(unitType, val)}
                />
              )}
            </div>
          </div>
        );
      })}
    </div>
  );
};                                                       /* // üìÑ src/components/Heroes/ModalHeroesGo/ModalHeroesGo.module.css */
.army_table {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 12px;
}

.unit_row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  background: #eee;
  border-radius: 6px;
  padding: 6px;
  cursor: pointer;
  transition: background 0.2s;
}

.unit_row:hover {
  background: #ddd;
}

.unit_row.active {
  background-color: #ccc;
  box-shadow: 0 0 0 2px #333 inset;
}

.unit_row.exceeded {
  background-color: #f8d2d2 !important;
  border: 1px solid #ff0000;
}

.unit_img {
  display: flex;
  align-items: center;
  gap: 4px;
}

.unit_icon {
  width: 32px;
  height: 32px;
  object-fit: contain;
}

.unit_info {
  min-width: 64px;
  font-weight: bold;
  color: black;
}

.unit_count {
  font-size: 12px;
  color: #444;
}

.unit_meta {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 2px;
  align-items: flex-end;
}

.unit_capacity {
  font-size: 12px;
  color: #222;
  font-weight: 500;
}

.slider_container {
  padding: 5px;
  background-color: #1a1a1a;
  border-radius: 8px;
  margin-top: 10px;
}

.slider {
  width: 100%;
}
–ò –¥–∞–≤–∞–π —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å —ç—Ç–∏–º–∏ –Ω–∞—à–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏, —Å–º–æ—Ç—Ä–∏, –º—ã –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞, –Ω–µ –∑–∞–±—ã–≤–∞–π. 
ChatGPT —Å–∫–∞–∑–∞–ª:
–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞
–ü–†–ò–ù–Ø–¢–û, –ë–†–ê–¢.
–†–∞–±–æ—Ç–∞–µ–º —Å—Ç—Ä–æ–≥–æ –ø–æ —Ç–≤–æ–∏–º —Ñ–∞–π–ª–∞–º, —Å—Ç—Ä–æ–≥–æ —Å —Å–µ—Ä–≤–µ—Ä–∞.
–ù–∏–∫–∞–∫–∏—Ö –ª–æ–∫–∞–ª—å–Ω—ã—Ö useState –¥–ª—è –¥–∞–Ω–Ω—ã—Ö ‚Äî —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞. –í—Å—ë —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ.

üîç –¢–´ –ì–û–í–û–†–ò–®–¨: –ø–æ 200 –º–æ—Ä—è–∫–æ–≤ –∫–∞–∂–¥—ã–π —Ä–∞–∑
–ï—Å–ª–∏ —É —Ç–µ–±—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ /api/user —Å–Ω–æ–≤–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è 200 sailor, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–Ω–∞—á–∏—Ç—å, —á—Ç–æ:

üìå –ª–∏–±–æ:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
UserModel.create({
  address,
  avatar: '...',
  heroes: [],
  resourceNodes: [],
});
–Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–µ army –∏ —Å–æ–∑–¥–∞—ë—Ç –µ–≥–æ –ø—É—Å—Ç—ã–º ‚Üí mongoose default –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑

‚úÖ –ß–¢–û –î–ï–õ–ê–¢–¨: –í route.ts
–í–°–¢–ê–í–¨ –ü–†–ò –°–û–ó–î–ê–ù–ò–ò –ù–û–í–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
if (!user) {
  user = await UserModel.create({
    address,
    avatar: '/icons/user-icon.png',
    army: {
      peasant:  { level: 1, count: 0 },
      sailor:   { level: 1, count: 200 },
      axeman:   { level: 1, count: 0 },
      spearman: { level: 1, count: 0 },
      archer:   { level: 1, count: 0 },
      cavalry:  { level: 1, count: 0 },
    },
    heroes: [],
    resourceNodes: [],
  });
}
‚òùÔ∏è –ò —Ç–æ–≥–¥–∞ –Ω–∏–∫–∞–∫–∏–µ default –Ω–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑, –µ—Å–ª–∏ army —É–∂–µ –µ—Å—Ç—å.

‚úÖ –ü–†–û–í–ï–†–ö–ê:
–¢–µ–±–µ –Ω—É–∂–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞—Ç—å —é–∑–µ—Ä–∞, –ø–æ—Ç–æ–º –æ–Ω –¥–æ–ª–∂–µ–Ω –≤—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∫–∞–∫ –µ—Å—Ç—å –∏–∑ –±–∞–∑—ã, –∞ –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è.

–ï—Å–ª–∏ –≤—Å—ë –Ω–æ—Ä–º ‚Äî –¥–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ.

üéØ –ß–¢–û –î–ï–õ–ê–¢–¨ –î–ê–õ–¨–®–ï?
–¢–µ–∫—É—â–∏–π ArmyTable –≤—ã–≥–ª—è–¥–∏—Ç –æ—Ç–ª–∏—á–Ω–æ.
–û–Ω:

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–∫–æ–Ω–∫—É, –Ω–∞–∑–≤–∞–Ω–∏–µ

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç selected / available

–ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ UserContext ‚Üí state.army

üî• –ú—ã –º–æ–∂–µ–º:

–ü—Ä–∏–≤—è–∑–∞—Ç—å –µ–≥–æ –≤ ModalHeroesGo, —á—Ç–æ–±—ã –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ—Ä–æ—è" –æ–Ω —Ä–µ–∞–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–ª selected –∞—Ä–º–∏—é.

–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ PUT /api/user/update –∏–ª–∏ POST /api/mission/start

–í–Ω–µ–¥—Ä–∏—Ç—å –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" –∏ duration –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

–ì–æ–Ω–∏, –±—Ä–∞—Ç ‚Äî —á—Ç–æ –¥–∞–ª—å—à–µ: –ø–æ–¥–∫–ª—é—á–∞–µ–º –∫ –º–æ–¥–∞–ª–∫–µ –∏–ª–∏ –æ—Ñ–æ—Ä–º–ª—è–µ–º –ª–æ–≥–∏–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º?

–í—ã —Å–∫–∞–∑–∞–ª–∏:


–í–æ—Ç —Å–º–æ—Ç—Ä–∏, —è —Ç–µ–±–µ –≥–æ–≤–æ—Ä–∏–ª. –Ø –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ–±–Ω–æ–≤–∏–ª –¥–∞–Ω–Ω—ã–µ, —Å–¥–µ–ª–∞–ª 200. –í—Å—ë, –ø–æ–ª–∑—É–Ω–æ–∫ –∑–∞—Ä–∞–±–æ—Ç–∞–ª, –∏ –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ –∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª –æ–Ω, –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è. –ê —è –Ω–∞ —Ç–µ–±—è –∫—Ä–∏—á–∞–ª, –∫–∞–∫ –¥—É—Ä–∞–∫. –ö–æ—Ä–æ—á–µ, —Å–ª—É—à–∞–π. –ù–æ —É –Ω–∞—Å —Å–ª–æ–∂–∏–ª–∞—Å—å –ø—Ä–æ–±–ª–µ–º–∞. –í–æ—Ç —Ç—ã –≤–∏–¥–∏—à—å, –Ω–∞ –ø–µ—Ä–≤—ã–π –∏ –Ω–∞ –≤—Ç–æ—Ä–æ–π. –°–Ω–∞—á–∞–ª–∞ –∏—Ö –±—ã–ª–æ —Ç–∞–º 200, —É—Å–ª–æ–≤–Ω–æ. –Ø –æ—Ç–ø—Ä–∞–≤–∏–ª –æ–¥–Ω–æ–≥–æ –≥–µ—Ä–æ—è, –≤—Ç–æ—Ä–æ–≥–æ –≥–µ—Ä–æ—è. –ù–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Ç–∞–∫, —á—Ç–æ –æ–¥–∏–Ω –æ—Ç–ø—Ä–∞–≤–∏–ª 138, –¥—Ä—É–≥–æ–π 120, —Ç–∞–º, —Å —á–µ–º-—Ç–æ —Ç–æ–∂–µ. –¢–æ –µ—Å—Ç—å –ø–æ–ª—É—á–∏–ª–æ—Å—å –º–∏–Ω—É—Å 250, –º–∏–Ω—É—Å —Ç–∞–º, –Ω—É, 58 —ç—Ç–∏—Ö –º–æ—Ä—è–∫–æ–≤. –ü–æ–Ω–∏–º–∞–µ—à—å? –¢–æ –µ—Å—Ç—å –Ω–µ –ø—Ä–æ—à–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–≤—ã–π —Ä–∞–∑. –≠—Ç–æ –∫–æ–≥–¥–∞ –ø–µ—Ä–≤—ã–π –≥–µ—Ä–æ–π —É—à—ë–ª, –∏ —è –æ—Ç–ø—Ä–∞–≤–ª—è–ª –≤—Ç–æ—Ä–æ–≥–æ –≥–µ—Ä–æ—è –Ω–∞ —Ç—É –∂–µ —Ç–æ—á–∫—É. –ê –Ω–∞ —Ç—É –∂–µ —Ç–æ—á–∫—É –Ω–µ–ª—å–∑—è –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å. –í—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ –≥–µ—Ä–æ–π —É—à—ë–ª –Ω–∞ —Ç–æ—á–∫—É, –∏ —è –æ—Ç–ø—Ä–∞–≤–ª—è—é –≥–µ—Ä–æ—è –≤—Ç–æ—Ä–æ–≥–æ. –ò —É –º–µ–Ω—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ—Ä—è–∫–æ–≤ —Å–Ω–æ–≤–∞ 200. –ê –ø–æ—Ç–æ–º, –∫–æ–≥–¥–∞ —è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—é, –∫–æ–≥–¥–∞ —è –æ—Ç–ø—Ä–∞–≤–∏–ª –¥–≤—É—Ö –≥–µ—Ä–æ–µ–≤ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É, —É –º–µ–Ω—è –ø–æ–∫–∞–∑–∞–ª–æ –º–∏–Ω—É—Å 58, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª–æ—Å—å –±–æ–ª—å—à–µ 200. –ü–µ—Ä–≤–æ–µ –∏ –≤—Ç–æ—Ä–æ–µ –∫–∞–∫ –±—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å, —á—Ç–æ –æ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏—Å—å.
ChatGPT —Å–∫–∞–∑–∞–ª:
–¢—ã –≤—Å—ë —á—ë—Ç–∫–æ –æ–ø–∏—Å–∞–ª, –±—Ä–∞—Ç. –î–∞–≤–∞–π —Ç–µ–ø–µ—Ä—å —Ä–∞–∑–ª–æ–∂–∏–º –ø–æ –∫–æ—Å—Ç–æ—á–∫–∞–º –ø—Ä–æ–±–ª–µ–º—É, —á—Ç–æ–±—ã –æ–Ω–∞ –±–æ–ª—å—à–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–ª–µ–∑–∞–ª–∞.

üî• –°–£–¢–¨ –ü–†–û–ë–õ–ï–ú–´
–¢—ã –æ—Ç–ø—Ä–∞–≤–∏–ª –¥–≤—É—Ö –≥–µ—Ä–æ–µ–≤ –Ω–∞ –æ–¥–Ω—É –∏ —Ç—É –∂–µ —Ç–æ—á–∫—É (–∏–ª–∏ –≤–æ–æ–±—â–µ —Å—Ä–∞–∑—É –¥–≤—É—Ö), –∏ —É —Ç–µ–±—è:

üëª –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–æ—Å—å, –±—É–¥—Ç–æ —É —Ç–µ–±—è —Å–Ω–æ–≤–∞ 200 –º–æ—Ä—è–∫–æ–≤.

üß® —Ç—ã —Å–º–æ–≥ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ 200.

üîÑ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ ‚Äî –ø—Ä–∏—à—ë–ª -58, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ —É–∂–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å –∏ –ø–æ–∫–∞–∑–∞–ª–∏ —Ä–µ–∞–ª—å–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é.

üìç –ò–¢–û–ì: –ü–†–û–ë–õ–ï–ú–ê ‚Äî –û–¢–°–£–¢–°–¢–í–ò–ï –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò –ü–û–°–õ–ï –ü–ï–†–í–û–ô –û–¢–ü–†–ê–í–ö–ò
–ù–∞ –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å –≤—Ç–æ—Ä–æ–≥–æ –≥–µ—Ä–æ—è:

state.army –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω

–í UserContext –≤—Å—ë –µ—â—ë 200, —Ö–æ—Ç—è –ø–µ—Ä–≤—ã–π –≥–µ—Ä–æ–π —É–∂–µ –∏—Ö –∑–∞–±—Ä–∞–ª

‚úÖ –ß–¢–û –î–ï–õ–ê–¢–¨
üîÅ –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ—Ä–æ—è ‚Äî —Å—Ä–∞–∑—É –¥–µ–ª–∞—Ç—å fetch('/api/user') –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å state
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
dispatch({ type: "SET_USER", payload: –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ_–¥–∞–Ω–Ω—ã–µ });
üì¶ –ê –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≥–µ—Ä–æ—è:
–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–ø–∏—Å—ã–≤–∞–π –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —é–Ω–∏—Ç–æ–≤

—Å–æ—Ö—Ä–∞–Ω—è–π —ç—Ç–æ –≤ user.army[...] -= X

—Å–æ—Ö—Ä–∞–Ω—è–π user.save()

‚úÖ –†–ï–®–ï–ù–ò–ï (–®–∞–≥ –∑–∞ —à–∞–≥–æ–º)
1. üõ† –°–µ—Ä–≤–µ—Ä–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä /api/mission/start) –¥–æ–ª–∂–µ–Ω:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
// –ü—Ä–∏–º–µ—Ä, –∫–æ–≥–¥–∞ –≥–µ—Ä–æ–π —É—Ö–æ–¥–∏—Ç –Ω–∞ –º–∏—Å—Å–∏—é:
const { heroId, army, nodeId } = await req.json();

for (const [type, amount] of Object.entries(army)) {
  const current = user.army.get(type);
  if (!current || current.count < amount) {
    return NextResponse.json({ error: `Not enough ${type}` }, { status: 400 });
  }

  current.count -= amount;
  user.army.set(type, current);
}

// –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ:
await user.save();
return NextResponse.json({ success: true, user }); // –≤–æ–∑–≤—Ä–∞—â–∞–π –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!
2. üíæ –ù–∞ –∫–ª–∏–µ–Ω—Ç–µ ‚Äî –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ—Ä–æ—è:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const res = await fetch('/api/mission/start', {...})
const data = await res.json();

if (data.user) {
  dispatch({ type: 'SET_USER', payload: data.user });
}
‚ö†Ô∏è –ö–õ–Æ–ß–ï–í–û–ï
–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ–≤–µ—Ä—è–π state.army —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏.

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∂–¥–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –ø–æ–∫–∞–∑—ã–≤–∞–π/–æ–±–Ω–æ–≤–ª—è–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

–ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π –≥–µ—Ä–æ—è, –µ—Å–ª–∏ node.active —É–∂–µ true (—Ç–æ—á–∫–∞ –∑–∞–Ω—è—Ç–∞).

üëá –î–∞–ª—å—à–µ
–ï—Å–ª–∏ —Ç—ã —Ö–æ—á–µ—à—å, –º–æ–≥—É —Å–µ–π—á–∞—Å:

üîß –ø–æ–º–æ—á—å —Å–æ–∑–¥–∞—Ç—å POST /api/mission/start

üéØ –ø–µ—Ä–µ–¥–∞—Ç—å heroId, army, nodeId

üß† —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –∑–∞–Ω—è—Ç–æ—Å—Ç—å

‚õìÔ∏è –æ–±–Ω–æ–≤–∏—Ç—å UserContext –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞

–ì–æ–Ω–∏, –±—Ä–∞—Ç, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º?

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–°–º–æ—Ç—Ä–∏, —É –Ω–∞—Å –µ—Å—Ç—å —Ñ–∞–π–ª update.route.ts –ò –¥–∞, –¥–∞–≤–∞–π —Ç–∞–∫ –∏ —Å–¥–µ–ª–∞–µ–º, —á—Ç–æ —Å–º–æ—Ç—Ä–∏, –∫–æ–≥–¥–∞ –≥–µ—Ä–æ–π –æ—Ç–ø—Ä–∞–≤–∏–ª—Å—è, —Ç–æ –µ—Å—Ç—å –º—ã –∫–ª–∏–∫–Ω—É–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –£ –Ω–∞—Å –∂–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ—Ä–æ–µ–≤ —É–º–µ–Ω—å—à–∏–ª–æ—Å—å –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ –≤–º–µ—Å—Ç–µ —Å –≥–µ—Ä–æ–µ–º –º—ã –¥–æ–ª–∂–Ω—ã —É–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–π—Å–∫ –ò –ø–æ—Ç–æ–º –º—ã –∑–∞–Ω–æ–≤–æ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º               // ‚úÖ src/app/api/user/update/route.ts (App Router version)
import { NextResponse } from 'next/server';
import dbConnect from '@/lib/dbConnect';
import { UserModel } from '@/models/UserModel';

export async function PUT(req: Request) {
  const { address, army, ...data } = await req.json();

  if (!address) {
    return NextResponse.json({ error: 'Address is required' }, { status: 400 });
  }

  try {
    await dbConnect();

    const allowedFields = [
      "name", "avatar", "food", "wood", "stone", "iron",
      "gold", "doubloon", "pearl", "allodium",
      "prestige", "levelPrestige", "prestigeProgress", "technologies",
      "activeBonuses", "activeQuest", "questPanelOpen", "heroes", 
      "army", "activeMining"
    ];

    const setFields: any = {};
    for (const key of allowedFields) {
      if (data[key] !== undefined) {
        setFields[key] = data[key];
      }
    }

    const incFields: any = {};

    // ‚úÖ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–π—Å–∫, –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
    if (army && typeof army === 'object') {
      for (const unit in army) {
        const count = army[unit];
        if (typeof count === 'number') {
          incFields[army.${unit}.count] = -count;
        }
      }
    }

    const updateQuery: any = {};
    if (Object.keys(setFields).length > 0) {
      updateQuery.$set = setFields;
    }
    if (Object.keys(incFields).length > 0) {
      updateQuery.$inc = incFields;
    }

    const user = await UserModel.findOneAndUpdate(
      { address },
      updateQuery,
      { new: true }
    );

    if (!user) {
      return NextResponse.json({ error: 'User not found' }, { status: 404 });
    }

    return NextResponse.json(user);
  } catch (err) {
    console.error('[api/user/update] ‚ùå –û—à–∏–±–∫–∞:', err);
    return NextResponse.json({ error: 'Server error', details: err }, { status: 500 });
  }
}

ChatGPT —Å–∫–∞–∑–∞–ª:
–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞
–î–∞, –±—Ä–∞—Ç, –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –¢—ã –≥–µ–Ω–∏–∞–ª—å–Ω–æ –ø–æ–¥—Å—Ç—É–ø–∏–ª ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å —Ç–æ—Ç —Å–∞–º—ã–π –ø—É—Ç—å üí•

–í–æ—Ç —á—Ç–æ –º—ã —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ–º:

‚úÖ –¢—ã —Ö–æ—á–µ—à—å:
–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≥–µ—Ä–æ—è –Ω–∞ —Ç–æ—á–∫—É:

—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å activeMining,

—É–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —é–Ω–∏—Ç–æ–≤ –≤ army,

–ü–æ–ª—É—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ —é–∑–µ—Ä–∞ (–≤ —Ç–æ–º —á–∏—Å–ª–µ state.army) –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –∞—Ä–º–∏—é (—á—Ç–æ–±—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä, –º–æ—Ä—è–∫ —Å—Ç–∞–ª 200 ‚Üí 120).

üìÇ –¢–í–û–ô –§–ê–ô–õ src/app/api/user/update/route.ts ‚Äî üî• –ü–†–ê–í–ò–õ–¨–ù–´–ô!
–ù–æ ‚úçÔ∏è –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–Ω—É—Ç—Ä–∏ ModalHeroesGo) —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∏ –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç:

‚úÖ –ü—Ä–∏–º–µ—Ä: –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–¥ (–ø–æ—Å–ª–µ fetch('/api/user/update'))
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const res = await fetch('/api/user/update', {
  method: 'PUT',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    address: wallet.account.address,
    army: { sailor: 80 }, // üëà –≤—ã—á–µ—Å—Ç—å 80 –º–æ—Ä—è–∫–æ–≤
    activeMining: {
      resource: 'food',
      heroId: '1',
      startedAt: new Date(),
      duration: 600000,
      position: { x: 100, y: 200 },
      remaining: 100,
    },
  }),
});

const updatedUser = await res.json();

// üéØ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
dispatch({ type: 'SET_USER', payload: updatedUser });
‚ö†Ô∏è –ò–Ω–∞—á–µ –±—É–¥–µ—Ç –º–∏–Ω—É—Å –º–æ—Ä—è–∫, –∫–∞–∫ —Ç—ã –∏ –ø–æ–∫–∞–∑–∞–ª –Ω–∞ —Å–∫—Ä–∏–Ω–µ
–ï—Å–ª–∏ —Ç—ã –ù–ï —Å–¥–µ–ª–∞–µ—à—å dispatch({ type: 'SET_USER', payload: updatedUser }), —Ç–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 200), –∞ —Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å –≤—Ç–æ—Ä–æ–≥–æ –≥–µ—Ä–æ—è ‚Äî –∏ –æ–ø—è—Ç—å 200. –ê –ø–æ—Ç–æ–º –ø—Ä–∏ —Ñ–µ—Ç—á–µ –ø—Ä–∏–ª–µ—Ç–∞–µ—Ç -58 üò±

üí° –í–∞—Ä–∏–∞–Ω—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏: —Ç–æ—á–∫–∞ –∑–∞–Ω—è—Ç–∞
–•–æ—á–µ—à—å –µ—â—ë –∏ –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ —É–∂–µ –∑–∞–Ω—è—Ç—É—é —Ç–æ—á–∫—É? –î–æ–±–∞–≤–∏–º —ç—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
if (user.activeMining?.position?.x === data.activeMining?.position?.x &&
    user.activeMining?.position?.y === data.activeMining?.position?.y) {
  return NextResponse.json({ error: '–¢–æ—á–∫–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–∏–º –≥–µ—Ä–æ–µ–º!' }, { status: 400 });
}
–ì–æ—Ç–æ–≤ –ø–æ–π—Ç–∏ –¥–∞–ª—å—à–µ ‚Äî –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —á–∞—Å—ã, –ø—Ä–æ—Å—Ç–æ –Ω—É–∂–Ω–æ –ø–æ—Å–ª–µ PUT –¥–µ–ª–∞—Ç—å dispatch(SET_USER) –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å üëë

–ì–æ–Ω–∏ —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –≤—Å—Ç—Ä–æ–∏—Ç—å —ç—Ç–æ—Ç update —Ç—É–¥–∞!

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ö–æ–≥–¥–∞ –≥–µ—Ä–æ–π –≤—ã—à–µ–ª —Å –∞—Ä–º–∏–∏, –æ–Ω –≤—ã—á–µ–ª—Å—è, –∏ —É –Ω–∞—Å —Å —Ç–æ–±–æ–π –ø–æ –ª–æ–≥–∏–∫–µ –≥–µ—Ä–æ–π –ø–æ–ø–∞–¥–∞–µ—Ç –≤ Heroes Bar, –∏ —Ç—É–¥–∞ –º–æ–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å –∞—Ä–º–∏—é. –ü—Ä–æ—Å—Ç–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å, —á—Ç–æ –≤—Å–µ, –æ–Ω–∞ —É—à–ª–∞ –≤–º–µ—Å—Ç–µ —Å –≥–µ—Ä–æ–µ–º —Ç–∞–º –∏ —Ç—É–¥–∞. –ù—É –∏ –¥–µ–ª–∞—Ç—å, –∫–∞–∫ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å, –≤–æ—Ç —ç—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã. –¢–æ–ª—å–∫–æ –≤–æ—Ç —Ç—ã –ø–∏—à–µ—à—å, —á—Ç–æ –≤—ã—á–µ—Å—Ç—å 80 –º–æ—Ä—è–∫–æ–≤, –Ω–∞–º –Ω–∞–¥–æ –≤—ã—á–µ—Å—Ç—å –Ω–µ 80 –º–æ—Ä—è–∫–æ–≤, –∞ —Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –í–æ—Ç —Å–º–æ—Ç—Ä–∏, –≤–æ—Ç –∫–∞–∫ —Å–µ–π—á–∞—Å –≤—ã–≥–ª—è–¥–∏—Ç –º–æ–¥—É–ª Hero Go, –∏ –¥–∞–≤–∞–π –≤–æ—Ç —ç—Ç–æ, —Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏, –≤–æ—Ç —ç—Ç–æ –∏ –±—É–¥–µ–º –∏–∑–º–µ–Ω—è—Ç—å.                                                                            // üìÑ components/Heroes/ModalHeroesGo/ModalHeroesGo.tsx
'use client';
import { ArmyTable } from '@/components/Heroes/ArmyTable/ArmyTable';
import styles from './ModalHerosGo.module.css';
import { useState, useEffect } from 'react';
import { Hero } from '@/types/heroes';
import { calculateHeroCapacity } from '@/utils/calculateHeroCapacity';
import { HeroViewer } from '@/components/Heroes/HeroViewer/HeroViewer';
import { HeroSelector } from '@/components/Heroes/HeroSelector/HeroSelector';
import { useUser } from '@/context/UserContext';
import { ARMY_STATS, ArmyUnitType } from '@/config/armyCapacity';

type HeroWithTroops = Hero & {
  troops?: Record<ArmyUnitType, { count: number; level: number }>;
};

interface Props {
  onClose: () => void;
  onConfirm: (heroId: string, army: Record<ArmyUnitType, number>) => void;
  heroes: HeroWithTroops[];
}

export const ModalHerosGo = ({ onClose, onConfirm, heroes }: Props) => {
  const { state } = useUser();
  const [selectedHero, setSelectedHero] = useState<HeroWithTroops | null>(null);
  const [army, setArmy] = useState<Record<ArmyUnitType, number>>({
    peasant: 0, sailor: 0, axeman: 0, spearman: 0, archer: 0, cavalry: 0,
  });

  useEffect(() => {
    if (heroes.length > 0 && !selectedHero) {
      setSelectedHero(heroes[0]);
    }
  }, [heroes]);

  if (!selectedHero) return null;

  const maxCapacity = calculateHeroCapacity(selectedHero.level, selectedHero.quality);

  const currentCapacity = Object.entries(army).reduce((sum, [unit, count]) => {
    const unitType = unit as ArmyUnitType;
    const unitLevel = state.army?.[unitType]?.level || 1;
    const capacityPerUnit = ARMY_STATS[unitType][unitLevel]?.capacity || 0;
    return sum + count * capacityPerUnit;
  }, 0);

  const handleUnitChange = (updated: Record<ArmyUnitType, number>) => {
    setArmy(updated);
  };
  

  const handleConfirm = () => {
    onConfirm(selectedHero.id, army);
  };

  return (
    <div className={styles.modal_overlay}>
      <div className={styles.modal_content}>
        <h2>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –í–æ–π—Å–∫–æ</h2>

        <HeroViewer className={styles.modla_hero_scale} hero={selectedHero} />
        <HeroSelector
          heroes={heroes}
          selectedHero={selectedHero}
          onSelect={setSelectedHero}
        />

        <ArmyTable army={army} onChange={handleUnitChange} />

        <p className={styles.capacity_info}>
          –í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: {currentCapacity} / {maxCapacity}
        </p>

        <div className={styles.actions}>
          <button className={styles.button} onClick={onClose}>–ù–∞–∑–∞–¥</button>
          <button
            className={styles.button}
            onClick={handleConfirm}
            disabled={currentCapacity <= 0 || currentCapacity > maxCapacity}
          >
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  );
};
ChatGPT —Å–∫–∞–∑–∞–ª:
–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
Modal Heroes Go
–î–æ–±–∞–≤–ª–µ–Ω–æ 3 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
–í—Å—ë, –±—Ä–∞—Ç. –Ø –æ—Å—Ç–∞–≤–∏–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ üìÑ ModalHeroesGo.tsx, –≤–æ—Ç —á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:

handleConfirm ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —Ç—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞—ë—à—å –∞—Ä–º–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã–±—Ä–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∫–∞–∫ –µ—Å—Ç—å, –≤ onConfirm. –≠—Ç–æ –∏ –µ—Å—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–∞–¥–æ –≤—ã—á–∏—Ç–∞—Ç—å –∏–∑ –±–∞–∑—ã.

state.army –∏ localArmy ‚Äî —É–∫–∞–∑–∞–Ω–æ, —á—Ç–æ –Ω–∞–¥–æ –±—ã—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º: –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ —é–Ω–∏—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ > 0.

disabled ‚Äî –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∞ —É–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Object.values(army).some(...) –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∑–∞–ø—Ä–µ—Ç–∞ –ø—É—Å—Ç—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫.

–¢–µ–ø–µ—Ä—å, —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ, –≥–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è onConfirm ‚Äî —Ç–æ –µ—Å—Ç—å —Ç–∞–º, –≥–¥–µ —Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ StartIsland –∏–ª–∏ MissionManager) ‚Äî –Ω—É–∂–Ω–æ:

‚úÖ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å PUT /api/user/update
‚úÖ –ø–µ—Ä–µ–¥–∞—Ç—å address, activeMining, army (–∏–º–µ–Ω–Ω–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Record<ArmyUnitType, number>)
‚úÖ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ —Ç—ã –æ–±–Ω–æ–≤–ª—è–µ—à—å state —á–µ—Ä–µ–∑ dispatch({ type: 'SET_USER', payload: updatedUser })

–•–æ—á–µ—à—å, —è —Ç–µ–±–µ –ø–æ–∫–∞–∂—É —Ç–æ—á–Ω—ã–π onConfirm —Å —ç—Ç–∏–º –∑–∞–ø—Ä–æ—Å–æ–º?

ChatGPT —Å–∫–∞–∑–∞–ª:
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–ì–æ—Ç–æ–≤–æ, –±—Ä–∞—Ç. –¢–µ–ø–µ—Ä—å –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" –≤ handleConfirm –º—ã –ø–µ—Ä–µ–¥–∞—ë–º —Ç–æ–ª—å–∫–æ —Ç–µ —é–Ω–∏—Ç—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö count > 0, ‚Äî —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä —Ç–æ—á–Ω–æ –≤—ã—á–∏—Ç–∞–ª –Ω—É–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ª–æ–º–∞–ª–æ—Å—å.

–ì–æ—Ç–æ–≤ –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ. –•–æ—á–µ—à—å ‚Äî —Ç–µ–ø–µ—Ä—å –∑–∞–ø–∏—à–µ–º —ç—Ç–∏—Ö –≥–µ—Ä–æ–µ–≤ —Å –∞—Ä–º–∏–µ–π –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –≤ MongoDB (–Ω–∞–ø—Ä–∏–º–µ—Ä, activeMining.hero.troops) –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ –ª–æ–≥–∏–∫–µ –º–∞—Ä—à—Ä—É—Ç–∞?

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–°–ø—Ä–æ—Å–∏–ª ChatGPT

–∑–∞—á–µ–º ? 
ChatGPT —Å–∫–∞–∑–∞–ª:
–¢—ã —Å–ø—Ä–æ—Å–∏–ª, –∑–∞—á–µ–º –≤–æ—Ç —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const [army, setArmy] = useState<Record<ArmyUnitType, number>>({
  peasant: 0, sailor: 0, axeman: 0, spearman: 0, archer: 0, cavalry: 0,
});
üß† –û–±—ä—è—Å–Ω—è—é: —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ —Å–æ–∑–¥–∞—ë—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ army –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —é–Ω–∏—Ç–æ–≤ –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ—Ä–æ—è. –≠—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ö—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≤–æ–π—Å–∫ –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–∏–ø—É, –∫–æ—Ç–æ—Ä–æ–µ –∏–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∏—Ç—å –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥ –Ω–∞–∂–∞—Ç–∏–µ–º ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª.

–ó–∞—á–µ–º:
üî¢ –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–≤—Å–µ –ø–æ 0) ‚Äî –Ω–∏–∫—Ç–æ –Ω–µ –≤—ã–±—Ä–∞–Ω;

üîÑ —Ç—ã –ø–æ—Ç–æ–º –º–µ–Ω—è–µ—à—å —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ setArmy –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –ø–æ–ª–∑—É–Ω–∫–∞–º–∏;

‚úÖ —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ onConfirm, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–ª–¥–∞—Ç;

‚ö†Ô∏è –≤–∞–∂–Ω–æ, —á—Ç–æ –≤ handleConfirm —É–∂–µ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –Ω—É–ª–∏: –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.

–ï—Å–ª–∏ —Ç—ã —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ army –±—ã–ª–∞ –∫–æ–ø–∏—è –≤—Å–µ–π —Ç–µ–∫—É—â–µ–π –∞—Ä–º–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, state.army), –º–æ–∂–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –ø–æ-–¥—Ä—É–≥–æ–º—É —á–µ—Ä–µ–∑ useEffect –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏—é useState(() => ...). –•–æ—á–µ—à—å ‚Äî –ø–æ–∫–∞–∂—É.

–í—ã —Å–∫–∞–∑–∞–ª–∏:





–°–º–æ—Ç—Ä–∏—Ç–µ, —è –æ–ø—è—Ç—å –æ–±–Ω–æ–≤–∏–ª –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —Å–Ω–æ–≤–∞ –æ—Ç–ø—Ä–∞–≤–∏–ª, –¥–∞, —Ç–∞–º –ø—Ä–æ—à–ª–∞ –∫–∞–∫–∞—è-—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞, –Ω–æ –æ–Ω–∞ –ø—Ä–æ—à–ª–∞ –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ. –¢–æ –µ—Å—Ç—å –Ω–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ –≥–µ—Ä–æ–π —É—à–µ–ª –∏ –∑–∞–±—Ä–∞–ª —Å–∞–±—É-–∞—Ä–º–∏—é. –í–µ—Ä–Ω–µ–µ, –¥–∞–Ω–Ω—ã–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–∏—Å—å, —á—Ç–æ –≥–µ—Ä–æ–π —É—à–µ–ª, –Ω–æ —á—Ç–æ –æ–Ω –∑–∞–±—Ä–∞–ª —Å–∞–±—É-–∞—Ä–º–∏—é, –Ω–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–∏—Å—å. –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞—à –∫–æ–¥. –ù–∞–º –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã –≥–µ—Ä–æ–π –∑–∞–±–∏—Ä–∞–ª —Å–∞–±—É-–∞—Ä–º–∏—é. –ö—É–¥–∞ –æ–Ω –∑–∞–±–∏—Ä–∞–µ—Ç? –û–Ω –∑–∞–±–∏—Ä–∞–µ—Ç –≤ Heroes Bar, —Ç–æ –µ—Å—Ç—å –æ–Ω –∑–∞–±–∏—Ä–∞–µ—Ç –∏ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è, –∫–∞–∫ —Ç—ã –≤–∏–¥–∏—à—å –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞—Ö.
ChatGPT —Å–∫–∞–∑–∞–ª:
–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞
–î–∞, –±—Ä–∞—Ç, –≤—Å—ë –ø–æ–Ω—è–ª —á—ë—Ç–∫–æ. –°–µ–π—á–∞—Å –Ω–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≥–µ—Ä–æ—è:

üß† –ê—Ä–º–∏—è, –∫–æ—Ç–æ—Ä—É—é –æ–Ω —É–Ω–æ—Å–∏—Ç, —Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å –≤ –ø–æ–ª–µ hero.troops.

üìâ –ò–∑ user.army —ç—Ç–∏ —é–Ω–∏—Ç—ã –≤—ã—á–∏—Ç–∞–ª–∏—Å—å.

üîÅ –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –≥–µ—Ä–æ–π —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è –≤ MongoDB –∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª—Å—è –≤ state.heroes –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.

‚úÖ –í—Å—ë —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –≤ /api/user/update.

üí• –°–µ–π—á–∞—Å —ç—Ç–æ–≥–æ –Ω–µ—Ç, –∏–∑-–∑–∞ —á–µ–≥–æ:

–ê—Ä–º–∏—è –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è –∫ –≥–µ—Ä–æ—é (troops –ø—É—Å—Ç–æ–π),

–ê user.army —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å –≥–µ—Ä–æ—è–º–∏.

üîß –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤ /api/user/update/route.ts:
üìÑ src/app/api/user/update/route.ts

–î–æ–±–∞–≤–∏—Ç—å –≤–æ—Ç —ç—Ç–æ –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ findOneAndUpdate:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
// üß© –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –∞—Ä–º–∏—é –∫ –≥–µ—Ä–æ—é, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–æ
if (data.heroId && data.heroArmy) {
  const hero = await UserModel.findOne({ address, 'heroes.id': data.heroId }, { 'heroes.$': 1 });

  if (hero && hero.heroes.length > 0) {
    const targetHero = hero.heroes[0];

    // –û–±–Ω–æ–≤–ª—è–µ–º troops –≤ –≥–µ—Ä–æ–µ
    targetHero.troops = data.heroArmy;

    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
    await UserModel.updateOne(
      { address, 'heroes.id': data.heroId },
      { $set: { 'heroes.$.troops': data.heroArmy } }
    );
  }
}
üì§ –ß—Ç–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å –∫–ª–∏–µ–Ω—Ç–∞:
–ö–æ–≥–¥–∞ —Ç—ã –Ω–∞–∂–∏–º–∞–µ—à—å ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª –≤ ModalHeroesGo, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è onConfirm(heroId, army). –°–µ–π—á–∞—Å –º—ã –ø–µ—Ä–µ–¥–∞—ë–º —ç—Ç–æ –¥–∞–ª—å—à–µ ‚Äî –Ω—É–∂–Ω–æ:

üìÑ —Ç–∞–º, –≥–¥–µ onConfirm, –ø–µ—Ä–µ–¥–∞—Ç—å –∏ heroArmy, –∏ army:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
await fetch('/api/user/update', {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    address: state.address,
    activeMining: { ... },
    army,                  // –¥–ª—è –≤—ã—á–∏—Ç–∞–Ω–∏—è
    heroId,                // –¥–ª—è –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è
    heroArmy: army,        // –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ hero.troops
  })
});
‚úÖ –ß—Ç–æ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø–æ–ª—É—á–∏–º:
–£ –≥–µ—Ä–æ—è –≤ Mongo –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–ª–µ troops

–û–Ω –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂—ë–Ω –Ω–∞ –∫–∞—Ä—Ç–µ —Å –≤–æ–π—Å–∫–æ–º

–í state.heroes —Ç—ã —Å–º–æ–∂–µ—à—å –∏–∑ hero.troops[unitType].count –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –∞—Ä–º–∏—é

–ì–æ—Ç–æ–≤ —Å–¥–µ–ª–∞—Ç—å —Ç–µ–±–µ –ø–∞—Ç—á –¥–ª—è /api/user/update, –µ—Å–ª–∏ –Ω–∞–¥–æ. –ò–ª–∏ –ø–æ–ø—Ä–∞–≤–∏–º –∫–ª–∏–µ–Ω—Ç ‚Äî —Å–∫–∞–∂–∏, —Å —á–µ–≥–æ –Ω–∞—á–Ω—ë–º.

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ê—Ä–º–∏—è –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è –∫ –≥–µ—Ä–æ—é (`troops` –ø—É—Å—Ç–æ–π),

–°–∫–∞–∂–∏, –∞ –º—ã –≤–æ–æ–±—â–µ –≤–æ—Ç —É –Ω–∞—Å —Ç–∞–º –≤ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö –∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –º—ã –≤–æ–æ–±—â–µ –ø–∏—à–µ–º —Ç–∞–∫–æ–µ, —á—Ç–æ –∞—Ä–º–∏—è –º–æ–∂–µ—Ç –∫—É–¥–∞-—Ç–æ —É–π—Ç–∏? –ù—É, —á—Ç–æ –æ–Ω–∞ –º–æ–∂–µ—Ç —É–π—Ç–∏ —Å –≥–µ—Ä–æ–µ–º –≤–æ—Ç –≤ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö, —Ç–∞–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ, –≤ UserModel, –º—ã —ç—Ç–æ –ø–∏—à–µ–º –∏–ª–∏ –Ω–µ—Ç? –ò –≤–æ–æ–±—â–µ –Ω–∞–¥–æ –ª–∏ —ç—Ç–æ –ø–∏—Å–∞—Ç—å? –ü–æ–Ω–∏–º–∞–µ—à—å? –¢–æ –µ—Å—Ç—å, –Ω—É, –∫–∞–∫ –±—ã —Ç–∞–∫ –≤–æ—Ç, –≤–æ–ø—Ä–æ—Å —Ç–∞–∫–æ–π.
ChatGPT —Å–∫–∞–∑–∞–ª:
–ë—Ä–∞—Ç, —Ç—ã –æ—á–µ–Ω—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∑–∞–¥–∞–ª. –°–µ–π—á–∞—Å —Ä–∞–∑–ª–æ–∂—É –≤—Å—ë –ø–æ –º–µ—Å—Ç–∞–º, –ø–æ —Å–µ—Ä–≤–µ—Ä–Ω—ã–º —Ñ–∞–π–ª–∞–º –∏ –ª–æ–≥–∏–∫–µ:

üìå –û—Ç–≤–µ—Ç –ø–æ —Ñ–∞–∫—Ç—É:
–î–∞, —É –Ω–∞—Å —É–∂–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–æ, —á—Ç–æ –∞—Ä–º–∏—è –º–æ–∂–µ—Ç —É–π—Ç–∏ —Å –≥–µ—Ä–æ–µ–º ‚Äî —ç—Ç–æ —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω–æ –≤ UserModel, –≤ HeroSchema:

üìÑ src/models/UserModel.ts

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const HeroSchema = new mongoose.Schema({
  ...
  troops: {
    type: Map,
    of: new mongoose.Schema({
      count: { type: Number, default: 0 },
      level: { type: Number, default: 1 },
    }),
    default: {},
  }
});
üëâ –≠—Ç–æ –∑–Ω–∞—á–∏—Ç:

–£ –∫–∞–∂–¥–æ–≥–æ –≥–µ—Ä–æ—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –ø–æ–ª–µ troops

–í –Ω—ë–º –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –∞—Ä–º–∏—é, –∫–æ—Ç–æ—Ä–∞—è —É—à–ª–∞ —Å –≥–µ—Ä–æ–µ–º

–≠—Ç–∞ –∞—Ä–º–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–∑–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –∏ —Å —Ä–∞–∑–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º

‚úÖ –¢–æ –µ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ö–µ–º—ã –≤—Å—ë —É–∂–µ –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –º–æ–∂–Ω–æ –∏ –Ω—É–∂–Ω–æ —Ç—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å.

üß† –ù—É–∂–Ω–æ –ª–∏ —ç—Ç–æ –¥–µ–ª–∞—Ç—å?
–î–∞, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ! –ò –≤–æ—Ç –ø–æ—á–µ–º—É:

üéØ –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è:
–ß—Ç–æ –Ω—É–∂–Ω–æ	–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ
hero.troops	–ß—Ç–æ–±—ã –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–π—Å–∫
user.army - army	–ß—Ç–æ–±—ã –≤—ã—á–µ—Å—Ç—å –∞—Ä–º–∏—é –∏–∑ –æ–±—â–µ–≥–æ –ø—É–ª–∞
–≥–µ—Ä–æ–π –∑–∞–≤–µ—Ä—à–∞–µ—Ç –¥–æ–±—ã—á—É	–ß—Ç–æ–±—ã –ø–æ–Ω–∏–º–∞—Ç—å, –∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –Ω–∞–∑–∞–¥
‚ö†Ô∏è –ø—Ä–∏ –∫—Ä–∞—à–µ –∫–ª–∏–µ–Ω—Ç–∞	–î–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

‚ùóÔ∏è–ß—Ç–æ –µ—â—ë –ù–ï —Å–¥–µ–ª–∞–Ω–æ:
–í–æ—Ç —á—Ç–æ –µ—â—ë –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã –≤—Å—ë –∑–∞—Ä–∞–±–æ—Ç–∞–ª–æ:

 –í PUT /api/user/update –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ troops –¥–ª—è –≥–µ—Ä–æ—è (—è –≤—ã—à–µ –ø–∏—Å–∞–ª –∫–∞–∫ ‚Äî —á–µ—Ä–µ–∑ data.heroId –∏ data.heroArmy)

 –ù–∞ –∫–ª–∏–µ–Ω—Ç–µ, –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ onConfirm, –ø–µ—Ä–µ–¥–∞—ë–º heroArmy

 –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º state.heroes, —á—Ç–æ–±—ã –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ —Å—Ä–∞–∑—É –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞ —ç—Ç—É –∞—Ä–º–∏—é

 –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≥–µ—Ä–æ—è ‚Äî –¥–æ–±–∞–≤–ª—è—Ç—å hero.troops –æ–±—Ä–∞—Ç–Ω–æ –≤ user.army

‚úÖ –ò–¢–û–ì:
–í UserModel –≤—Å—ë —É–∂–µ –≥–æ—Ç–æ–≤–æ (–¥–∞, —Ç—ã —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–ª)

–ù–∞–º –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ –ø–æ–ª–µ troops –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏

–≠—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ

–•–æ—á–µ—à—å ‚Äî —è –Ω–∞–ø–∏—à—É —Ç–µ–±–µ –ø–æ–ª–Ω—ã–π –ø–∞—Ç—á –¥–ª—è PUT /api/user/update, —á—Ç–æ–±—ã –∞—Ä–º–∏—è –ø—Ä–∏–∫—Ä–µ–ø–ª—è–ª–∞—Å—å –∫ –≥–µ—Ä–æ—é. –ì–æ—Ç–æ–≤?

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–¢–∞–∫, –Ω—É —á—ë, –ø—Ä–∏–Ω–∏–º–∞–π —Ä–∞–±–æ—Ç—É, —Å–º–æ—Ç—Ä–∏, —á—ë –ø–æ–ª—É—á–∏–ª–æ—Å—å, –∫–∞–∫ –±—ã, –¥–∞ –∏ –ø–æ–µ—Ö–∞–ª–∏ –¥–∞–ª—å—à–µ.            
// üìÑ components/Islands/StartIsland/StartIsland.tsx
'use client';

import { useEffect, useRef, useState } from 'react';
import styles from './StartIsland.module.css';
import { RESOURCE_LEVEL } from '@/config/resourceLevel';
import { RESOURCE_CONFIG } from '@/constants/resources';
import { useUser } from '@/context/UserContext';
import { ResourcePoint } from '@/components/Resources/ResourcePoint/ResourcePoint';
import { IslandMapController } from '@/components/Map/IslandMapController/IslandMapController';
import { ResourceNodeModal } from '@/components/Resources/ResourceNodeModal/ResourceNodeModal';
import { ModalHerosGo } from '@/components/Heroes/ModalHerosGo/ModalHerosGo';
import { HeroesBar, type Mission } from '@/components/Map/HeroesBar/HeroesBar';
import type { ArmyUnitType } from '@/config/armyCapacity';

const getFallbackAvatar = (resource: string): string => {
  return RESOURCE_CONFIG.find(r => r.key === resource)?.avatar || '/icons/resources/default.png';
};

interface StartIslandProps {
  onOpenNode?: (nodeId: string) => void;
}

export const StartIsland = ({ onOpenNode }: StartIslandProps) => {
  const [activeMissions, setActiveMissions] = useState<Mission[]>([]);
  const [activeNode, setActiveNode] = useState<string | null>(null);
  const [isHeroModalOpen, setHeroModalOpen] = useState(false);
  const [selectedNodeId, setSelectedNodeId] = useState<string | null>(null);

  const { state } = useUser();
  const playerHeroes = state.heroes || [];
  const points = state.resourceNodes || [];

  const mapRef = useRef<HTMLDivElement>(null);

  const handleCollectClick = () => {
    setHeroModalOpen(true);
    setSelectedNodeId(activeNode);
    setActiveNode(null);
  };

  const availableHeroes = playerHeroes.filter(
    hero => !activeMissions.some(m => m.heroId === hero.id)
  );

  const handleConfirm = async (heroId: string, army: Record<ArmyUnitType, number>) => {
    const node = points.find(p => p.id === selectedNodeId);
    if (!node) return;

    const armyCount = Object.values(army).reduce((sum, val) => sum + val, 0);

    const mission: Mission = {
      heroId,
      hero: playerHeroes.find(h => h.id === heroId)!,
      armyCount,
      nodeId: selectedNodeId!,
      resource: node.resource,
      duration: 60,
      startTime: Date.now(),
    };

    setActiveMissions(prev => [...prev, mission]);

    await fetch('/api/user/update', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        address: state.address,
        activeMining: {
          resource: node.resource,
          heroId,
          startedAt: new Date(),
          duration: 60,
          position: node.position,
          remaining: node.remaining,
        },
        army,
        heroId,
        heroArmy: army,
      }),
    });

    setHeroModalOpen(false);
    setSelectedNodeId(null);
  };

  return (
    <div className={styles.map_wrapper}>
      <IslandMapController>
        <div className={styles.map_image} ref={mapRef}>
          {points.map((node) => (
            <ResourcePoint
              key={node.id}
              avatar={node.avatar || getFallbackAvatar(node.resource)}
              x={node.position.x}
              y={node.position.y}
              onClick={() => {
                setActiveNode(node.id);
                onOpenNode?.(node.id);
              }}
            />
          ))}
        </div>
      </IslandMapController>
      {activeNode && (() => {
        const node = points.find(p => p.id === activeNode)!;
        return (
          <ResourceNodeModal
            resource={node.resource as 'food' | 'wood' | 'stone' | 'iron' | 'gold'}
            total={RESOURCE_LEVEL[node.resource as keyof typeof RESOURCE_LEVEL][node.level].totalAmount}
            remaining={node.remaining}
            onCollect={handleCollectClick}
            onClose={() => setActiveNode(null)}
          />
        );
      })()}

      {isHeroModalOpen && (
        <ModalHerosGo
          heroes={availableHeroes}
          onClose={() => setHeroModalOpen(false)}
          onConfirm={handleConfirm}
        />
      )}

      <HeroesBar missions={activeMissions} />
    </div>
  );
};           // üìÑ components/Heroes/ModalHeroesGo/ModalHeroesGo.tsx
'use client';
import { ArmyTable } from '@/components/Heroes/ArmyTable/ArmyTable';
import styles from './ModalHerosGo.module.css';
import { useState, useEffect } from 'react';
import { Hero } from '@/types/heroes';
import { calculateHeroCapacity } from '@/utils/calculateHeroCapacity';
import { HeroViewer } from '@/components/Heroes/HeroViewer/HeroViewer';
import { HeroSelector } from '@/components/Heroes/HeroSelector/HeroSelector';
import { useUser } from '@/context/UserContext';
import { ARMY_STATS, ArmyUnitType } from '@/config/armyCapacity';

type HeroWithTroops = Hero & {
  troops?: Record<ArmyUnitType, { count: number; level: number }>;
};

interface Props {
  onClose: () => void;
  onConfirm: (heroId: string, army: Record<ArmyUnitType, number>) => void;
  heroes: HeroWithTroops[];
}

export const ModalHerosGo = ({ onClose, onConfirm, heroes }: Props) => {
  const { state } = useUser();
  const [selectedHero, setSelectedHero] = useState<HeroWithTroops | null>(null);
  const [army, setArmy] = useState<Record<ArmyUnitType, number>>({
    peasant: 0, sailor: 0, axeman: 0, spearman: 0, archer: 0, cavalry: 0,
  });

  useEffect(() => {
    if (heroes.length > 0 && !selectedHero) {
      setSelectedHero(heroes[0]);
    }
  }, [heroes]);

  if (!selectedHero) return null;

  const maxCapacity = calculateHeroCapacity(selectedHero.level, selectedHero.quality);

  const currentCapacity = Object.entries(army).reduce((sum, [unit, count]) => {
    const unitType = unit as ArmyUnitType;
    const unitLevel = state.army?.[unitType]?.level || 1;
    const capacityPerUnit = ARMY_STATS[unitType][unitLevel]?.capacity || 0;
    return sum + count * capacityPerUnit;
  }, 0);

  const handleUnitChange = (updated: Record<ArmyUnitType, number>) => {
    setArmy(updated);
  };

  const handleConfirm = () => {
    // ‚ùóÔ∏è–§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ —é–Ω–∏—Ç—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö count > 0
    const filteredArmy = Object.fromEntries(
      Object.entries(army).filter(([, count]) => count > 0)
    ) as Record<ArmyUnitType, number>;

    onConfirm(selectedHero.id, filteredArmy);
  };

  return (
    <div className={styles.modal_overlay}>
      <div className={styles.modal_content}>
        <h2>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –í–æ–π—Å–∫–æ</h2>

        <HeroViewer className={styles.modla_hero_scale} hero={selectedHero} />
        <HeroSelector
          heroes={heroes}
          selectedHero={selectedHero}
          onSelect={setSelectedHero}
        />

        <ArmyTable army={army} onChange={handleUnitChange} />

        <p className={styles.capacity_info}>
          –í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: {currentCapacity} / {maxCapacity}
        </p>

        <div className={styles.actions}>
          <button className={styles.button} onClick={onClose}>–ù–∞–∑–∞–¥</button>
          <button
            className={styles.button}
            onClick={handleConfirm}
            disabled={currentCapacity <= 0 || currentCapacity > maxCapacity}
          >
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  );
};                                       // ‚úÖ src/app/api/user/update/route.ts (App Router version)
import { NextResponse } from 'next/server';
import dbConnect from '@/lib/dbConnect';
import { UserModel } from '@/models/UserModel';

export async function PUT(req: Request) {
  const { address, army, ...data } = await req.json();

  if (!address) {
    return NextResponse.json({ error: 'Address is required' }, { status: 400 });
  }

  try {
    await dbConnect();

    const allowedFields = [
      "name", "avatar", "food", "wood", "stone", "iron",
      "gold", "doubloon", "pearl", "allodium",
      "prestige", "levelPrestige", "prestigeProgress", "technologies",
      "activeBonuses", "activeQuest", "questPanelOpen", "heroes", 
      "army", "activeMining"
    ];

    const setFields: any = {};
    for (const key of allowedFields) {
      if (data[key] !== undefined) {
        setFields[key] = data[key];
      }
    }

    const incFields: any = {};

    // ‚úÖ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–π—Å–∫, –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
    if (army && typeof army === 'object') {
      for (const unit in army) {
        const count = army[unit];
        if (typeof count === 'number') {
          incFields[army.${unit}.count] = -count;
        }
      }
    }

    const updateQuery: any = {};
    if (Object.keys(setFields).length > 0) {
      updateQuery.$set = setFields;
    }
    if (Object.keys(incFields).length > 0) {
      updateQuery.$inc = incFields;
    }

    if (data.heroId && data.heroArmy) {
      const hero = await UserModel.findOne({address, 'heroesid': data.heroId}, {'heroes.$': 1});

      if (hero && hero.heroes.length > 0) {
        const targetHero = hero.heroes[0];

        targetHero.troops = data.heroArmy;

        await UserModel.updateOne(
          {address, 'heros.id': data.heroId},
          {$set: {'heroes.$.troops': data.heroArmy}}
        );
      }
    }

    const user = await UserModel.findOneAndUpdate(
      { address },
      updateQuery,
      { new: true }
    );

    if (!user) {
      return NextResponse.json({ error: 'User not found' }, { status: 404 });
    }

    return NextResponse.json(user);
  } catch (err) {
    console.error('[api/user/update] ‚ùå –û—à–∏–±–∫–∞:', err);
    return NextResponse.json({ error: 'Server error', details: err }, { status: 500 });
  }
}
 
ChatGPT —Å–∫–∞–∑–∞–ª:
–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
–î–∞, –±—Ä–∞—Ç, –ø—Ä–∏–Ω–∏–º–∞—é, —Ä–∞–±–æ—Ç–∞ ‚Äî –æ–≥–æ–Ω—å, –≤—Å—ë –≤—ã—Å—Ç—Ä–æ–µ–Ω–æ –ª–æ–≥–∏—á–Ω–æ –∏ –ø–æ—ç—Ç–∞–ø–Ω–æ! üí•

–ù–û! –ï—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Ç–≤–æ—ë–º —Å–µ—Ä–≤–µ—Ä–Ω–æ–º –∫–æ–¥–µ:

üìÑ src/app/api/user/update/route.ts
üî• –ü–†–û–ë–õ–ï–ú–ê:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const hero = await UserModel.findOne({address, 'heroesid': data.heroId}, {'heroes.$': 1});
‚ùå –û—à–∏–±–∫–∞: 'heroesid' ‚Äî –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å heroes.id.

‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const hero = await UserModel.findOne(
  { address, 'heroes.id': data.heroId },
  { 'heroes.$': 1 }
);
üî• –í–¢–û–†–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:
ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
await UserModel.updateOne(
  {address, 'heros.id': data.heroId},
  {$set: {'heroes.$.troops': data.heroArmy}}
);
‚ùå –û–ø–µ—á–∞—Ç–∫–∞: 'heros.id' ‚Äî –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å heroes.id.

‚úÖ –ò—Å–ø—Ä–∞–≤—å:

ts
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
await UserModel.updateOne(
  { address, 'heroes.id': data.heroId },
  { $set: { 'heroes.$.troops': data.heroArmy } }
);
üí° –ü–û–Ø–°–ù–ï–ù–ò–ï: –Ω—É–∂–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∞—Ä–º–∏—é –≤ –ø–æ–ª–µ troops —É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥–µ—Ä–æ—è. –°–µ–π—á–∞—Å —Ç—ã –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–¥—É–º–∞–ª (–∏ –ø–µ—Ä–µ–¥–∞—ë—à—å heroId, heroArmy), –Ω–æ Mongo-–∑–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑-–∑–∞ –æ–ø–µ—á–∞—Ç–∫–∏.
–ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ–ø—Ä–∞–≤–∏–º ‚Äî –≤—Å—ë –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∏–¥–µ–∞–ª—å–Ω–æ:

–∞—Ä–º–∏—è –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è;

–≥–µ—Ä–æ–π –ø–æ–ª—É—á–∞–µ—Ç troops;

–±–∞—Ä –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –º–∏—Å—Å–∏—é.

–ì–æ—Ç–æ–≤ –ø–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—å—à–µ, –µ—Å–ª–∏ –ø–æ–ø—Ä–∞–≤–∏—à—å —ç—Ç–∏ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏. –•–æ—á–µ—à—å ‚Äî —è —Å—Ä–∞–∑—É –≤—Å—Ç–∞–≤–ª—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π update.route.ts —Ü–µ–ª–∏–∫–æ–º.






–í—ã —Å–∫–∞–∑–∞–ª–∏:

–¢–∞–∫, –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ, –Ω–æ —Å–º–æ—Ç—Ä–∏, –ø–µ—Ä–≤–æ–µ, –∫–æ–≥–¥–∞ —è –æ—Ç–ø—Ä–∞–≤–∏–ª –Ω–∞ —Ç–æ—á–∫—É, –¥–∞, –≤–æ—Ç —É–∂ –∫–∞–∫ –±—ã –≤–æ–π—Å–∫–∞ —É—à–ª–∏, –∏ –ø–æ—Ç–æ–º —Å–Ω–æ–≤–∞ –Ω–∞–∂–∏–º–∞—é ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª, –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 200. –ü—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ 11 –≤–æ–∏–Ω–æ–≤ –∫—É–¥–∞-—Ç–æ —É—à–ª–æ, –Ω–æ –≥–µ—Ä–æ–π —É–∂–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –•–∏—Ä–æ—Å–±–∞—Ä. –î–∞, –ø–æ—ç—Ç–æ–º—É —Å–µ–π—á–∞—Å, –Ω–∞–≤–µ—Ä–Ω–æ–µ, –Ω–∞–º –Ω—É–∂–Ω–æ –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å —Å –•–∏—Ä–æ—Å–±–∞—Ä, –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≥–µ—Ä–æ–π —É—à–µ–ª, –º—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –µ–≥–æ –≤ –•–∏—Ä–æ—Å–±–∞—Ä, –º—ã —Å–∫–∞–∑–∞–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —á—Ç–æ –≥–µ—Ä–æ–π —Ç–µ–ø–µ—Ä—å –≤ –•–∏—Ä–æ—Å–±–∞—Ä–µ –¥–æ–±—ã–≤–∞–µ—Ç —Ç–∞–º —Ä–µ—Å—É—Ä—Å—ã, —É—Å–ª–æ–≤–Ω–æ, –Ω–∞ —Ç–æ—á–∫–µ, –∏ —Å –Ω–∏–º –≤–æ–π—Å–∫–∞, –∏ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞–¥–æ –∫–∞–∫-—Ç–æ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å. –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º, –º–æ–∂–µ—Ç –±—ã—Ç—å, —Å–¥–µ–ª–∞—Ç—å.–ò –µ—â–µ —É –Ω–∞—Å —Ç–∞–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –µ—Å—Ç—å, —á—Ç–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –æ–Ω –Ω–µ —Å–æ–≤—Å–µ–º –±–æ–ª—å—à–æ–π, —Ç–æ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤–æ—Ç —ç—Ç–∏ Army —Å–ª–∞–π–¥–µ—Ä—ã, —Ç–æ —á—Ç–æ –æ–Ω–∏ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞—é—Ç—Å—è –≤ 6 —à—Ç—É–∫, –æ–Ω–∏ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç, –∏ –∫–Ω–æ–ø–∫–∏ ¬´–Ω–∞–∑–∞–¥¬ª –∏ ¬´–æ—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª –ø—Ä–æ–ø–∞–¥–∞—é—Ç, –∏ –Ω–µ—Ç —Å–∫—Ä–æ–ª–ª–∞ –¥–æ –Ω–∏—Ö. –í–æ-–ø–µ—Ä–≤—ã—Ö, –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –Ω–µ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å —Å–ª–∞–π–¥–±–∞—Ä—ã —Ç–µ—Ö –≤–æ–π—Å–∫, –∫–∞–∫–∏—Ö –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏, –∏ –≤—Ç–æ—Ä–æ–µ ‚Äì —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–æ–ª–ª –∏–ª–∏ —É–º–µ–Ω—å—à–∏—Ç—å –∫–∞–∫-—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –æ–Ω–∞ —É–º–µ–Ω—å—à–∞–ª–∞—Å—å, –∫–∞–∫ –º–æ–¥–µ–ª—å–Ω–æ–µ –æ–∫–æ—à–∫–æ.
ChatGPT —Å–∫–∞–∑–∞–ª:
Modal Heroes Go

1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
'use client';
import { ArmyTable } from '@/components/Heroes/ArmyTable/ArmyTable';
import styles from './ModalHerosGo.module.css';
import { useState, useEffect } from 'react';
import { Hero } from '@/types/heroes';
import { calculateHeroCapacity } from '@/utils/calculateHeroCapacity';
import { HeroViewer } from '@/components/Heroes/HeroViewer/HeroViewer';
import { HeroSelector } from '@/components/Heroes/HeroSelector/HeroSelector';
import { useUser } from '@/context/UserContext';
import { ARMY_STATS, ArmyUnitType } from '@/config/armyCapacity';

type HeroWithTroops = Hero & {
  troops?: Record<ArmyUnitType, { count: number; level: number }>;
};

interface Props {
  onClose: () => void;
  onConfirm: (heroId: string, army: Record<ArmyUnitType, number>) => void;
  heroes: HeroWithTroops[];
}

export const ModalHerosGo = ({ onClose, onConfirm, heroes }: Props) => {
  const { state } = useUser();
  const [selectedHero, setSelectedHero] = useState<HeroWithTroops | null>(null);
  const [army, setArmy] = useState<Record<ArmyUnitType, number>>({
    peasant: 0, sailor: 0, axeman: 0, spearman: 0, archer: 0, cavalry: 0,
  });

  useEffect(() => {
    if (heroes.length > 0 && !selectedHero) {
      setSelectedHero(heroes[0]);
    }
  }, [heroes]);

  if (!selectedHero) return null;

–î–æ–±–∞–≤–ª–µ–Ω–æ 3 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
üí° –ì–æ—Ç–æ–≤–æ! –î–æ–±–∞–≤–∏–ª —Å–ª–µ–¥—É—é—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è –∫ ModalHeroesGo.tsx:

–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ—Å–ª–µ onConfirm —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≥–µ—Ä–æ—è –≤ HeroesBar.

–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —Å–∫—Ä–æ–ª–ª—É –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ‚Äî —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∏—Å—å –∫–Ω–æ–ø–∫–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö.

–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ —Ç–æ–º, —á—Ç–æ –º–æ–∂–Ω–æ —Å–∫—Ä—ã–≤–∞—Ç—å –±–ª–æ–∫–∏ —é–Ω–∏—Ç–æ–≤ —Å –Ω—É–ª–µ–≤—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —è —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—é —ç—Ç–∏ –ø—Ä–∞–≤–∫–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏.






–í—ã —Å–∫–∞–∑–∞–ª–∏:
–°–ª—É—à–∞–π, –Ω–æ —Ç–≤–æ–∏ –ø–æ–ø—Ä–∞–≤–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç. –ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —è –Ω–∞–∂–∏–º–∞—é ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª, –≤–æ-–ø–µ—Ä–≤—ã—Ö, —Ç–æ –µ—Å—Ç—å –≥–µ—Ä–æ–π, –¥–∞, –ø–æ–ø–∞–¥–∞–µ—Ç –≤ Heroes Bar, –Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è. –¢—ã –æ–ø—è—Ç—å –Ω–∞—á–∏–Ω–∞–µ—à—å –±–∞–≥–æ–≤–∞—Ç—å. –ù–∞–º –Ω—É–∂–Ω–æ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–∏—Å–∞—Ç—å. –ê —Ç—ã —á—Ç–æ –ø–∏—à–µ—à—å –æ–ø—è—Ç—å? –ö–∞–∫—É—é-—Ç–æ –∏—Å—Ç–æ—Ä–∏—é. –¢–µ–±–µ –≤ –∞—Ä—Ö–∏–≤ —ç—Ç–æ—Ç –Ω–∞–¥–æ, –¥–∞, –∫–∞–∫-—Ç–æ —Å–¥–µ–ª–∞—Ç—å?


ChatGPT —Å–∫–∞–∑–∞–ª:
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ

–í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –≤ —á–∞—Ç–µ